<!DOCTYPE html>

<html>
<head>
  <title>twig.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>twig.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="comment">/**
 * Twig.js 0.6.0
 *
 * @copyright 2011-2013 John Roepke
 * @license   Available under the BSD 2-Clause License
 * @link      https://github.com/justjohn/twig.js
 */</span>

<span class="keyword">var</span> Twig = (<span class="function"><span class="keyword">function</span> <span class="params">(Twig)</span> {</span>

    Twig.VERSION = <span class="string">"0.6.0"</span>;

    <span class="keyword">return</span> Twig;
})(Twig || {});</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <pre><code>Twig.js
Copyright (c) 2011-2013 John Roepke
Available under the BSD 2-Clause License
https://github.com/justjohn/twig.js</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> Twig = (<span class="function"><span class="keyword">function</span> <span class="params">(Twig)</span> {</span>
    <span class="string">"use strict"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h2 id="twig-core-js">twig.core.js</h2>
<p>This file handles template level tokenizing, compiling and parsing.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    Twig.trace = <span class="literal">false</span>;
    Twig.debug = <span class="literal">false</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Default caching to true for the improved performance it offers</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    Twig.cache = <span class="literal">true</span>;

    Twig.placeholders = {
        parent: <span class="string">"{{|PARENT|}}"</span>
    };

    <span class="comment">/**
     * Fallback for Array.indexOf for IE8 et al
     */</span>
    Twig.indexOf = <span class="function"><span class="keyword">function</span> <span class="params">(arr, searchElement <span class="comment">/*, fromIndex */</span> )</span> {</span>
        <span class="keyword">if</span> (Array.prototype.hasOwnProperty(<span class="string">"indexOf"</span>)) {
            <span class="keyword">return</span> arr.indexOf(searchElement);
        }
        <span class="keyword">if</span> (arr === <span class="keyword">void</span> <span class="number">0</span> || arr === <span class="literal">null</span>) {
            <span class="keyword">throw</span> <span class="keyword">new</span> TypeError();
        }
        <span class="keyword">var</span> t = Object(arr);
        <span class="keyword">var</span> len = t.length &gt;&gt;&gt; <span class="number">0</span>;
        <span class="keyword">if</span> (len === <span class="number">0</span>) {
            <span class="keyword">return</span> -<span class="number">1</span>;
        }
        <span class="keyword">var</span> n = <span class="number">0</span>;
        <span class="keyword">if</span> (arguments.length &gt; <span class="number">0</span>) {
            n = Number(arguments[<span class="number">1</span>]);
            <span class="keyword">if</span> (n !== n) { <span class="comment">// shortcut for verifying if it's NaN</span>
                n = <span class="number">0</span>;
            } <span class="keyword">else</span> <span class="keyword">if</span> (n !== <span class="number">0</span> &amp;&amp; n !== <span class="literal">Infinity</span> &amp;&amp; n !== -<span class="literal">Infinity</span>) {
                n = (n &gt; <span class="number">0</span> || -<span class="number">1</span>) * Math.floor(Math.abs(n));
            }
        }
        <span class="keyword">if</span> (n &gt;= len) {</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>console.log(&quot;indexOf not found1 &quot;, JSON.stringify(searchElement), JSON.stringify(arr));</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">return</span> -<span class="number">1</span>;
        }
        <span class="keyword">var</span> k = n &gt;= <span class="number">0</span> ? n : Math.max(len - Math.abs(n), <span class="number">0</span>);
        <span class="keyword">for</span> (; k &lt; len; k++) {
            <span class="keyword">if</span> (k <span class="keyword">in</span> t &amp;&amp; t[k] === searchElement) {
                <span class="keyword">return</span> k;
            }
        }
        <span class="keyword">if</span> (arr == searchElement) {
            <span class="keyword">return</span> <span class="number">0</span>;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>console.log(&quot;indexOf not found2 &quot;, JSON.stringify(searchElement), JSON.stringify(arr));</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">return</span> -<span class="number">1</span>;
    }

    Twig.forEach = <span class="function"><span class="keyword">function</span> <span class="params">(arr, callback, thisArg)</span> {</span>
        <span class="keyword">if</span> (Array.prototype.forEach ) {
            <span class="keyword">return</span> arr.forEach(callback, thisArg);
        }

        <span class="keyword">var</span> T, k;

        <span class="keyword">if</span> ( arr == <span class="literal">null</span> ) {
          <span class="keyword">throw</span> <span class="keyword">new</span> TypeError( <span class="string">" this is null or not defined"</span> );
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <ol>
<li>Let O be the result of calling ToObject passing the |this| value as the argument.</li>
</ol>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> O = Object(arr);</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <ol>
<li>Let lenValue be the result of calling the Get internal method of O with the argument &quot;length&quot;.</li>
<li>Let len be ToUint32(lenValue).</li>
</ol>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> len = O.length &gt;&gt;&gt; <span class="number">0</span>; <span class="comment">// Hack to convert O.length to a UInt32</span></pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <ol>
<li>If IsCallable(callback) is false, throw a TypeError exception.
See: <a href="http://es5.github.com/#x9.11">http://es5.github.com/#x9.11</a></li>
</ol>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> ( {}.toString.call(callback) != <span class="string">"[object Function]"</span> ) {
          <span class="keyword">throw</span> <span class="keyword">new</span> TypeError( callback + <span class="string">" is not a function"</span> );
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <ol>
<li>If thisArg was supplied, let T be thisArg; else let T be undefined.</li>
</ol>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> ( thisArg ) {
          T = thisArg;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <ol>
<li>Let k be 0</li>
</ol>

            </div>
            
            <div class="content"><div class='highlight'><pre>        k = <span class="number">0</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <ol>
<li>Repeat, while k &lt; len</li>
</ol>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">while</span>( k &lt; len ) {

          <span class="keyword">var</span> kValue;</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>a. Let Pk be ToString(k).
  This is implicit for LHS operands of the in operator
b. Let kPresent be the result of calling the HasProperty internal method of O with argument Pk.
  This step can be combined with c
c. If kPresent is true, then</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="keyword">if</span> ( k <span class="keyword">in</span> O ) {</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>i. Let kValue be the result of calling the Get internal method of O with argument Pk.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            kValue = O[ k ];</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>ii. Call the Call internal method of callback with T as the this value and
argument list containing kValue, k, and O.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            callback.call( T, kValue, k, O );
          }</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>d. Increase k by 1.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          k++;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <ol>
<li>return undefined</li>
</ol>

            </div>
            
            <div class="content"><div class='highlight'><pre>    };

    <span class="comment">/**
     * Exception thrown by twig.js.
     */</span>
    Twig.Error = <span class="function"><span class="keyword">function</span><span class="params">(message)</span> {</span>
       <span class="keyword">this</span>.message = message;
       <span class="keyword">this</span>.name = <span class="string">"TwigException"</span>;
       <span class="keyword">this</span>.type = <span class="string">"TwigException"</span>;
    };

    <span class="comment">/**
     * Get the string representation of a Twig error.
     */</span>
    Twig.Error.prototype.toString = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">var</span> output = <span class="keyword">this</span>.name + <span class="string">": "</span> + <span class="keyword">this</span>.message;

        <span class="keyword">return</span> output;
    };

    <span class="comment">/**
     * Wrapper for logging to the console.
     */</span>
    Twig.log = {
        trace: <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span><span class="keyword">if</span> (Twig.trace &amp;&amp; console) {console.log(Array.prototype.slice.call(arguments));}},
        debug: <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span><span class="keyword">if</span> (Twig.debug &amp;&amp; console) {console.log(Array.prototype.slice.call(arguments));}},
    };

    <span class="keyword">if</span> (<span class="keyword">typeof</span> console !== <span class="string">"undefined"</span> &amp;&amp; 
        <span class="keyword">typeof</span> console.log !== <span class="string">"undefined"</span>) {
        Twig.log.error = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
            console.log.apply(console, arguments);
        }
    } <span class="keyword">else</span> {
        Twig.log.error = <span class="function"><span class="keyword">function</span><span class="params">()</span>{</span>};
    }

    <span class="comment">/**
     * Container for methods related to handling high level template tokens
     *      (for example: {{ expression }}, {% logic %}, {# comment #}, raw data)
     */</span>
    Twig.token = {};

    <span class="comment">/**
     * Token types.
     */</span>
    Twig.token.type = {
        output:  <span class="string">'output'</span>,
        logic:   <span class="string">'logic'</span>,
        comment: <span class="string">'comment'</span>,
        raw:     <span class="string">'raw'</span>
    };

    <span class="comment">/**
     * Token syntax definitions.
     */</span>
    Twig.token.definitions = [
        {
            type: Twig.token.type.raw,
            open: <span class="string">'{% raw %}'</span>,
            close: <span class="string">'{% endraw %}'</span>
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p><em>Output type tokens</em></p>
<p>These typically take the form <code>{{ expression }}</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        {
            type: Twig.token.type.output,
            open: <span class="string">'{{'</span>,
            close: <span class="string">'}}'</span>
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p><em>Logic type tokens</em></p>
<p>These typically take a form like <code>{% if expression %}</code> or <code>{% endif %}</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        {
            type: Twig.token.type.logic,
            open: <span class="string">'{%'</span>,
            close: <span class="string">'%}'</span>
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p><em>Comment type tokens</em></p>
<p>These take the form <code>{# anything #}</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        {
            type: Twig.token.type.comment,
            open: <span class="string">'{#'</span>,
            close: <span class="string">'#}'</span>
        }
    ];


    <span class="comment">/**
     * What characters start "strings" in token definitions. We need this to ignore token close
     * strings inside an expression.
     */</span>
    Twig.token.strings = [<span class="string">'"'</span>, <span class="string">"'"</span>];

    Twig.token.findStart = <span class="function"><span class="keyword">function</span> <span class="params">(template)</span> {</span>
        <span class="keyword">var</span> output = {
                position: <span class="literal">null</span>,
                def: <span class="literal">null</span>
            },
            i,
            token_template,
            first_key_position;

        <span class="keyword">for</span> (i=<span class="number">0</span>;i&lt;Twig.token.definitions.length;i++) {
            token_template = Twig.token.definitions[i];
            first_key_position = template.indexOf(token_template.open);

            Twig.log.trace(<span class="string">"Twig.token.findStart: "</span>, <span class="string">"Searching for "</span>, token_template.open, <span class="string">" found at "</span>, first_key_position);</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Does this token occur before any other types?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (first_key_position &gt;= <span class="number">0</span> &amp;&amp; (output.position === <span class="literal">null</span> || first_key_position &lt; output.position)) {
                output.position = first_key_position;
                output.def = token_template;
            }
        }

        <span class="keyword">return</span> output;
    };

    Twig.token.findEnd = <span class="function"><span class="keyword">function</span> <span class="params">(template, token_def, start)</span> {</span>
        <span class="keyword">var</span> end = <span class="literal">null</span>,
            found = <span class="literal">false</span>,
            offset = <span class="number">0</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>String position variables</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            str_pos = <span class="literal">null</span>,
            str_found = <span class="literal">null</span>,
            pos = <span class="literal">null</span>,
            end_offset = <span class="literal">null</span>,
            this_str_pos = <span class="literal">null</span>,
            end_str_pos = <span class="literal">null</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>For loop variables</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            i,
            l;

        <span class="keyword">while</span> (!found) {
            str_pos = <span class="literal">null</span>;
            str_found = <span class="literal">null</span>;
            pos = template.indexOf(token_def.close, offset);

            <span class="keyword">if</span> (pos &gt;= <span class="number">0</span>) {
                end = pos;
                found = <span class="literal">true</span>;
            } <span class="keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>throw an exception</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">throw</span> <span class="keyword">new</span> Twig.Error(<span class="string">"Unable to find closing bracket '"</span> + token_def.close +
                                <span class="string">"'"</span> + <span class="string">" opened near template position "</span> + start);
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Ignore quotes within comments; just look for the next comment close sequence,
regardless of what comes before it. <a href="https://github.com/justjohn/twig.js/issues/95">https://github.com/justjohn/twig.js/issues/95</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (token_def.type === Twig.token.type.comment) {
              <span class="keyword">break</span>;
            }

            l = Twig.token.strings.length;
            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; l; i += <span class="number">1</span>) {
                this_str_pos = template.indexOf(Twig.token.strings[i], offset);

                <span class="keyword">if</span> (this_str_pos &gt; <span class="number">0</span> &amp;&amp; this_str_pos &lt; pos &amp;&amp;
                        (str_pos === <span class="literal">null</span> || this_str_pos &lt; str_pos)) {
                    str_pos = this_str_pos;
                    str_found = Twig.token.strings[i];
                }
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>We found a string before the end of the token, now find the string&#39;s end and set the search offset to it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (str_pos !== <span class="literal">null</span>) {
                end_offset = str_pos + <span class="number">1</span>;
                end = <span class="literal">null</span>;
                found = <span class="literal">false</span>;
                <span class="keyword">while</span> (<span class="literal">true</span>) {
                    end_str_pos = template.indexOf(str_found, end_offset);
                    <span class="keyword">if</span> (end_str_pos &lt; <span class="number">0</span>) {
                        <span class="keyword">throw</span> <span class="string">"Unclosed string in template"</span>;
                    }</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Ignore escaped quotes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">if</span> (template.substr(end_str_pos - <span class="number">1</span>, <span class="number">1</span>) !== <span class="string">"\\"</span>) {
                        offset = end_str_pos + <span class="number">1</span>;
                        <span class="keyword">break</span>;
                    } <span class="keyword">else</span> {
                        end_offset = end_str_pos + <span class="number">1</span>;
                    }
                }
            }
        }
        <span class="keyword">return</span> end;
    };

    <span class="comment">/**
     * Convert a template into high-level tokens.
     */</span>
    Twig.tokenize = <span class="function"><span class="keyword">function</span> <span class="params">(template)</span> {</span>
        <span class="keyword">var</span> tokens = [],</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>An offset for reporting errors locations in the template.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            error_offset = <span class="number">0</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>The start and type of the first token found in the template.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            found_token = <span class="literal">null</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>The end position of the matched token.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            end = <span class="literal">null</span>;

        <span class="keyword">while</span> (template.length &gt; <span class="number">0</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Find the first occurance of any token type in the template</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            found_token = Twig.token.findStart(template);

            Twig.log.trace(<span class="string">"Twig.tokenize: "</span>, <span class="string">"Found token: "</span>, found_token);

            <span class="keyword">if</span> (found_token.position !== <span class="literal">null</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Add a raw type token for anything before the start of the token</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">if</span> (found_token.position &gt; <span class="number">0</span>) {
                    tokens.push({
                        type: Twig.token.type.raw,
                        value: template.substring(<span class="number">0</span>, found_token.position)
                    });
                }
                template = template.substr(found_token.position + found_token.def.open.length);
                error_offset += found_token.position + found_token.def.open.length;</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>Find the end of the token</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                end = Twig.token.findEnd(template, found_token.def, error_offset);

                Twig.log.trace(<span class="string">"Twig.tokenize: "</span>, <span class="string">"Token ends at "</span>, end);

                tokens.push({
                    type:  found_token.def.type,
                    value: template.substring(<span class="number">0</span>, end).trim()
                });

                <span class="keyword">if</span> ( found_token.def.type === <span class="string">"logic"</span> &amp;&amp; template.substr( end + found_token.def.close.length, <span class="number">1</span> ) === <span class="string">"\n"</span> ) {</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>Newlines directly after logic tokens are ignored</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    end += <span class="number">1</span>;
                }

                template = template.substr(end + found_token.def.close.length);</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Increment the position in the template</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                error_offset += end + found_token.def.close.length;

            } <span class="keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>No more tokens -&gt; add the rest of the template as a raw-type token</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                tokens.push({
                    type: Twig.token.type.raw,
                    value: template
                });
                template = <span class="string">''</span>;
            }
        }

        <span class="keyword">return</span> tokens;
    };


    Twig.compile = <span class="function"><span class="keyword">function</span> <span class="params">(tokens)</span> {</span>
        <span class="keyword">try</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Output and intermediate stacks</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">var</span> output = [],
                stack = [],</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>The tokens between open and close tags</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                intermediate_output = [],

                token = <span class="literal">null</span>,
                logic_token = <span class="literal">null</span>,
                unclosed_token = <span class="literal">null</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>Temporary previous token.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                prev_token = <span class="literal">null</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>The previous token&#39;s template</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                prev_template = <span class="literal">null</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>The output token</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                tok_output = <span class="literal">null</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>Logic Token values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                type = <span class="literal">null</span>,
                open = <span class="literal">null</span>,
                next = <span class="literal">null</span>;

            <span class="keyword">while</span> (tokens.length &gt; <span class="number">0</span>) {
                token = tokens.shift();
                Twig.log.trace(<span class="string">"Compiling token "</span>, token);
                <span class="keyword">switch</span> (token.type) {
                    <span class="keyword">case</span> Twig.token.type.raw:
                        <span class="keyword">if</span> (stack.length &gt; <span class="number">0</span>) {
                            intermediate_output.push(token);
                        } <span class="keyword">else</span> {
                            output.push(token);
                        }
                        <span class="keyword">break</span>;

                    <span class="keyword">case</span> Twig.token.type.logic:</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>Compile the logic token</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        logic_token = Twig.logic.compile.apply(<span class="keyword">this</span>, [token]);

                        type = logic_token.type;
                        open = Twig.logic.handler[type].open;
                        next = Twig.logic.handler[type].next;

                        Twig.log.trace(<span class="string">"Twig.compile: "</span>, <span class="string">"Compiled logic token to "</span>, logic_token,
                                                         <span class="string">" next is: "</span>, next, <span class="string">" open is : "</span>, open);</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>Not a standalone token, check logic stack to see if this is expected</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        <span class="keyword">if</span> (open !== <span class="literal">undefined</span> &amp;&amp; !open) {
                            prev_token = stack.pop();
                            prev_template = Twig.logic.handler[prev_token.type];

                            <span class="keyword">if</span> (Twig.indexOf(prev_template.next, type) &lt; <span class="number">0</span>) {
                                <span class="keyword">throw</span> <span class="keyword">new</span> Error(type + <span class="string">" not expected after a "</span> + prev_token.type);
                            }

                            prev_token.output = prev_token.output || [];

                            prev_token.output = prev_token.output.concat(intermediate_output);
                            intermediate_output = [];

                            tok_output = {
                                type: Twig.token.type.logic,
                                token: prev_token
                            };
                            <span class="keyword">if</span> (stack.length &gt; <span class="number">0</span>) {
                                intermediate_output.push(tok_output);
                            } <span class="keyword">else</span> {
                                output.push(tok_output);
                            }
                        }</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>This token requires additional tokens to complete the logic structure.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        <span class="keyword">if</span> (next !== <span class="literal">undefined</span> &amp;&amp; next.length &gt; <span class="number">0</span>) {
                            Twig.log.trace(<span class="string">"Twig.compile: "</span>, <span class="string">"Pushing "</span>, logic_token, <span class="string">" to logic stack."</span>);

                            <span class="keyword">if</span> (stack.length &gt; <span class="number">0</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>Put any currently held output into the output list of the logic operator
currently at the head of the stack before we push a new one on.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                prev_token = stack.pop();
                                prev_token.output = prev_token.output || [];
                                prev_token.output = prev_token.output.concat(intermediate_output);
                                stack.push(prev_token);
                                intermediate_output = [];
                            }</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>Push the new logic token onto the logic stack</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            stack.push(logic_token);

                        } <span class="keyword">else</span> <span class="keyword">if</span> (open !== <span class="literal">undefined</span> &amp;&amp; open) {
                            tok_output = {
                                type: Twig.token.type.logic,
                                token: logic_token
                            };</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>Standalone token (like {% set ... %}</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            <span class="keyword">if</span> (stack.length &gt; <span class="number">0</span>) {
                                intermediate_output.push(tok_output);
                            } <span class="keyword">else</span> {
                                output.push(tok_output);
                            }
                        }
                        <span class="keyword">break</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>Do nothing, comments should be ignored</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">case</span> Twig.token.type.comment:
                        <span class="keyword">break</span>;

                    <span class="keyword">case</span> Twig.token.type.output:
                        Twig.expression.compile.apply(<span class="keyword">this</span>, [token]);
                        <span class="keyword">if</span> (stack.length &gt; <span class="number">0</span>) {
                            intermediate_output.push(token);
                        } <span class="keyword">else</span> {
                            output.push(token);
                        }
                        <span class="keyword">break</span>;
                }

                Twig.log.trace(<span class="string">"Twig.compile: "</span>, <span class="string">" Output: "</span>, output,
                                                 <span class="string">" Logic Stack: "</span>, stack,
                                                 <span class="string">" Pending Output: "</span>, intermediate_output );
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>Verify that there are no logic tokens left in the stack.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (stack.length &gt; <span class="number">0</span>) {
                unclosed_token = stack.pop();
                <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Unable to find an end tag for "</span> + unclosed_token.type +
                                <span class="string">", expecting one of "</span> + unclosed_token.next);
            }
            <span class="keyword">return</span> output;
        } <span class="keyword">catch</span> (ex) {
            Twig.log.error(<span class="string">"Error compiling twig template "</span> + <span class="keyword">this</span>.id + <span class="string">": "</span>);
            <span class="keyword">if</span> (ex.stack) {
                Twig.log.error(ex.stack);
            } <span class="keyword">else</span> {
                Twig.log.error(ex.toString());
            }

            <span class="keyword">if</span> (<span class="keyword">this</span>.options.rethrow) <span class="keyword">throw</span> ex;
        }
    };

    <span class="comment">/**
     * Parse a compiled template.
     *
     * @param {Array} tokens The compiled tokens.
     * @param {Object} context The render context.
     *
     * @return {string} The parsed template.
     */</span>
    Twig.parse = <span class="function"><span class="keyword">function</span> <span class="params">(tokens, context)</span> {</span>
        <span class="keyword">try</span> {
            <span class="keyword">var</span> output = [],</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>Track logic chains</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                chain = <span class="literal">true</span>,
                that = <span class="keyword">this</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>Default to an empty object if none provided</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            context = context || { };


            Twig.forEach(tokens, <span class="function"><span class="keyword">function</span> <span class="title">parseToken</span><span class="params">(token)</span> {</span>
                Twig.log.debug(<span class="string">"Twig.parse: "</span>, <span class="string">"Parsing token: "</span>, token);

                <span class="keyword">switch</span> (token.type) {
                    <span class="keyword">case</span> Twig.token.type.raw:
                        output.push(token.value);
                        <span class="keyword">break</span>;

                    <span class="keyword">case</span> Twig.token.type.logic:
                        <span class="keyword">var</span> logic_token = token.token,
                            logic = Twig.logic.parse.apply(that, [logic_token, context, chain]);

                        <span class="keyword">if</span> (logic.chain !== <span class="literal">undefined</span>) {
                            chain = logic.chain;
                        }
                        <span class="keyword">if</span> (logic.context !== <span class="literal">undefined</span>) {
                            context = logic.context;
                        }
                        <span class="keyword">if</span> (logic.output !== <span class="literal">undefined</span>) {
                            output.push(logic.output);
                        }
                        <span class="keyword">break</span>;

                    <span class="keyword">case</span> Twig.token.type.comment:</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>Do nothing, comments should be ignored</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        <span class="keyword">break</span>;

                    <span class="keyword">case</span> Twig.token.type.output:
                        Twig.log.debug(<span class="string">"Twig.parse: "</span>, <span class="string">"Output token: "</span>, token.stack);</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>Parse the given expression in the given context</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        output.push(Twig.expression.parse.apply(that, [token.stack, context]));
                        <span class="keyword">break</span>;
                }
            });
            <span class="keyword">return</span> output.join(<span class="string">""</span>);
        } <span class="keyword">catch</span> (ex) {
            Twig.log.error(<span class="string">"Error parsing twig template "</span> + <span class="keyword">this</span>.id + <span class="string">": "</span>);
            <span class="keyword">if</span> (ex.stack) {
                Twig.log.error(ex.stack);
            } <span class="keyword">else</span> {
                Twig.log.error(ex.toString());
            }

            <span class="keyword">if</span> (<span class="keyword">this</span>.options.rethrow) <span class="keyword">throw</span> ex;

            <span class="keyword">if</span> (Twig.debug) {
                <span class="keyword">return</span> ex.toString();
            }
        }
    };

    <span class="comment">/**
     * Tokenize and compile a string template.
     *
     * @param {string} data The template.
     *
     * @return {Array} The compiled tokens.
     */</span>
    Twig.prepare = <span class="function"><span class="keyword">function</span><span class="params">(data)</span> {</span>
        <span class="keyword">var</span> tokens, raw_tokens;</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>Tokenize</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        Twig.log.debug(<span class="string">"Twig.prepare: "</span>, <span class="string">"Tokenizing "</span>, data);
        raw_tokens = Twig.tokenize.apply(<span class="keyword">this</span>, [data]);</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>Compile</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        Twig.log.debug(<span class="string">"Twig.prepare: "</span>, <span class="string">"Compiling "</span>, raw_tokens);
        tokens = Twig.compile.apply(<span class="keyword">this</span>, [raw_tokens]);

        Twig.log.debug(<span class="string">"Twig.prepare: "</span>, <span class="string">"Compiled "</span>, tokens);

        <span class="keyword">return</span> tokens;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>Namespace for template storage and retrieval</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    Twig.Templates = {
        registry: {}
    };

    <span class="comment">/**
     * Is this id valid for a twig template?
     *
     * @param {string} id The ID to check.
     *
     * @throws {Twig.Error} If the ID is invalid or used.
     * @return {boolean} True if the ID is valid.
     */</span>
    Twig.validateId = <span class="function"><span class="keyword">function</span><span class="params">(id)</span> {</span>
        <span class="keyword">if</span> (id === <span class="string">"prototype"</span>) {
            <span class="keyword">throw</span> <span class="keyword">new</span> Twig.Error(id + <span class="string">" is not a valid twig identifier"</span>);
        } <span class="keyword">else</span> <span class="keyword">if</span> (Twig.Templates.registry.hasOwnProperty(id)) {
            <span class="keyword">throw</span> <span class="keyword">new</span> Twig.Error(<span class="string">"There is already a template with the ID "</span> + id);
        }
        <span class="keyword">return</span> <span class="literal">true</span>;
    }

    <span class="comment">/**
     * Save a template object to the store.
     *
     * @param {Twig.Template} template   The twig.js template to store.
     */</span>
    Twig.Templates.save = <span class="function"><span class="keyword">function</span><span class="params">(template)</span> {</span>
        <span class="keyword">if</span> (template.id === <span class="literal">undefined</span>) {
            <span class="keyword">throw</span> <span class="keyword">new</span> Twig.Error(<span class="string">"Unable to save template with no id"</span>);
        }
        Twig.Templates.registry[template.id] = template;
    };

    <span class="comment">/**
     * Load a previously saved template from the store.
     *
     * @param {string} id   The ID of the template to load.
     *
     * @return {Twig.Template} A twig.js template stored with the provided ID.
     */</span>
    Twig.Templates.load = <span class="function"><span class="keyword">function</span><span class="params">(id)</span> {</span>
        <span class="keyword">if</span> (!Twig.Templates.registry.hasOwnProperty(id)) {
            <span class="keyword">return</span> <span class="literal">null</span>;
        }
        <span class="keyword">return</span> Twig.Templates.registry[id];
    };

    <span class="comment">/**
     * Load a template from a remote location using AJAX and saves in with the given ID.
     *
     * Available parameters:
     *
     *      async:       Should the HTTP request be performed asynchronously.
     *                      Defaults to true.
     *      method:      What method should be used to load the template
     *                      (fs or ajax)
     *      precompiled: Has the template already been compiled.
     *
     * @param {string} location  The remote URL to load as a template.
     * @param {Object} params The template parameters.
     * @param {function} callback  A callback triggered when the template finishes loading.
     * @param {function} error_callback  A callback triggered if an error occurs loading the template.
     *
     *
     */</span>
    Twig.Templates.loadRemote = <span class="function"><span class="keyword">function</span><span class="params">(location, params, callback, error_callback)</span> {</span>
        <span class="keyword">var</span> id          = params.id,
            method      = params.method,
            async       = params.async,
            precompiled = params.precompiled,
            template    = <span class="literal">null</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>Default to async</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (async === <span class="literal">undefined</span>) async = <span class="literal">true</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>Default to the URL so the template is cached.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (id === <span class="literal">undefined</span>) {
            id = location;
        }
        params.id = id;</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>Check for existing template</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (Twig.cache &amp;&amp; Twig.Templates.registry.hasOwnProperty(id)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>A template is already saved with the given id.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (callback) {
                callback(Twig.Templates.registry[id]);
            }
            <span class="keyword">return</span> Twig.Templates.registry[id];
        }

        <span class="keyword">if</span> (method == <span class="string">'ajax'</span>) {
            <span class="keyword">if</span> (<span class="keyword">typeof</span> XMLHttpRequest == <span class="string">"undefined"</span>) {
                <span class="keyword">throw</span> <span class="keyword">new</span> Twig.Error(<span class="string">"Unsupported platform: Unable to do remote requests "</span> +
                                     <span class="string">"because there is no XMLHTTPRequest implementation"</span>);
            }

            <span class="keyword">var</span> xmlhttp = <span class="keyword">new</span> XMLHttpRequest();
            xmlhttp.onreadystatechange = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
                <span class="keyword">var</span> data = <span class="literal">null</span>;

                <span class="keyword">if</span>(xmlhttp.readyState == <span class="number">4</span>) {
                    <span class="keyword">if</span> (xmlhttp.status == <span class="number">200</span>) {
                        Twig.log.debug(<span class="string">"Got template "</span>, xmlhttp.responseText);

                        <span class="keyword">if</span> (precompiled === <span class="literal">true</span>) {
                            data = JSON.parse(xmlhttp.responseText);
                        } <span class="keyword">else</span> {
                            data = xmlhttp.responseText;
                        }

                        params.url = location;
                        params.data = data;

                        template = <span class="keyword">new</span> Twig.Template(params);

                        <span class="keyword">if</span> (callback) {
                            callback(template);
                        }
                    } <span class="keyword">else</span> {
                        <span class="keyword">if</span> (error_callback) {
                            error_callback(xmlhttp);
                        }
                    }
                }
            };
            xmlhttp.open(<span class="string">"GET"</span>, location, async);
            xmlhttp.send();

        } <span class="keyword">else</span> { <span class="comment">// if method = 'fs'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>Create local scope</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            (<span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
                <span class="keyword">var</span> fs = require(<span class="string">'fs'</span>),
                    path = require(<span class="string">'path'</span>),
                    data = <span class="literal">null</span>,
                    loadTemplateFn = <span class="function"><span class="keyword">function</span><span class="params">(err, data)</span> {</span>
                        <span class="keyword">if</span> (err) {
                            <span class="keyword">if</span> (error_callback) {
                                error_callback(err);
                            }
                            <span class="keyword">return</span>;
                        }

                        <span class="keyword">if</span> (precompiled === <span class="literal">true</span>) {
                            data = JSON.parse(data);
                        }

                        params.data = data;
                        params.path = location;</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>template is in data</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        template = <span class="keyword">new</span> Twig.Template(params);

                        <span class="keyword">if</span> (callback) {
                            callback(template);
                        }
                    };

                <span class="keyword">if</span> (async === <span class="literal">true</span>) {
                    fs.stat(location, <span class="function"><span class="keyword">function</span> <span class="params">(err, stats)</span> {</span>
                        <span class="keyword">if</span> (err || !stats.isFile())
                            <span class="keyword">throw</span> <span class="keyword">new</span> Twig.Error(<span class="string">"Unable to find template file "</span> + location);

                        fs.readFile(location, <span class="string">'utf8'</span>, loadTemplateFn);
                    });
                } <span class="keyword">else</span> {
                    <span class="keyword">if</span> (!fs.statSync(location).isFile())
                        <span class="keyword">throw</span> <span class="keyword">new</span> Twig.Error(<span class="string">"Unable to find template file "</span> + location);

                    data = fs.readFileSync(location, <span class="string">'utf8'</span>);
                    loadTemplateFn(<span class="literal">undefined</span>, data);
                }
            })();
        }
        <span class="keyword">if</span> (async === <span class="literal">false</span>) {
            <span class="keyword">return</span> template;
        } <span class="keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>placeholder for now, should eventually return a deferred object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">return</span> <span class="literal">true</span>;
        }
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>Determine object type</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="function"><span class="keyword">function</span> <span class="title">is</span><span class="params">(type, obj)</span> {</span>
        <span class="keyword">var</span> clas = Object.prototype.toString.call(obj).slice(<span class="number">8</span>, -<span class="number">1</span>);
        <span class="keyword">return</span> obj !== <span class="literal">undefined</span> &amp;&amp; obj !== <span class="literal">null</span> &amp;&amp; clas === type;
    }

    <span class="comment">/**
     * Create a new twig.js template.
     *
     * Parameters: {
     *      data:   The template, either pre-compiled tokens or a string template
     *      id:     The name of this template
     *      blocks: Any pre-existing block from a child template
     * }
     *
     * @param {Object} params The template parameters.
     */</span>
    Twig.Template = <span class="function"><span class="keyword">function</span> <span class="params">( params )</span> {</span>
        <span class="keyword">var</span> data = params.data,
            id = params.id,
            blocks = params.blocks,
            macros = params.macros || {},
            base = params.base,
            path = params.path,
            url = params.url,</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>parser options</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            options = params.options;</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <h1 id="what-is-stored-in-a-twig-template">What is stored in a Twig.Template</h1>
<p>The Twig Template hold several chucks of data.</p>
<pre><code>{
     id:     The token ID (if any)
     tokens: The list of tokens that makes up this template.
     blocks: The list of block this template contains.
     base:   The base template (if any)
       options:  {
           Compiler/parser options

           strict_variables: true/false
               Should missing variable/keys emit an error message. If false, they default to null.
       }
}</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">this</span>.id     = id;
        <span class="keyword">this</span>.base   = base;
        <span class="keyword">this</span>.path   = path;
        <span class="keyword">this</span>.url    = url;
        <span class="keyword">this</span>.macros = macros;
        <span class="keyword">this</span>.options = options;

        <span class="keyword">this</span>.reset(blocks);

        <span class="keyword">if</span> (is(<span class="string">'String'</span>, data)) {
            <span class="keyword">this</span>.tokens = Twig.prepare.apply(<span class="keyword">this</span>, [data]);
        } <span class="keyword">else</span> {
            <span class="keyword">this</span>.tokens = data;
        }

        <span class="keyword">if</span> (id !== <span class="literal">undefined</span>) {
            Twig.Templates.save(<span class="keyword">this</span>);
        }
    };

    Twig.Template.prototype.reset = <span class="function"><span class="keyword">function</span><span class="params">(blocks)</span> {</span>
        Twig.log.debug(<span class="string">"Twig.Template.reset"</span>, <span class="string">"Reseting template "</span> + <span class="keyword">this</span>.id);
        <span class="keyword">this</span>.blocks = {};
        <span class="keyword">this</span>.child = {
            blocks: blocks || {}
        };
        <span class="keyword">this</span>.extend = <span class="literal">null</span>;
    };

    Twig.Template.prototype.render = <span class="function"><span class="keyword">function</span> <span class="params">(context, params)</span> {</span>
        params = params || {};

        <span class="keyword">var</span> output,
            url;

        <span class="keyword">this</span>.context = context || {};</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>Clear any previous state</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">this</span>.reset();
        <span class="keyword">if</span> (params.blocks) {
            <span class="keyword">this</span>.blocks = params.blocks;
        }
        <span class="keyword">if</span> (params.macros) {
            <span class="keyword">this</span>.macros = params.macros;
        }

        output = Twig.parse.apply(<span class="keyword">this</span>, [<span class="keyword">this</span>.tokens, <span class="keyword">this</span>.context]);</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>Does this template extend another</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (<span class="keyword">this</span>.extend) {
            <span class="keyword">var</span> ext_template;</pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <p>check if the template is provided inline</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> ( <span class="keyword">this</span>.options.allowInlineIncludes ) {
                ext_template = Twig.Templates.load(<span class="keyword">this</span>.extend);
                <span class="keyword">if</span> ( ext_template ) {
                    ext_template.options = <span class="keyword">this</span>.options;
                }
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p>check for the template file via include</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (!ext_template) {
                url = relativePath(<span class="keyword">this</span>, <span class="keyword">this</span>.extend);

                ext_template = Twig.Templates.loadRemote(url, {
                    method: <span class="keyword">this</span>.url?<span class="string">'ajax'</span>:<span class="string">'fs'</span>,
                    base: <span class="keyword">this</span>.base,
                    async:  <span class="literal">false</span>,
                    id:     url,
                    options: <span class="keyword">this</span>.options
                });
            }

            <span class="keyword">this</span>.parent = ext_template;

            <span class="keyword">return</span> <span class="keyword">this</span>.parent.render(<span class="keyword">this</span>.context, {
                blocks: <span class="keyword">this</span>.blocks
            });
        }

        <span class="keyword">if</span> (params.output == <span class="string">'blocks'</span>) {
            <span class="keyword">return</span> <span class="keyword">this</span>.blocks;
        } <span class="keyword">else</span> <span class="keyword">if</span> (params.output == <span class="string">'macros'</span>) {
            <span class="keyword">return</span> <span class="keyword">this</span>.macros;
        } <span class="keyword">else</span> {
            <span class="keyword">return</span> output;
        }
    };

    Twig.Template.prototype.importFile = <span class="function"><span class="keyword">function</span><span class="params">(file)</span> {</span>
        <span class="keyword">var</span> url, sub_template;
        <span class="keyword">if</span> ( !<span class="keyword">this</span>.url &amp;&amp; !<span class="keyword">this</span>.path &amp;&amp; <span class="keyword">this</span>.options.allowInlineIncludes ) {
            sub_template = Twig.Templates.load(file);
            sub_template.options = <span class="keyword">this</span>.options;
            <span class="keyword">if</span> ( sub_template ) {
                <span class="keyword">return</span> sub_template;
            }

            <span class="keyword">throw</span> <span class="keyword">new</span> Twig.Error(<span class="string">"Didn't find the inline template by id"</span>);
        }

        url = relativePath(<span class="keyword">this</span>, file);</pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p>Load blocks from an external file</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        sub_template = Twig.Templates.loadRemote(url, {
            method: <span class="keyword">this</span>.url?<span class="string">'ajax'</span>:<span class="string">'fs'</span>,
            base: <span class="keyword">this</span>.base,
            async: <span class="literal">false</span>,
            options: <span class="keyword">this</span>.options,
            id: url
        });

        <span class="keyword">return</span> sub_template;
    };

    Twig.Template.prototype.importBlocks = <span class="function"><span class="keyword">function</span><span class="params">(file, override)</span> {</span>
        <span class="keyword">var</span> sub_template = <span class="keyword">this</span>.importFile(file),
            context = <span class="keyword">this</span>.context,
            that = <span class="keyword">this</span>,
            key;

        override = override || <span class="literal">false</span>;

        sub_template.render(context);</pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <p>Mixin blocks</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        Twig.forEach(Object.keys(sub_template.blocks), <span class="function"><span class="keyword">function</span><span class="params">(key)</span> {</span>
            <span class="keyword">if</span> (override || that.blocks[key] === <span class="literal">undefined</span>) {
                that.blocks[key] = sub_template.blocks[key];
            }
        });
    };

    Twig.Template.prototype.importMacros = <span class="function"><span class="keyword">function</span><span class="params">(file)</span> {</span>
        <span class="keyword">var</span> url = relativePath(<span class="keyword">this</span>, file);</pre></div></div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <p>load remote template</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> remoteTemplate = Twig.Templates.loadRemote(url, {
            method: <span class="keyword">this</span>.url?<span class="string">'ajax'</span>:<span class="string">'fs'</span>,
            async: <span class="literal">false</span>,
            id: url
        });

        <span class="keyword">return</span> remoteTemplate;
    };

    Twig.Template.prototype.compile = <span class="function"><span class="keyword">function</span><span class="params">(options)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <p>compile the template into raw JS</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">return</span> Twig.compiler.compile(<span class="keyword">this</span>, options);
    };

    <span class="comment">/**
     * Generate the relative canonical version of a url based on the given base path and file path.
     *
     * @param {string} template The Twig.Template.
     * @param {string} file The file path, relative to the base path.
     *
     * @return {string} The canonical version of the path.
     */</span>
    <span class="function"><span class="keyword">function</span> <span class="title">relativePath</span><span class="params">(template, file)</span> {</span>
        <span class="keyword">var</span> base,
            base_path,
            sep_chr = <span class="string">"/"</span>,
            new_path = [],
            val;

        <span class="keyword">if</span> (template.url) {
            <span class="keyword">if</span> (<span class="keyword">typeof</span> template.base !== <span class="string">'undefined'</span>) {
                base = template.base + ((template.base.charAt(template.base.length-<span class="number">1</span>) === <span class="string">'/'</span>) ? <span class="string">''</span> : <span class="string">'/'</span>);
            } <span class="keyword">else</span> {
                base = template.url;
            }
        } <span class="keyword">else</span> <span class="keyword">if</span> (template.path) {</pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <p>Get the system-specific path separator</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">var</span> path = require(<span class="string">"path"</span>),
                sep = path.sep || sep_chr,
                relative = <span class="keyword">new</span> RegExp(<span class="string">"^\\.{1,2}"</span> + sep.replace(<span class="string">"\\"</span>, <span class="string">"\\\\"</span>));

            <span class="keyword">if</span> (template.base !== <span class="literal">undefined</span> &amp;&amp; file.match(relative) == <span class="literal">null</span>) {
                file = file.replace(template.base, <span class="string">''</span>);
                base = template.base + sep;
            } <span class="keyword">else</span> {
                base = template.path;
            }

            base = base.replace(sep+sep, sep);
            sep_chr = sep;
        } <span class="keyword">else</span> {
            <span class="keyword">throw</span> <span class="keyword">new</span> Twig.Error(<span class="string">"Cannot extend an inline template."</span>);
        }

        base_path = base.split(sep_chr);</pre></div></div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              <p>Remove file from url</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        base_path.pop();
        base_path = base_path.concat(file.split(sep_chr));

        <span class="keyword">while</span> (base_path.length &gt; <span class="number">0</span>) {
            val = base_path.shift();
            <span class="keyword">if</span> (val == <span class="string">"."</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              <p>Ignore</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            } <span class="keyword">else</span> <span class="keyword">if</span> (val == <span class="string">".."</span> &amp;&amp; new_path.length &gt; <span class="number">0</span> &amp;&amp; new_path[new_path.length-<span class="number">1</span>] != <span class="string">".."</span>) {
                new_path.pop();
            } <span class="keyword">else</span> {
                new_path.push(val);
            }
        }

        <span class="keyword">return</span> new_path.join(sep_chr);
    }

    <span class="keyword">return</span> Twig;

}) (Twig || { });</pre></div></div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              <p>The following methods are from MDN and are available under a
<a href="http://www.opensource.org/licenses/mit-license.php">MIT License</a> or are
<a href="https://developer.mozilla.org/Project:Copyrights">Public Domain</a>.</p>
<p>See:</p>
<ul>
<li><a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Object/keys">Object.keys - MDN</a></li>
</ul>
<h2 id="twig-fills-js">twig.fills.js</h2>
<p>This file contains fills for backwards compatability.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>(<span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
    <span class="string">"use strict"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
              <p>Handle methods that don&#39;t yet exist in every browser</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">if</span> (!String.prototype.trim) {
        String.prototype.trim = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
            <span class="keyword">return</span> <span class="keyword">this</span>.replace(<span class="regexp">/^\s+|\s+$/g</span>,<span class="string">''</span>);
        }
    };

    <span class="keyword">if</span>(!Object.keys) Object.keys = <span class="function"><span class="keyword">function</span><span class="params">(o)</span>{</span>
        <span class="keyword">if</span> (o !== Object(o)) {
            <span class="keyword">throw</span> <span class="keyword">new</span> TypeError(<span class="string">'Object.keys called on non-object'</span>);
        }
        <span class="keyword">var</span> ret = [], p;
        <span class="keyword">for</span> (p <span class="keyword">in</span> o) <span class="keyword">if</span> (Object.prototype.hasOwnProperty.call(o, p)) ret.push(p);
        <span class="keyword">return</span> ret;
    }

})();</pre></div></div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
              <h2 id="twig-lib-js">twig.lib.js</h2>
<p>This file contains 3rd party libraries used within twig.</p>
<p>Copies of the licenses for the code included here can be found in the
LICENSES.md file.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> Twig = (<span class="function"><span class="keyword">function</span><span class="params">(Twig)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-82">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-82">&#182;</a>
              </div>
              <p>Namespace for libraries</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    Twig.lib = { };

    <span class="comment">/**
    sprintf() for JavaScript 0.7-beta1
    http://www.diveintojavascript.com/projects/javascript-sprintf
    **/</span>
    <span class="keyword">var</span> sprintf = (<span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
            <span class="function"><span class="keyword">function</span> <span class="title">get_type</span><span class="params">(variable)</span> {</span>
                    <span class="keyword">return</span> Object.prototype.toString.call(variable).slice(<span class="number">8</span>, -<span class="number">1</span>).toLowerCase();
            }
            <span class="function"><span class="keyword">function</span> <span class="title">str_repeat</span><span class="params">(input, multiplier)</span> {</span>
                    <span class="keyword">for</span> (<span class="keyword">var</span> output = []; multiplier &gt; <span class="number">0</span>; output[--multiplier] = input) {<span class="comment">/* do nothing */</span>}
                    <span class="keyword">return</span> output.join(<span class="string">''</span>);
            }

            <span class="keyword">var</span> str_format = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
                    <span class="keyword">if</span> (!str_format.cache.hasOwnProperty(arguments[<span class="number">0</span>])) {
                            str_format.cache[arguments[<span class="number">0</span>]] = str_format.parse(arguments[<span class="number">0</span>]);
                    }
                    <span class="keyword">return</span> str_format.format.call(<span class="literal">null</span>, str_format.cache[arguments[<span class="number">0</span>]], arguments);
            };

            str_format.format = <span class="function"><span class="keyword">function</span><span class="params">(parse_tree, argv)</span> {</span>
                    <span class="keyword">var</span> cursor = <span class="number">1</span>, tree_length = parse_tree.length, node_type = <span class="string">''</span>, arg, output = [], i, k, match, pad, pad_character, pad_length;
                    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; tree_length; i++) {
                            node_type = get_type(parse_tree[i]);
                            <span class="keyword">if</span> (node_type === <span class="string">'string'</span>) {
                                    output.push(parse_tree[i]);
                            }
                            <span class="keyword">else</span> <span class="keyword">if</span> (node_type === <span class="string">'array'</span>) {
                                    match = parse_tree[i]; <span class="comment">// convenience purposes only</span>
                                    <span class="keyword">if</span> (match[<span class="number">2</span>]) { <span class="comment">// keyword argument</span>
                                            arg = argv[cursor];
                                            <span class="keyword">for</span> (k = <span class="number">0</span>; k &lt; match[<span class="number">2</span>].length; k++) {
                                                    <span class="keyword">if</span> (!arg.hasOwnProperty(match[<span class="number">2</span>][k])) {
                                                            <span class="keyword">throw</span>(sprintf(<span class="string">'[sprintf] property "%s" does not exist'</span>, match[<span class="number">2</span>][k]));
                                                    }
                                                    arg = arg[match[<span class="number">2</span>][k]];
                                            }
                                    }
                                    <span class="keyword">else</span> <span class="keyword">if</span> (match[<span class="number">1</span>]) { <span class="comment">// positional argument (explicit)</span>
                                            arg = argv[match[<span class="number">1</span>]];
                                    }
                                    <span class="keyword">else</span> { <span class="comment">// positional argument (implicit)</span>
                                            arg = argv[cursor++];
                                    }

                                    <span class="keyword">if</span> (<span class="regexp">/[^s]/</span>.test(match[<span class="number">8</span>]) &amp;&amp; (get_type(arg) != <span class="string">'number'</span>)) {
                                            <span class="keyword">throw</span>(sprintf(<span class="string">'[sprintf] expecting number but found %s'</span>, get_type(arg)));
                                    }
                                    <span class="keyword">switch</span> (match[<span class="number">8</span>]) {
                                            <span class="keyword">case</span> <span class="string">'b'</span>: arg = arg.toString(<span class="number">2</span>); <span class="keyword">break</span>;
                                            <span class="keyword">case</span> <span class="string">'c'</span>: arg = String.fromCharCode(arg); <span class="keyword">break</span>;
                                            <span class="keyword">case</span> <span class="string">'d'</span>: arg = parseInt(arg, <span class="number">10</span>); <span class="keyword">break</span>;
                                            <span class="keyword">case</span> <span class="string">'e'</span>: arg = match[<span class="number">7</span>] ? arg.toExponential(match[<span class="number">7</span>]) : arg.toExponential(); <span class="keyword">break</span>;
                                            <span class="keyword">case</span> <span class="string">'f'</span>: arg = match[<span class="number">7</span>] ? parseFloat(arg).toFixed(match[<span class="number">7</span>]) : parseFloat(arg); <span class="keyword">break</span>;
                                            <span class="keyword">case</span> <span class="string">'o'</span>: arg = arg.toString(<span class="number">8</span>); <span class="keyword">break</span>;
                                            <span class="keyword">case</span> <span class="string">'s'</span>: arg = ((arg = String(arg)) &amp;&amp; match[<span class="number">7</span>] ? arg.substring(<span class="number">0</span>, match[<span class="number">7</span>]) : arg); <span class="keyword">break</span>;
                                            <span class="keyword">case</span> <span class="string">'u'</span>: arg = Math.abs(arg); <span class="keyword">break</span>;
                                            <span class="keyword">case</span> <span class="string">'x'</span>: arg = arg.toString(<span class="number">16</span>); <span class="keyword">break</span>;
                                            <span class="keyword">case</span> <span class="string">'X'</span>: arg = arg.toString(<span class="number">16</span>).toUpperCase(); <span class="keyword">break</span>;
                                    }
                                    arg = (<span class="regexp">/[def]/</span>.test(match[<span class="number">8</span>]) &amp;&amp; match[<span class="number">3</span>] &amp;&amp; arg &gt;= <span class="number">0</span> ? <span class="string">'+'</span>+ arg : arg);
                                    pad_character = match[<span class="number">4</span>] ? match[<span class="number">4</span>] == <span class="string">'0'</span> ? <span class="string">'0'</span> : match[<span class="number">4</span>].charAt(<span class="number">1</span>) : <span class="string">' '</span>;
                                    pad_length = match[<span class="number">6</span>] - String(arg).length;
                                    pad = match[<span class="number">6</span>] ? str_repeat(pad_character, pad_length) : <span class="string">''</span>;
                                    output.push(match[<span class="number">5</span>] ? arg + pad : pad + arg);
                            }
                    }
                    <span class="keyword">return</span> output.join(<span class="string">''</span>);
            };

            str_format.cache = {};

            str_format.parse = <span class="function"><span class="keyword">function</span><span class="params">(fmt)</span> {</span>
                    <span class="keyword">var</span> _fmt = fmt, match = [], parse_tree = [], arg_names = <span class="number">0</span>;
                    <span class="keyword">while</span> (_fmt) {
                            <span class="keyword">if</span> ((match = <span class="regexp">/^[^\x25]+/</span>.exec(_fmt)) !== <span class="literal">null</span>) {
                                    parse_tree.push(match[<span class="number">0</span>]);
                            }
                            <span class="keyword">else</span> <span class="keyword">if</span> ((match = <span class="regexp">/^\x25{2}/</span>.exec(_fmt)) !== <span class="literal">null</span>) {
                                    parse_tree.push(<span class="string">'%'</span>);
                            }
                            <span class="keyword">else</span> <span class="keyword">if</span> ((match = <span class="regexp">/^\x25(?:([1-9]\d*)\$|\(([^\)]+)\))?(\+)?(0|'[^$])?(-)?(\d+)?(?:\.(\d+))?([b-fosuxX])/</span>.exec(_fmt)) !== <span class="literal">null</span>) {
                                    <span class="keyword">if</span> (match[<span class="number">2</span>]) {
                                            arg_names |= <span class="number">1</span>;
                                            <span class="keyword">var</span> field_list = [], replacement_field = match[<span class="number">2</span>], field_match = [];
                                            <span class="keyword">if</span> ((field_match = <span class="regexp">/^([a-z_][a-z_\d]*)/i</span>.exec(replacement_field)) !== <span class="literal">null</span>) {
                                                    field_list.push(field_match[<span class="number">1</span>]);
                                                    <span class="keyword">while</span> ((replacement_field = replacement_field.substring(field_match[<span class="number">0</span>].length)) !== <span class="string">''</span>) {
                                                            <span class="keyword">if</span> ((field_match = <span class="regexp">/^\.([a-z_][a-z_\d]*)/i</span>.exec(replacement_field)) !== <span class="literal">null</span>) {
                                                                    field_list.push(field_match[<span class="number">1</span>]);
                                                            }
                                                            <span class="keyword">else</span> <span class="keyword">if</span> ((field_match = <span class="regexp">/^\[(\d+)\]/</span>.exec(replacement_field)) !== <span class="literal">null</span>) {
                                                                    field_list.push(field_match[<span class="number">1</span>]);
                                                            }
                                                            <span class="keyword">else</span> {
                                                                    <span class="keyword">throw</span>(<span class="string">'[sprintf] huh?'</span>);
                                                            }
                                                    }
                                            }
                                            <span class="keyword">else</span> {
                                                    <span class="keyword">throw</span>(<span class="string">'[sprintf] huh?'</span>);
                                            }
                                            match[<span class="number">2</span>] = field_list;
                                    }
                                    <span class="keyword">else</span> {
                                            arg_names |= <span class="number">2</span>;
                                    }
                                    <span class="keyword">if</span> (arg_names === <span class="number">3</span>) {
                                            <span class="keyword">throw</span>(<span class="string">'[sprintf] mixing positional and named placeholders is not (yet) supported'</span>);
                                    }
                                    parse_tree.push(match);
                            }
                            <span class="keyword">else</span> {
                                    <span class="keyword">throw</span>(<span class="string">'[sprintf] huh?'</span>);
                            }
                            _fmt = _fmt.substring(match[<span class="number">0</span>].length);
                    }
                    <span class="keyword">return</span> parse_tree;
            };

            <span class="keyword">return</span> str_format;
    })();

    <span class="keyword">var</span> vsprintf = <span class="function"><span class="keyword">function</span><span class="params">(fmt, argv)</span> {</span>
        argv.unshift(fmt);
        <span class="keyword">return</span> sprintf.apply(<span class="literal">null</span>, argv);
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-83">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-83">&#182;</a>
              </div>
              <p>Expose to Twig</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    Twig.lib.sprintf = sprintf;
    Twig.lib.vsprintf = vsprintf;


    <span class="comment">/**
     * jPaq - A fully customizable JavaScript/JScript library
     * http://jpaq.org/
     *
     * Copyright (c) 2011 Christopher West
     * Licensed under the MIT license.
     * http://jpaq.org/license/
     *
     * Version: 1.0.6.0000W
     * Revised: April 6, 2011
     */</span>
    ; (<span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">var</span> shortDays = <span class="string">"Sun,Mon,Tue,Wed,Thu,Fri,Sat"</span>.split(<span class="string">","</span>);
        <span class="keyword">var</span> fullDays = <span class="string">"Sunday,Monday,Tuesday,Wednesday,Thursday,Friday,Saturday"</span>.split(<span class="string">","</span>);
        <span class="keyword">var</span> shortMonths = <span class="string">"Jan,Feb,Mar,Apr,May,Jun,Jul,Aug,Sep,Oct,Nov,Dec"</span>.split(<span class="string">","</span>);
        <span class="keyword">var</span> fullMonths = <span class="string">"January,February,March,April,May,June,July,August,September,October,November,December"</span>.split(<span class="string">","</span>);
        <span class="function"><span class="keyword">function</span> <span class="title">getOrdinalFor</span><span class="params">(intNum)</span> {</span>
                <span class="keyword">return</span> (((intNum = Math.abs(intNum) % <span class="number">100</span>) % <span class="number">10</span> == <span class="number">1</span> &amp;&amp; intNum != <span class="number">11</span>) ? <span class="string">"st"</span>
                        : (intNum % <span class="number">10</span> == <span class="number">2</span> &amp;&amp; intNum != <span class="number">12</span>) ? <span class="string">"nd"</span> : (intNum % <span class="number">10</span> == <span class="number">3</span>
                        &amp;&amp; intNum != <span class="number">13</span>) ? <span class="string">"rd"</span> : <span class="string">"th"</span>);
        }
        <span class="function"><span class="keyword">function</span> <span class="title">getISO8601Year</span><span class="params">(aDate)</span> {</span>
                <span class="keyword">var</span> d = <span class="keyword">new</span> Date(aDate.getFullYear() + <span class="number">1</span>, <span class="number">0</span>, <span class="number">4</span>);
                <span class="keyword">if</span>((d - aDate) / <span class="number">86400000</span> &lt; <span class="number">7</span> &amp;&amp; (aDate.getDay() + <span class="number">6</span>) % <span class="number">7</span> &lt; (d.getDay() + <span class="number">6</span>) % <span class="number">7</span>)
                        <span class="keyword">return</span> d.getFullYear();
                <span class="keyword">if</span>(aDate.getMonth() &gt; <span class="number">0</span> || aDate.getDate() &gt;= <span class="number">4</span>)
                        <span class="keyword">return</span> aDate.getFullYear();
                <span class="keyword">return</span> aDate.getFullYear() - (((aDate.getDay() + <span class="number">6</span>) % <span class="number">7</span> - aDate.getDate() &gt; <span class="number">2</span>) ? <span class="number">1</span> : <span class="number">0</span>);
        }
        <span class="function"><span class="keyword">function</span> <span class="title">getISO8601Week</span><span class="params">(aDate)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-84">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-84">&#182;</a>
              </div>
              <p>Get a day during the first week of the year.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">var</span> d = <span class="keyword">new</span> Date(getISO8601Year(aDate), <span class="number">0</span>, <span class="number">4</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-85">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-85">&#182;</a>
              </div>
              <p>Get the first monday of the year.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                d.setDate(d.getDate() - (d.getDay() + <span class="number">6</span>) % <span class="number">7</span>);
                <span class="keyword">return</span> parseInt((aDate - d) / <span class="number">604800000</span>) + <span class="number">1</span>;
        }
        Twig.lib.formatDate = <span class="function"><span class="keyword">function</span><span class="params">(date, format)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-86">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-86">&#182;</a>
              </div>
              <p>/ <summary>
/   Gets a string for this date, formatted according to the given format
/   string.
/ </summary>
/ <param name="format" type="String">
/   The format of the output date string.  The format string works in a
/   nearly identical way to the PHP date function which is highlighted here:
/   <a href="http://php.net/manual/en/function.date.php">http://php.net/manual/en/function.date.php</a>.
/   The only difference is the fact that &quot;u&quot; signifies milliseconds
/   instead of microseconds.  The following characters are recognized in
/   the format parameter string:
/     d - Day of the month, 2 digits with leading zeros
/     D - A textual representation of a day, three letters
/     j - Day of the month without leading zeros
/     l (lowercase &#39;L&#39;) - A full textual representation of the day of the week
/     N - ISO-8601 numeric representation of the day of the week (starting from 1)
/     S - English ordinal suffix for the day of the month, 2 characters st,
/         nd, rd or th. Works well with j.
/     w - Numeric representation of the day of the week (starting from 0)
/     z - The day of the year (starting from 0)
/     W - ISO-8601 week number of year, weeks starting on Monday
/     F - A full textual representation of a month, such as January or March
/     m - Numeric representation of a month, with leading zeros
/     M - A short textual representation of a month, three letters
/     n - Numeric representation of a month, without leading zeros
/     t - Number of days in the given month
/     L - Whether it&#39;s a leap year
/     o - ISO-8601 year number. This has the same value as Y, except that if
/         the ISO week number (W) belongs to the previous or next year, that
/         year is used instead.
/     Y - A full numeric representation of a year, 4 digits
/     y - A two digit representation of a year
/     a - Lowercase Ante meridiem and Post meridiem
/     A - Uppercase Ante meridiem and Post meridiem
/     B - Swatch Internet time
/     g - 12-hour format of an hour without leading zeros
/     G - 24-hour format of an hour without leading zeros
/     h - 12-hour format of an hour with leading zeros
/     H - 24-hour format of an hour with leading zeros
/     i - Minutes with leading zeros
/     s - Seconds, with leading zeros
/     u - Milliseconds
/     U - Seconds since the Unix Epoch (January 1 1970 00:00:00 GMT)
/ </param>
/ <returns type="String">
/   Returns the string for this date, formatted according to the given
/   format string.
/ </returns>
If the format was not passed, use the default toString method.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span>(<span class="keyword">typeof</span> format !== <span class="string">"string"</span> || <span class="regexp">/^\s*$/</span>.test(format))
                    <span class="keyword">return</span> date + <span class="string">""</span>;
            <span class="keyword">var</span> jan1st = <span class="keyword">new</span> Date(date.getFullYear(), <span class="number">0</span>, <span class="number">1</span>);
            <span class="keyword">var</span> me = date;
            <span class="keyword">return</span> format.replace(<span class="regexp">/[dDjlNSwzWFmMntLoYyaABgGhHisuU]/g</span>, <span class="function"><span class="keyword">function</span><span class="params">(option)</span> {</span>
                <span class="keyword">switch</span>(option) {</pre></div></div>
            
        </li>
        
        
        <li id="section-87">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-87">&#182;</a>
              </div>
              <p>Day of the month, 2 digits with leading zeros</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">case</span> <span class="string">"d"</span>: <span class="keyword">return</span> (<span class="string">"0"</span> + me.getDate()).replace(<span class="regexp">/^.+(..)$/</span>, <span class="string">"$1"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-88">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-88">&#182;</a>
              </div>
              <p>A textual representation of a day, three letters</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">case</span> <span class="string">"D"</span>: <span class="keyword">return</span> shortDays[me.getDay()];</pre></div></div>
            
        </li>
        
        
        <li id="section-89">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-89">&#182;</a>
              </div>
              <p>Day of the month without leading zeros</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">case</span> <span class="string">"j"</span>: <span class="keyword">return</span> me.getDate();</pre></div></div>
            
        </li>
        
        
        <li id="section-90">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-90">&#182;</a>
              </div>
              <p>A full textual representation of the day of the week</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">case</span> <span class="string">"l"</span>: <span class="keyword">return</span> fullDays[me.getDay()];</pre></div></div>
            
        </li>
        
        
        <li id="section-91">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-91">&#182;</a>
              </div>
              <p>ISO-8601 numeric representation of the day of the week</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">case</span> <span class="string">"N"</span>: <span class="keyword">return</span> (me.getDay() + <span class="number">6</span>) % <span class="number">7</span> + <span class="number">1</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-92">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-92">&#182;</a>
              </div>
              <p>English ordinal suffix for the day of the month, 2 characters</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">case</span> <span class="string">"S"</span>: <span class="keyword">return</span> getOrdinalFor(me.getDate());</pre></div></div>
            
        </li>
        
        
        <li id="section-93">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-93">&#182;</a>
              </div>
              <p>Numeric representation of the day of the week</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">case</span> <span class="string">"w"</span>: <span class="keyword">return</span> me.getDay();</pre></div></div>
            
        </li>
        
        
        <li id="section-94">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-94">&#182;</a>
              </div>
              <p>The day of the year (starting from 0)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">case</span> <span class="string">"z"</span>: <span class="keyword">return</span> Math.ceil((jan1st - me) / <span class="number">86400000</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-95">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-95">&#182;</a>
              </div>
              <p>ISO-8601 week number of year, weeks starting on Monday</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">case</span> <span class="string">"W"</span>: <span class="keyword">return</span> (<span class="string">"0"</span> + getISO8601Week(me)).replace(<span class="regexp">/^.(..)$/</span>, <span class="string">"$1"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-96">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-96">&#182;</a>
              </div>
              <p>A full textual representation of a month, such as January or March</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">case</span> <span class="string">"F"</span>: <span class="keyword">return</span> fullMonths[me.getMonth()];</pre></div></div>
            
        </li>
        
        
        <li id="section-97">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-97">&#182;</a>
              </div>
              <p>Numeric representation of a month, with leading zeros</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">case</span> <span class="string">"m"</span>: <span class="keyword">return</span> (<span class="string">"0"</span> + (me.getMonth() + <span class="number">1</span>)).replace(<span class="regexp">/^.+(..)$/</span>, <span class="string">"$1"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-98">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-98">&#182;</a>
              </div>
              <p>A short textual representation of a month, three letters</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">case</span> <span class="string">"M"</span>: <span class="keyword">return</span> shortMonths[me.getMonth()];</pre></div></div>
            
        </li>
        
        
        <li id="section-99">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-99">&#182;</a>
              </div>
              <p>Numeric representation of a month, without leading zeros</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">case</span> <span class="string">"n"</span>: <span class="keyword">return</span> me.getMonth() + <span class="number">1</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-100">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-100">&#182;</a>
              </div>
              <p>Number of days in the given month</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">case</span> <span class="string">"t"</span>: <span class="keyword">return</span> <span class="keyword">new</span> Date(me.getFullYear(), me.getMonth() + <span class="number">1</span>, -<span class="number">1</span>).getDate();</pre></div></div>
            
        </li>
        
        
        <li id="section-101">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-101">&#182;</a>
              </div>
              <p>Whether it&#39;s a leap year</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">case</span> <span class="string">"L"</span>: <span class="keyword">return</span> <span class="keyword">new</span> Date(me.getFullYear(), <span class="number">1</span>, <span class="number">29</span>).getDate() == <span class="number">29</span> ? <span class="number">1</span> : <span class="number">0</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-102">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-102">&#182;</a>
              </div>
              <p>ISO-8601 year number. This has the same value as Y, except that if the
ISO week number (W) belongs to the previous or next year, that year is
used instead.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">case</span> <span class="string">"o"</span>: <span class="keyword">return</span> getISO8601Year(me);</pre></div></div>
            
        </li>
        
        
        <li id="section-103">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-103">&#182;</a>
              </div>
              <p>A full numeric representation of a year, 4 digits</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">case</span> <span class="string">"Y"</span>: <span class="keyword">return</span> me.getFullYear();</pre></div></div>
            
        </li>
        
        
        <li id="section-104">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-104">&#182;</a>
              </div>
              <p>A two digit representation of a year</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">case</span> <span class="string">"y"</span>: <span class="keyword">return</span> (me.getFullYear() + <span class="string">""</span>).replace(<span class="regexp">/^.+(..)$/</span>, <span class="string">"$1"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-105">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-105">&#182;</a>
              </div>
              <p>Lowercase Ante meridiem and Post meridiem</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">case</span> <span class="string">"a"</span>: <span class="keyword">return</span> me.getHours() &lt; <span class="number">12</span> ? <span class="string">"am"</span> : <span class="string">"pm"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-106">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-106">&#182;</a>
              </div>
              <p>Uppercase Ante meridiem and Post meridiem</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">case</span> <span class="string">"A"</span>: <span class="keyword">return</span> me.getHours() &lt; <span class="number">12</span> ? <span class="string">"AM"</span> : <span class="string">"PM"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-107">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-107">&#182;</a>
              </div>
              <p>Swatch Internet time</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">case</span> <span class="string">"B"</span>: <span class="keyword">return</span> Math.floor((((me.getUTCHours() + <span class="number">1</span>) % <span class="number">24</span>) + me.getUTCMinutes() / <span class="number">60</span> + me.getUTCSeconds() / <span class="number">3600</span>) * <span class="number">1000</span> / <span class="number">24</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-108">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-108">&#182;</a>
              </div>
              <p>12-hour format of an hour without leading zeros</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">case</span> <span class="string">"g"</span>: <span class="keyword">return</span> me.getHours() % <span class="number">12</span> != <span class="number">0</span> ? me.getHours() % <span class="number">12</span> : <span class="number">12</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-109">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-109">&#182;</a>
              </div>
              <p>24-hour format of an hour without leading zeros</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">case</span> <span class="string">"G"</span>: <span class="keyword">return</span> me.getHours();</pre></div></div>
            
        </li>
        
        
        <li id="section-110">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-110">&#182;</a>
              </div>
              <p>12-hour format of an hour with leading zeros</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">case</span> <span class="string">"h"</span>: <span class="keyword">return</span> (<span class="string">"0"</span> + (me.getHours() % <span class="number">12</span> != <span class="number">0</span> ? me.getHours() % <span class="number">12</span> : <span class="number">12</span>)).replace(<span class="regexp">/^.+(..)$/</span>, <span class="string">"$1"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-111">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-111">&#182;</a>
              </div>
              <p>24-hour format of an hour with leading zeros</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">case</span> <span class="string">"H"</span>: <span class="keyword">return</span> (<span class="string">"0"</span> + me.getHours()).replace(<span class="regexp">/^.+(..)$/</span>, <span class="string">"$1"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-112">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-112">&#182;</a>
              </div>
              <p>Minutes with leading zeros</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">case</span> <span class="string">"i"</span>: <span class="keyword">return</span> (<span class="string">"0"</span> + me.getMinutes()).replace(<span class="regexp">/^.+(..)$/</span>, <span class="string">"$1"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-113">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-113">&#182;</a>
              </div>
              <p>Seconds, with leading zeros</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">case</span> <span class="string">"s"</span>: <span class="keyword">return</span> (<span class="string">"0"</span> + me.getSeconds()).replace(<span class="regexp">/^.+(..)$/</span>, <span class="string">"$1"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-114">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-114">&#182;</a>
              </div>
              <p>Milliseconds</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">case</span> <span class="string">"u"</span>: <span class="keyword">return</span> me.getMilliseconds();</pre></div></div>
            
        </li>
        
        
        <li id="section-115">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-115">&#182;</a>
              </div>
              <p>Seconds since the Unix Epoch (January 1 1970 00:00:00 GMT)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">case</span> <span class="string">"U"</span>: <span class="keyword">return</span> me.getTime() / <span class="number">1000</span>;
                }
            });
        };
    })();

    Twig.lib.strip_tags = <span class="function"><span class="keyword">function</span><span class="params">(input, allowed)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-116">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-116">&#182;</a>
              </div>
              <p>Strips HTML and PHP tags from a string</p>
<p>version: 1109.2015
discuss at: <a href="http://phpjs.org/functions/strip_tags">http://phpjs.org/functions/strip_tags</a></p>
<ul>
<li>original by: Kevin van Zonneveld (<a href="http://kevin.vanzonneveld.net">http://kevin.vanzonneveld.net</a>)</li>
<li>improved by: Luke Godfrey</li>
<li>input by: Pul</li>
<li>bugfixed by: Kevin van Zonneveld (<a href="http://kevin.vanzonneveld.net">http://kevin.vanzonneveld.net</a>)</li>
<li>bugfixed by: Onno Marsman</li>
<li>input by: Alex</li>
<li>bugfixed by: Kevin van Zonneveld (<a href="http://kevin.vanzonneveld.net">http://kevin.vanzonneveld.net</a>)</li>
<li>input by: Marc Palau</li>
<li>improved by: Kevin van Zonneveld (<a href="http://kevin.vanzonneveld.net">http://kevin.vanzonneveld.net</a>)</li>
<li>input by: Brett Zamir (<a href="http://brett-zamir.me">http://brett-zamir.me</a>)</li>
<li>bugfixed by: Kevin van Zonneveld (<a href="http://kevin.vanzonneveld.net">http://kevin.vanzonneveld.net</a>)</li>
<li>bugfixed by: Eric Nagel</li>
<li>input by: Bobby Drake</li>
<li>bugfixed by: Kevin van Zonneveld (<a href="http://kevin.vanzonneveld.net">http://kevin.vanzonneveld.net</a>)</li>
<li>bugfixed by: Tomasz Wesolowski</li>
<li>input by: Evertjan Garretsen</li>
<li>revised by: Rafał Kukawski (<a href="http://blog.kukawski.pl/">http://blog.kukawski.pl/</a>)</li>
<li>example 1: strip_tags(&#39;<p>Kevin</p> <b>van</b> <i>Zonneveld</i>&#39;, &#39;<i><b>&#39;);</li>
<li>returns 1: &#39;Kevin <b>van</b> <i>Zonneveld</i>&#39;</li>
<li>example 2: strip_tags(&#39;<p>Kevin <img src="someimage.png" onmouseover="someFunction()">van <i>Zonneveld</i></p>&#39;, &#39;<p>&#39;);</li>
<li>returns 2: &#39;<p>Kevin van Zonneveld</p>&#39;</li>
<li>example 3: strip_tags(&quot;<a href='http://kevin.vanzonneveld.net'>Kevin van Zonneveld</a>&quot;, &quot;<a>&quot;);</li>
<li>returns 3: &#39;<a href='http://kevin.vanzonneveld.net'>Kevin van Zonneveld</a>&#39;</li>
<li>example 4: strip_tags(&#39;1 &lt; 5 5 &gt; 1&#39;);</li>
<li>returns 4: &#39;1 &lt; 5 5 &gt; 1&#39;</li>
<li>example 5: strip_tags(&#39;1 <br/> 1&#39;);</li>
<li>returns 5: &#39;1  1&#39;</li>
<li>example 6: strip_tags(&#39;1 <br/> 1&#39;, &#39;<br>&#39;);</li>
<li>returns 6: &#39;1  1&#39;</li>
<li>example 7: strip_tags(&#39;1 <br/> 1&#39;, &#39;<br><br/>&#39;);</li>
<li>returns 7: &#39;1 <br/> 1&#39;</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>        allowed = (((allowed || <span class="string">""</span>) + <span class="string">""</span>).toLowerCase().match(<span class="regexp">/&lt;[a-z][a-z0-9]*&gt;/g</span>) || []).join(<span class="string">''</span>); <span class="comment">// making sure the allowed arg is a string containing only tags in lowercase (&lt;a&gt;&lt;b&gt;&lt;c&gt;)</span>
        <span class="keyword">var</span> tags = <span class="regexp">/&lt;\/?([a-z][a-z0-9]*)\b[^&gt;]*&gt;/gi</span>,
            commentsAndPhpTags = <span class="regexp">/&lt;!--[\s\S]*?--&gt;|&lt;\?(?:php)?[\s\S]*?\?&gt;/gi</span>;
        <span class="keyword">return</span> input.replace(commentsAndPhpTags, <span class="string">''</span>).replace(tags, <span class="function"><span class="keyword">function</span> <span class="params">($0, $1)</span> {</span>
            <span class="keyword">return</span> allowed.indexOf(<span class="string">'&lt;'</span> + $<span class="number">1.</span>toLowerCase() + <span class="string">'&gt;'</span>) &gt; -<span class="number">1</span> ? $<span class="number">0</span> : <span class="string">''</span>;
        });
    }

    Twig.lib.parseISO8601Date = <span class="function"><span class="keyword">function</span> <span class="params">(s)</span>{</span></pre></div></div>
            
        </li>
        
        
        <li id="section-117">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-117">&#182;</a>
              </div>
              <p>Taken from <a href="http://n8v.enteuxis.org/2010/12/parsing-iso-8601-dates-in-javascript/">http://n8v.enteuxis.org/2010/12/parsing-iso-8601-dates-in-javascript/</a>
parenthese matches:
year month day    hours minutes seconds<br>dotmilliseconds 
tzstring plusminus hours minutes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> re = <span class="regexp">/(\d{4})-(\d\d)-(\d\d)T(\d\d):(\d\d):(\d\d)(\.\d+)?(Z|([+-])(\d\d):(\d\d))/</span>;

        <span class="keyword">var</span> d = [];
        d = s.match(re);</pre></div></div>
            
        </li>
        
        
        <li id="section-118">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-118">&#182;</a>
              </div>
              <p>&quot;2010-12-07T11:00:00.000-09:00&quot; parses to:
 [&quot;2010-12-07T11:00:00.000-09:00&quot;, &quot;2010&quot;, &quot;12&quot;, &quot;07&quot;, &quot;11&quot;,
    &quot;00&quot;, &quot;00&quot;, &quot;.000&quot;, &quot;-09:00&quot;, &quot;-&quot;, &quot;09&quot;, &quot;00&quot;]
&quot;2010-12-07T11:00:00.000Z&quot; parses to:
 [&quot;2010-12-07T11:00:00.000Z&quot;,      &quot;2010&quot;, &quot;12&quot;, &quot;07&quot;, &quot;11&quot;, 
    &quot;00&quot;, &quot;00&quot;, &quot;.000&quot;, &quot;Z&quot;, undefined, undefined, undefined]</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (! d) {
            <span class="keyword">throw</span> <span class="string">"Couldn't parse ISO 8601 date string '"</span> + s + <span class="string">"'"</span>;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-119">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-119">&#182;</a>
              </div>
              <p>parse strings, leading zeros into proper ints</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> a = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">10</span>,<span class="number">11</span>];
        <span class="keyword">for</span> (<span class="keyword">var</span> i <span class="keyword">in</span> a) {
            d[a[i]] = parseInt(d[a[i]], <span class="number">10</span>);
        }
        d[<span class="number">7</span>] = parseFloat(d[<span class="number">7</span>]);</pre></div></div>
            
        </li>
        
        
        <li id="section-120">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-120">&#182;</a>
              </div>
              <p>Date.UTC(year, month[, date[, hrs[, min[, sec[, ms]]]]])
note that month is 0-11, not 1-12
see <a href="https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date/UTC">https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Date/UTC</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> ms = Date.UTC(d[<span class="number">1</span>], d[<span class="number">2</span>] - <span class="number">1</span>, d[<span class="number">3</span>], d[<span class="number">4</span>], d[<span class="number">5</span>], d[<span class="number">6</span>]);</pre></div></div>
            
        </li>
        
        
        <li id="section-121">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-121">&#182;</a>
              </div>
              <p>if there are milliseconds, add them</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (d[<span class="number">7</span>] &gt; <span class="number">0</span>) {  
            ms += Math.round(d[<span class="number">7</span>] * <span class="number">1000</span>);
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-122">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-122">&#182;</a>
              </div>
              <p>if there&#39;s a timezone, calculate it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (d[<span class="number">8</span>] != <span class="string">"Z"</span> &amp;&amp; d[<span class="number">10</span>]) {
            <span class="keyword">var</span> offset = d[<span class="number">10</span>] * <span class="number">60</span> * <span class="number">60</span> * <span class="number">1000</span>;
            <span class="keyword">if</span> (d[<span class="number">11</span>]) {
                offset += d[<span class="number">11</span>] * <span class="number">60</span> * <span class="number">1000</span>;
            }
            <span class="keyword">if</span> (d[<span class="number">9</span>] == <span class="string">"-"</span>) {
                ms -= offset;
            }
            <span class="keyword">else</span> {
                ms += offset;
            }
        }

        <span class="keyword">return</span> <span class="keyword">new</span> Date(ms);
    };

    Twig.lib.strtotime = <span class="function"><span class="keyword">function</span> <span class="params">(str, now)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-123">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-123">&#182;</a>
              </div>
              <p><a href="http://kevin.vanzonneveld.net">http://kevin.vanzonneveld.net</a></p>
<ul>
<li>original by: Caio Ariede (<a href="http://caioariede.com">http://caioariede.com</a>)</li>
<li>improved by: Kevin van Zonneveld (<a href="http://kevin.vanzonneveld.net">http://kevin.vanzonneveld.net</a>)</li>
<li>input by: David</li>
<li>improved by: Caio Ariede (<a href="http://caioariede.com">http://caioariede.com</a>)</li>
<li>improved by: Brett Zamir (<a href="http://brett-zamir.me">http://brett-zamir.me</a>)</li>
<li>bugfixed by: Wagner B. Soares</li>
<li>bugfixed by: Artur Tchernychev
%        note 1: Examples all have a fixed timestamp to prevent tests to fail because of variable time(zones)</li>
<li>example 1: strtotime(&#39;+1 day&#39;, 1129633200);</li>
<li>returns 1: 1129719600</li>
<li>example 2: strtotime(&#39;+1 week 2 days 4 hours 2 seconds&#39;, 1129633200);</li>
<li>returns 2: 1130425202</li>
<li>example 3: strtotime(&#39;last month&#39;, 1129633200);</li>
<li>returns 3: 1127041200</li>
<li>example 4: strtotime(&#39;2009-05-04 08:30:00&#39;);</li>
<li>returns 4: 1241418600</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> i, l, match, s, parse = <span class="string">''</span>;

        str = str.replace(<span class="regexp">/\s{2,}|^\s|\s$/g</span>, <span class="string">' '</span>); <span class="comment">// unecessary spaces</span>
        str = str.replace(<span class="regexp">/[\t\r\n]/g</span>, <span class="string">''</span>); <span class="comment">// unecessary chars</span>
        <span class="keyword">if</span> (str === <span class="string">'now'</span>) {
            <span class="keyword">return</span> now === <span class="literal">null</span> || isNaN(now) ? <span class="keyword">new</span> Date().getTime() / <span class="number">1000</span> | <span class="number">0</span> : now | <span class="number">0</span>;
        } <span class="keyword">else</span> <span class="keyword">if</span> (!isNaN(parse = Date.parse(str))) {
            <span class="keyword">return</span> parse / <span class="number">1000</span> | <span class="number">0</span>;
        } <span class="keyword">else</span> <span class="keyword">if</span> (now) {
            now = <span class="keyword">new</span> Date(now * <span class="number">1000</span>); <span class="comment">// Accept PHP-style seconds</span>
        } <span class="keyword">else</span> {
            now = <span class="keyword">new</span> Date();
        }

        <span class="keyword">var</span> upperCaseStr = str;

        str = str.toLowerCase();

        <span class="keyword">var</span> __is = {
            day: {
                <span class="string">'sun'</span>: <span class="number">0</span>,
                <span class="string">'mon'</span>: <span class="number">1</span>,
                <span class="string">'tue'</span>: <span class="number">2</span>,
                <span class="string">'wed'</span>: <span class="number">3</span>,
                <span class="string">'thu'</span>: <span class="number">4</span>,
                <span class="string">'fri'</span>: <span class="number">5</span>,
                <span class="string">'sat'</span>: <span class="number">6</span>
            },
            mon: [
                <span class="string">'jan'</span>,
                <span class="string">'feb'</span>,
                <span class="string">'mar'</span>,
                <span class="string">'apr'</span>,
                <span class="string">'may'</span>,
                <span class="string">'jun'</span>,
                <span class="string">'jul'</span>,
                <span class="string">'aug'</span>,
                <span class="string">'sep'</span>,
                <span class="string">'oct'</span>,
                <span class="string">'nov'</span>,
                <span class="string">'dec'</span>
            ]
        };

        <span class="keyword">var</span> process = <span class="function"><span class="keyword">function</span> <span class="params">(m)</span> {</span>
            <span class="keyword">var</span> ago = (m[<span class="number">2</span>] &amp;&amp; m[<span class="number">2</span>] === <span class="string">'ago'</span>);
            <span class="keyword">var</span> num = (num = m[<span class="number">0</span>] === <span class="string">'last'</span> ? -<span class="number">1</span> : <span class="number">1</span>) * (ago ? -<span class="number">1</span> : <span class="number">1</span>);

            <span class="keyword">switch</span> (m[<span class="number">0</span>]) {
            <span class="keyword">case</span> <span class="string">'last'</span>:
            <span class="keyword">case</span> <span class="string">'next'</span>:
                <span class="keyword">switch</span> (m[<span class="number">1</span>].substring(<span class="number">0</span>, <span class="number">3</span>)) {
                <span class="keyword">case</span> <span class="string">'yea'</span>:
                    now.setFullYear(now.getFullYear() + num);
                    <span class="keyword">break</span>;
                <span class="keyword">case</span> <span class="string">'wee'</span>:
                    now.setDate(now.getDate() + (num * <span class="number">7</span>));
                    <span class="keyword">break</span>;
                <span class="keyword">case</span> <span class="string">'day'</span>:
                    now.setDate(now.getDate() + num);
                    <span class="keyword">break</span>;
                <span class="keyword">case</span> <span class="string">'hou'</span>:
                    now.setHours(now.getHours() + num);
                    <span class="keyword">break</span>;
                <span class="keyword">case</span> <span class="string">'min'</span>:
                    now.setMinutes(now.getMinutes() + num);
                    <span class="keyword">break</span>;
                <span class="keyword">case</span> <span class="string">'sec'</span>:
                    now.setSeconds(now.getSeconds() + num);
                    <span class="keyword">break</span>;
                <span class="keyword">case</span> <span class="string">'mon'</span>:
                    <span class="keyword">if</span> (m[<span class="number">1</span>] === <span class="string">"month"</span>) {
                        now.setMonth(now.getMonth() + num);
                        <span class="keyword">break</span>;
                    }</pre></div></div>
            
        </li>
        
        
        <li id="section-124">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-124">&#182;</a>
              </div>
              <p>fall through</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">default</span>:
                    <span class="keyword">var</span> day = __is.day[m[<span class="number">1</span>].substring(<span class="number">0</span>, <span class="number">3</span>)];
                    <span class="keyword">if</span> (<span class="keyword">typeof</span> day !== <span class="string">'undefined'</span>) {
                        <span class="keyword">var</span> diff = day - now.getDay();
                        <span class="keyword">if</span> (diff === <span class="number">0</span>) {
                            diff = <span class="number">7</span> * num;
                        } <span class="keyword">else</span> <span class="keyword">if</span> (diff &gt; <span class="number">0</span>) {
                            <span class="keyword">if</span> (m[<span class="number">0</span>] === <span class="string">'last'</span>) {
                                diff -= <span class="number">7</span>;
                            }
                        } <span class="keyword">else</span> {
                            <span class="keyword">if</span> (m[<span class="number">0</span>] === <span class="string">'next'</span>) {
                                diff += <span class="number">7</span>;
                            }
                        }
                        now.setDate(now.getDate() + diff);
                        now.setHours(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>); <span class="comment">// when jumping to a specific last/previous day of week, PHP sets the time to 00:00:00</span>
                    }
                }
                <span class="keyword">break</span>;

            <span class="keyword">default</span>:
                <span class="keyword">if</span> (<span class="regexp">/\d+/</span>.test(m[<span class="number">0</span>])) {
                    num *= parseInt(m[<span class="number">0</span>], <span class="number">10</span>);

                    <span class="keyword">switch</span> (m[<span class="number">1</span>].substring(<span class="number">0</span>, <span class="number">3</span>)) {
                    <span class="keyword">case</span> <span class="string">'yea'</span>:
                        now.setFullYear(now.getFullYear() + num);
                        <span class="keyword">break</span>;
                    <span class="keyword">case</span> <span class="string">'mon'</span>:
                        now.setMonth(now.getMonth() + num);
                        <span class="keyword">break</span>;
                    <span class="keyword">case</span> <span class="string">'wee'</span>:
                        now.setDate(now.getDate() + (num * <span class="number">7</span>));
                        <span class="keyword">break</span>;
                    <span class="keyword">case</span> <span class="string">'day'</span>:
                        now.setDate(now.getDate() + num);
                        <span class="keyword">break</span>;
                    <span class="keyword">case</span> <span class="string">'hou'</span>:
                        now.setHours(now.getHours() + num);
                        <span class="keyword">break</span>;
                    <span class="keyword">case</span> <span class="string">'min'</span>:
                        now.setMinutes(now.getMinutes() + num);
                        <span class="keyword">break</span>;
                    <span class="keyword">case</span> <span class="string">'sec'</span>:
                        now.setSeconds(now.getSeconds() + num);
                        <span class="keyword">break</span>;
                    }
                } <span class="keyword">else</span> {
                    <span class="keyword">return</span> <span class="literal">false</span>;
                }
                <span class="keyword">break</span>;
            }
            <span class="keyword">return</span> <span class="literal">true</span>;
        };

        match = str.match(<span class="regexp">/^(\d{2,4}-\d{2}-\d{2})(?:\s(\d{1,2}:\d{2}(:\d{2})?)?(?:\.(\d+))?)?$/</span>);
        <span class="keyword">if</span> (match !== <span class="literal">null</span>) {
            <span class="keyword">if</span> (!match[<span class="number">2</span>]) {
                match[<span class="number">2</span>] = <span class="string">'00:00:00'</span>;
            } <span class="keyword">else</span> <span class="keyword">if</span> (!match[<span class="number">3</span>]) {
                match[<span class="number">2</span>] += <span class="string">':00'</span>;
            }

            s = match[<span class="number">1</span>].split(<span class="regexp">/-/g</span>);

            s[<span class="number">1</span>] = __is.mon[s[<span class="number">1</span>] - <span class="number">1</span>] || s[<span class="number">1</span>];
            s[<span class="number">0</span>] = +s[<span class="number">0</span>];

            s[<span class="number">0</span>] = (s[<span class="number">0</span>] &gt;= <span class="number">0</span> &amp;&amp; s[<span class="number">0</span>] &lt;= <span class="number">69</span>) ? <span class="string">'20'</span> + (s[<span class="number">0</span>] &lt; <span class="number">10</span> ? <span class="string">'0'</span> + s[<span class="number">0</span>] : s[<span class="number">0</span>] + <span class="string">''</span>) : (s[<span class="number">0</span>] &gt;= <span class="number">70</span> &amp;&amp; s[<span class="number">0</span>] &lt;= <span class="number">99</span>) ? <span class="string">'19'</span> + s[<span class="number">0</span>] : s[<span class="number">0</span>] + <span class="string">''</span>;
            <span class="keyword">return</span> parseInt(<span class="keyword">this</span>.strtotime(s[<span class="number">2</span>] + <span class="string">' '</span> + s[<span class="number">1</span>] + <span class="string">' '</span> + s[<span class="number">0</span>] + <span class="string">' '</span> + match[<span class="number">2</span>]) + (match[<span class="number">4</span>] ? match[<span class="number">4</span>] / <span class="number">1000</span> : <span class="string">''</span>), <span class="number">10</span>);
        }

        <span class="keyword">var</span> regex = <span class="string">'([+-]?\\d+\\s'</span> + <span class="string">'(years?|months?|weeks?|days?|hours?|min|minutes?|sec|seconds?'</span> + <span class="string">'|sun\\.?|sunday|mon\\.?|monday|tue\\.?|tuesday|wed\\.?|wednesday'</span> + <span class="string">'|thu\\.?|thursday|fri\\.?|friday|sat\\.?|saturday)'</span> + <span class="string">'|(last|next)\\s'</span> + <span class="string">'(years?|months?|weeks?|days?|hours?|min|minutes?|sec|seconds?'</span> + <span class="string">'|sun\\.?|sunday|mon\\.?|monday|tue\\.?|tuesday|wed\\.?|wednesday'</span> + <span class="string">'|thu\\.?|thursday|fri\\.?|friday|sat\\.?|saturday))'</span> + <span class="string">'(\\sago)?'</span>;

        match = str.match(<span class="keyword">new</span> RegExp(regex, <span class="string">'gi'</span>)); <span class="comment">// Brett: seems should be case insensitive per docs, so added 'i'</span>
        <span class="keyword">if</span> (match === <span class="literal">null</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-125">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-125">&#182;</a>
              </div>
              <p>Try to parse ISO8601 in IE8</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">try</span> {
                num = Twig.lib.parseISO8601Date(upperCaseStr);
                <span class="keyword">if</span> (num) {
                    <span class="keyword">return</span> num / <span class="number">1000</span> | <span class="number">0</span>;
               }
            } <span class="keyword">catch</span> (err) {
                <span class="keyword">return</span> <span class="literal">false</span>;
            }
            <span class="keyword">return</span> <span class="literal">false</span>;
        }

        <span class="keyword">for</span> (i = <span class="number">0</span>, l = match.length; i &lt; l; i++) {
            <span class="keyword">if</span> (!process(match[i].split(<span class="string">' '</span>))) {
                <span class="keyword">return</span> <span class="literal">false</span>;
            }
        }

        <span class="keyword">return</span> now.getTime() / <span class="number">1000</span> | <span class="number">0</span>;
    };

    Twig.lib.is = <span class="function"><span class="keyword">function</span><span class="params">(type, obj)</span> {</span>
        <span class="keyword">var</span> clas = Object.prototype.toString.call(obj).slice(<span class="number">8</span>, -<span class="number">1</span>);
        <span class="keyword">return</span> obj !== <span class="literal">undefined</span> &amp;&amp; obj !== <span class="literal">null</span> &amp;&amp; clas === type;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-126">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-126">&#182;</a>
              </div>
              <p>shallow-copy an object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    Twig.lib.copy = <span class="function"><span class="keyword">function</span><span class="params">(src)</span> {</span>
        <span class="keyword">var</span> target = {},
            key;
        <span class="keyword">for</span> (key <span class="keyword">in</span> src)
            target[key] = src[key];

        <span class="keyword">return</span> target;
    };

    Twig.lib.replaceAll = <span class="function"><span class="keyword">function</span><span class="params">(string, search, replace)</span> {</span>
        <span class="keyword">return</span> string.split(search).join(replace);
    };

    <span class="keyword">return</span> Twig;

})(Twig || { });</pre></div></div>
            
        </li>
        
        
        <li id="section-127">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-127">&#182;</a>
              </div>
              <pre><code>Twig.js
Copyright (c) 2011-2013 John Roepke
Available under the BSD 2-Clause License
https://github.com/justjohn/twig.js</code></pre>
<h2 id="twig-logic-js">twig.logic.js</h2>
<p>This file handles tokenizing, compiling and parsing logic tokens. {% ... %}</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> Twig = (<span class="function"><span class="keyword">function</span> <span class="params">(Twig)</span> {</span>
    <span class="string">"use strict"</span>;

    <span class="comment">/**
     * Namespace for logic handling.
     */</span>
    Twig.logic = {};

    <span class="comment">/**
     * Logic token types.
     */</span>
    Twig.logic.type = {
        if_:       <span class="string">'Twig.logic.type.if'</span>,
        endif:     <span class="string">'Twig.logic.type.endif'</span>,
        for_:      <span class="string">'Twig.logic.type.for'</span>,
        endfor:    <span class="string">'Twig.logic.type.endfor'</span>,
        else_:     <span class="string">'Twig.logic.type.else'</span>,
        elseif:    <span class="string">'Twig.logic.type.elseif'</span>,
        set:       <span class="string">'Twig.logic.type.set'</span>,
        setcapture:<span class="string">'Twig.logic.type.setcapture'</span>,
        endset:    <span class="string">'Twig.logic.type.endset'</span>,
        filter:    <span class="string">'Twig.logic.type.filter'</span>,
        endfilter: <span class="string">'Twig.logic.type.endfilter'</span>,
        block:     <span class="string">'Twig.logic.type.block'</span>,
        endblock:  <span class="string">'Twig.logic.type.endblock'</span>,
        extends_:  <span class="string">'Twig.logic.type.extends'</span>,
        use:       <span class="string">'Twig.logic.type.use'</span>,
        include:   <span class="string">'Twig.logic.type.include'</span>,
        spaceless: <span class="string">'Twig.logic.type.spaceless'</span>,
        endspaceless: <span class="string">'Twig.logic.type.endspaceless'</span>,
        macro:     <span class="string">'Twig.logic.type.macro'</span>,
        endmacro:  <span class="string">'Twig.logic.type.endmacro'</span>,
        import_:   <span class="string">'Twig.logic.type.import'</span>,
        from:      <span class="string">'Twig.logic.type.from'</span>
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-128">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-128">&#182;</a>
              </div>
              <p>Regular expressions for handling logic tokens.</p>
<p>Properties:</p>
<pre><code> type:  The type of expression this matches

 regex: A regular expression that matches the format of the token

 next:  What logic tokens (if any) pop this token off the logic stack. If empty, the
        logic token is assumed to not require an end tag and isn&#39;t push onto the stack.

 open:  Does this tag open a logic expression or is it standalone. For example,
        {% endif %} cannot exist without an opening {% if ... %} tag, so open = false.</code></pre>
<p> Functions:</p>
<pre><code> compile: A function that handles compiling the token into an output token ready for
          parsing with the parse function.

 parse:   A function that parses the compiled token into output (HTML / whatever the
          template represents).</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>    Twig.logic.definitions = [
        {
            <span class="comment">/**
             * If type logic tokens.
             *
             *  Format: {% if expression %}
             */</span>
            type: Twig.logic.type.if_,
            regex: <span class="regexp">/^if\s+([^\s].+)$/</span>,
            next: [
                Twig.logic.type.else_,
                Twig.logic.type.elseif,
                Twig.logic.type.endif
            ],
            open: <span class="literal">true</span>,
            compile: <span class="function"><span class="keyword">function</span> <span class="params">(token)</span> {</span>
                <span class="keyword">var</span> expression = token.match[<span class="number">1</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-129">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-129">&#182;</a>
              </div>
              <p>Compile the expression.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                token.stack = Twig.expression.compile.apply(<span class="keyword">this</span>, [{
                    type:  Twig.expression.type.expression,
                    value: expression
                }]).stack;
                <span class="keyword">delete</span> token.match;
                <span class="keyword">return</span> token;
            },
            parse: <span class="function"><span class="keyword">function</span> <span class="params">(token, context, chain)</span> {</span>
                <span class="keyword">var</span> output = <span class="string">''</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-130">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-130">&#182;</a>
              </div>
              <p>Parse the expression</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    result = Twig.expression.parse.apply(<span class="keyword">this</span>, [token.stack, context]);</pre></div></div>
            
        </li>
        
        
        <li id="section-131">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-131">&#182;</a>
              </div>
              <p>Start a new logic chain</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                chain = <span class="literal">true</span>;

                <span class="keyword">if</span> (result) {
                    chain = <span class="literal">false</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-132">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-132">&#182;</a>
              </div>
              <p>parse if output</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    output = Twig.parse.apply(<span class="keyword">this</span>, [token.output, context]);
                }
                <span class="keyword">return</span> {
                    chain: chain,
                    output: output
                };
            }
        },
        {
            <span class="comment">/**
             * Else if type logic tokens.
             *
             *  Format: {% elseif expression %}
             */</span>
            type: Twig.logic.type.elseif,
            regex: <span class="regexp">/^elseif\s+([^\s].*)$/</span>,
            next: [
                Twig.logic.type.else_,
                Twig.logic.type.elseif,
                Twig.logic.type.endif
            ],
            open: <span class="literal">false</span>,
            compile: <span class="function"><span class="keyword">function</span> <span class="params">(token)</span> {</span>
                <span class="keyword">var</span> expression = token.match[<span class="number">1</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-133">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-133">&#182;</a>
              </div>
              <p>Compile the expression.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                token.stack = Twig.expression.compile.apply(<span class="keyword">this</span>, [{
                    type:  Twig.expression.type.expression,
                    value: expression
                }]).stack;
                <span class="keyword">delete</span> token.match;
                <span class="keyword">return</span> token;
            },
            parse: <span class="function"><span class="keyword">function</span> <span class="params">(token, context, chain)</span> {</span>
                <span class="keyword">var</span> output = <span class="string">''</span>;

                <span class="keyword">if</span> (chain &amp;&amp; Twig.expression.parse.apply(<span class="keyword">this</span>, [token.stack, context]) === <span class="literal">true</span>) {
                    chain = <span class="literal">false</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-134">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-134">&#182;</a>
              </div>
              <p>parse if output</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    output = Twig.parse.apply(<span class="keyword">this</span>, [token.output, context]);
                }

                <span class="keyword">return</span> {
                    chain: chain,
                    output: output
                };
            }
        },
        {
            <span class="comment">/**
             * Else if type logic tokens.
             *
             *  Format: {% elseif expression %}
             */</span>
            type: Twig.logic.type.else_,
            regex: <span class="regexp">/^else$/</span>,
            next: [
                Twig.logic.type.endif,
                Twig.logic.type.endfor
            ],
            open: <span class="literal">false</span>,
            parse: <span class="function"><span class="keyword">function</span> <span class="params">(token, context, chain)</span> {</span>
                <span class="keyword">var</span> output = <span class="string">''</span>;
                <span class="keyword">if</span> (chain) {
                    output = Twig.parse.apply(<span class="keyword">this</span>, [token.output, context]);
                }
                <span class="keyword">return</span> {
                    chain: chain,
                    output: output
                };
            }
        },
        {
            <span class="comment">/**
             * End if type logic tokens.
             *
             *  Format: {% endif %}
             */</span>
            type: Twig.logic.type.endif,
            regex: <span class="regexp">/^endif$/</span>,
            next: [ ],
            open: <span class="literal">false</span>
        },
        {
            <span class="comment">/**
             * For type logic tokens.
             *
             *  Format: {% for expression %}
             */</span>
            type: Twig.logic.type.for_,
            regex: <span class="regexp">/^for\s+([a-zA-Z0-9_,\s]+)\s+in\s+([^\s].*?)(?:\s+if\s+([^\s].*))?$/</span>,
            next: [
                Twig.logic.type.else_,
                Twig.logic.type.endfor
            ],
            open: <span class="literal">true</span>,
            compile: <span class="function"><span class="keyword">function</span> <span class="params">(token)</span> {</span>
                <span class="keyword">var</span> key_value = token.match[<span class="number">1</span>],
                    expression = token.match[<span class="number">2</span>],
                    conditional = token.match[<span class="number">3</span>],
                    kv_split = <span class="literal">null</span>;

                token.key_var = <span class="literal">null</span>;
                token.value_var = <span class="literal">null</span>;

                <span class="keyword">if</span> (key_value.indexOf(<span class="string">","</span>) &gt;= <span class="number">0</span>) {
                    kv_split = key_value.split(<span class="string">','</span>);
                    <span class="keyword">if</span> (kv_split.length === <span class="number">2</span>) {
                        token.key_var = kv_split[<span class="number">0</span>].trim();
                        token.value_var = kv_split[<span class="number">1</span>].trim();
                    } <span class="keyword">else</span> {
                        <span class="keyword">throw</span> <span class="keyword">new</span> Twig.Error(<span class="string">"Invalid expression in for loop: "</span> + key_value);
                    }
                } <span class="keyword">else</span> {
                    token.value_var = key_value;
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-135">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-135">&#182;</a>
              </div>
              <p>Valid expressions for a for loop
  for item     in expression
  for key,item in expression</p>
<p>Compile the expression.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                token.expression = Twig.expression.compile.apply(<span class="keyword">this</span>, [{
                    type:  Twig.expression.type.expression,
                    value: expression
                }]).stack;</pre></div></div>
            
        </li>
        
        
        <li id="section-136">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-136">&#182;</a>
              </div>
              <p>Compile the conditional (if available)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">if</span> (conditional) {
                    token.conditional = Twig.expression.compile.apply(<span class="keyword">this</span>, [{
                        type:  Twig.expression.type.expression,
                        value: conditional
                    }]).stack;
                }

                <span class="keyword">delete</span> token.match;
                <span class="keyword">return</span> token;
            },
            parse: <span class="function"><span class="keyword">function</span> <span class="params">(token, context, continue_chain)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-137">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-137">&#182;</a>
              </div>
              <p>Parse expression</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">var</span> result = Twig.expression.parse.apply(<span class="keyword">this</span>, [token.expression, context]),
                    output = [],
					len,
					index = <span class="number">0</span>,
                    keyset,
                    that = <span class="keyword">this</span>,
                    conditional = token.conditional,
                    buildLoop = <span class="function"><span class="keyword">function</span><span class="params">(index, len)</span> {</span>
                        <span class="keyword">var</span> isConditional = conditional !== <span class="literal">undefined</span>;
                        <span class="keyword">return</span> {
                            index: index+<span class="number">1</span>,
                            index0: index,
                            revindex: isConditional?<span class="literal">undefined</span>:len-index,
                            revindex0: isConditional?<span class="literal">undefined</span>:len-index-<span class="number">1</span>,
                            first: (index === <span class="number">0</span>),
                            last: isConditional?<span class="literal">undefined</span>:(index === len-<span class="number">1</span>),
                            length: isConditional?<span class="literal">undefined</span>:len,
                            parent: context
                        };
                    },
                    loop = <span class="function"><span class="keyword">function</span><span class="params">(key, value)</span> {</span>
                        <span class="keyword">var</span> inner_context = Twig.lib.copy(context);

                        inner_context[token.value_var] = value;
                        <span class="keyword">if</span> (token.key_var) {
                            inner_context[token.key_var] = key;
                        }</pre></div></div>
            
        </li>
        
        
        <li id="section-138">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-138">&#182;</a>
              </div>
              <p>Loop object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        inner_context.loop = buildLoop(index, len);

                        <span class="keyword">if</span> (conditional === <span class="literal">undefined</span> ||
                            Twig.expression.parse.apply(that, [conditional, inner_context]))
                        {
                            output.push(Twig.parse.apply(that, [token.output, inner_context]));
                            index += <span class="number">1</span>;
                        }
                    };

                <span class="keyword">if</span> (result <span class="keyword">instanceof</span> Array) {
                    len = result.length;
                    Twig.forEach(result, <span class="function"><span class="keyword">function</span> <span class="params">(value)</span> {</span>
                        <span class="keyword">var</span> key = index;

                        loop(key, value);
                    });
                } <span class="keyword">else</span> <span class="keyword">if</span> (result <span class="keyword">instanceof</span> Object) {
                    <span class="keyword">if</span> (result._keys !== <span class="literal">undefined</span>) {
                        keyset = result._keys;
                    } <span class="keyword">else</span> {
                        keyset = Object.keys(result);
                    }
					len = keyset.length;
                    Twig.forEach(keyset, <span class="function"><span class="keyword">function</span><span class="params">(key)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-139">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-139">&#182;</a>
              </div>
              <p>Ignore the _keys property, it&#39;s internal to twig.js</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        <span class="keyword">if</span> (key === <span class="string">"_keys"</span>) <span class="keyword">return</span>;

                        loop(key,  result[key]);
                    });
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-140">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-140">&#182;</a>
              </div>
              <p>Only allow else statements if no output was generated</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                continue_chain = (output.length === <span class="number">0</span>);

                <span class="keyword">return</span> {
                    chain: continue_chain,
                    output: output.join(<span class="string">""</span>)
                };
            }
        },
        {
            <span class="comment">/**
             * End if type logic tokens.
             *
             *  Format: {% endif %}
             */</span>
            type: Twig.logic.type.endfor,
            regex: <span class="regexp">/^endfor$/</span>,
            next: [ ],
            open: <span class="literal">false</span>
        },
        {
            <span class="comment">/**
             * Set type logic tokens.
             *
             *  Format: {% set key = expression %}
             */</span>
            type: Twig.logic.type.set,
            regex: <span class="regexp">/^set\s+([a-zA-Z0-9_,\s]+)\s*=\s*(.+)$/</span>,
            next: [ ],
            open: <span class="literal">true</span>,
            compile: <span class="function"><span class="keyword">function</span> <span class="params">(token)</span> {</span>
                <span class="keyword">var</span> key = token.match[<span class="number">1</span>].trim(),
                    expression = token.match[<span class="number">2</span>],</pre></div></div>
            
        </li>
        
        
        <li id="section-141">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-141">&#182;</a>
              </div>
              <p>Compile the expression.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    expression_stack  = Twig.expression.compile.apply(<span class="keyword">this</span>, [{
                        type:  Twig.expression.type.expression,
                        value: expression
                    }]).stack;

                token.key = key;
                token.expression = expression_stack;

                <span class="keyword">delete</span> token.match;
                <span class="keyword">return</span> token;
            },
            parse: <span class="function"><span class="keyword">function</span> <span class="params">(token, context, continue_chain)</span> {</span>
                <span class="keyword">var</span> value = Twig.expression.parse.apply(<span class="keyword">this</span>, [token.expression, context]),
                    key = token.key;</pre></div></div>
            
        </li>
        
        
        <li id="section-142">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-142">&#182;</a>
              </div>
              <p>set on both the global and local context</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">this</span>.context[key] = value;
                context[key] = value;

                <span class="keyword">return</span> {
                    chain: continue_chain,
                    context: context
                };
            }
        },
        {
            <span class="comment">/**
             * Set capture type logic tokens.
             *
             *  Format: {% set key %}
             */</span>
            type: Twig.logic.type.setcapture,
            regex: <span class="regexp">/^set\s+([a-zA-Z0-9_,\s]+)$/</span>,
            next: [
                Twig.logic.type.endset
            ],
            open: <span class="literal">true</span>,
            compile: <span class="function"><span class="keyword">function</span> <span class="params">(token)</span> {</span>
                <span class="keyword">var</span> key = token.match[<span class="number">1</span>].trim();

                token.key = key;

                <span class="keyword">delete</span> token.match;
                <span class="keyword">return</span> token;
            },
            parse: <span class="function"><span class="keyword">function</span> <span class="params">(token, context, continue_chain)</span> {</span>

                <span class="keyword">var</span> value = Twig.parse.apply(<span class="keyword">this</span>, [token.output, context]),
                    key = token.key;</pre></div></div>
            
        </li>
        
        
        <li id="section-143">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-143">&#182;</a>
              </div>
              <p>set on both the global and local context</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">this</span>.context[key] = value;
                context[key] = value;

                <span class="keyword">return</span> {
                    chain: continue_chain,
                    context: context
                };
            }
        },
        {
            <span class="comment">/**
             * End set type block logic tokens.
             *
             *  Format: {% endset %}
             */</span>
            type: Twig.logic.type.endset,
            regex: <span class="regexp">/^endset$/</span>,
            next: [ ],
            open: <span class="literal">false</span>
        },
        {
            <span class="comment">/**
             * Filter logic tokens.
             *
             *  Format: {% filter upper %} or {% filter lower|escape %}
             */</span>
            type: Twig.logic.type.filter,
            regex: <span class="regexp">/^filter\s+(.+)$/</span>,
            next: [
                Twig.logic.type.endfilter
            ],
            open: <span class="literal">true</span>,
            compile: <span class="function"><span class="keyword">function</span> <span class="params">(token)</span> {</span>
                <span class="keyword">var</span> expression = <span class="string">"|"</span> + token.match[<span class="number">1</span>].trim();</pre></div></div>
            
        </li>
        
        
        <li id="section-144">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-144">&#182;</a>
              </div>
              <p>Compile the expression.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                token.stack = Twig.expression.compile.apply(<span class="keyword">this</span>, [{
                    type:  Twig.expression.type.expression,
                    value: expression
                }]).stack;
                <span class="keyword">delete</span> token.match;
                <span class="keyword">return</span> token;
            },
            parse: <span class="function"><span class="keyword">function</span> <span class="params">(token, context, chain)</span> {</span>
                <span class="keyword">var</span> unfiltered = Twig.parse.apply(<span class="keyword">this</span>, [token.output, context]),
                    stack = [{
                        type: Twig.expression.type.string,
                        value: unfiltered
                    }].concat(token.stack);

                <span class="keyword">var</span> output = Twig.expression.parse.apply(<span class="keyword">this</span>, [stack, context]);

                <span class="keyword">return</span> {
                    chain: chain,
                    output: output
                };
            }
        },
        {
            <span class="comment">/**
             * End filter logic tokens.
             *
             *  Format: {% endfilter %}
             */</span>
            type: Twig.logic.type.endfilter,
            regex: <span class="regexp">/^endfilter$/</span>,
            next: [ ],
            open: <span class="literal">false</span>
        },
        {
            <span class="comment">/**
             * Block logic tokens.
             *
             *  Format: {% block title %}
             */</span>
            type: Twig.logic.type.block,
            regex: <span class="regexp">/^block\s+([a-zA-Z0-9_]+)$/</span>,
            next: [
                Twig.logic.type.endblock
            ],
            open: <span class="literal">true</span>,
            compile: <span class="function"><span class="keyword">function</span> <span class="params">(token)</span> {</span>
                token.block = token.match[<span class="number">1</span>].trim();
                <span class="keyword">delete</span> token.match;
                <span class="keyword">return</span> token;
            },
            parse: <span class="function"><span class="keyword">function</span> <span class="params">(token, context, chain)</span> {</span>
                <span class="keyword">var</span> block_output = <span class="string">""</span>,
                    output = <span class="string">""</span>,
                    hasParent = <span class="keyword">this</span>.blocks[token.block] &amp;&amp; <span class="keyword">this</span>.blocks[token.block].indexOf(Twig.placeholders.parent) &gt; -<span class="number">1</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-145">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-145">&#182;</a>
              </div>
              <p>Don&#39;t override previous blocks</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">if</span> (<span class="keyword">this</span>.blocks[token.block] === <span class="literal">undefined</span> || hasParent) {
                    block_output = Twig.expression.parse.apply(<span class="keyword">this</span>, [{
                        type: Twig.expression.type.string,
                        value: Twig.parse.apply(<span class="keyword">this</span>, [token.output, context])
                    }, context]);

                    <span class="keyword">if</span> (hasParent) {
                        <span class="keyword">this</span>.blocks[token.block] =  <span class="keyword">this</span>.blocks[token.block].replace(Twig.placeholders.parent, block_output);
                    } <span class="keyword">else</span> {
                        <span class="keyword">this</span>.blocks[token.block] = block_output;
                    }
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-146">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-146">&#182;</a>
              </div>
              <p>Check if a child block has been set from a template extending this one.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">if</span> (<span class="keyword">this</span>.child.blocks[token.block]) {
                    output = <span class="keyword">this</span>.child.blocks[token.block];

                } <span class="keyword">else</span> {
                    output = <span class="keyword">this</span>.blocks[token.block];
                }

                <span class="keyword">return</span> {
                    chain: chain,
                    output: output
                };
            }
        },
        {
            <span class="comment">/**
             * End block logic tokens.
             *
             *  Format: {% endblock %}
             */</span>
            type: Twig.logic.type.endblock,
            regex: <span class="regexp">/^endblock(?:\s+([a-zA-Z0-9_]+))?$/</span>,
            next: [ ],
            open: <span class="literal">false</span>
        },
        {
            <span class="comment">/**
             * Block logic tokens.
             *
             *  Format: {% extends "template.twig" %}
             */</span>
            type: Twig.logic.type.extends_,
            regex: <span class="regexp">/^extends\s+(.+)$/</span>,
            next: [ ],
            open: <span class="literal">true</span>,
            compile: <span class="function"><span class="keyword">function</span> <span class="params">(token)</span> {</span>
                <span class="keyword">var</span> expression = token.match[<span class="number">1</span>].trim();
                <span class="keyword">delete</span> token.match;

                token.stack   = Twig.expression.compile.apply(<span class="keyword">this</span>, [{
                    type:  Twig.expression.type.expression,
                    value: expression
                }]).stack;

                <span class="keyword">return</span> token;
            },
            parse: <span class="function"><span class="keyword">function</span> <span class="params">(token, context, chain)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-147">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-147">&#182;</a>
              </div>
              <p>Resolve filename</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">var</span> file = Twig.expression.parse.apply(<span class="keyword">this</span>, [token.stack, context]);</pre></div></div>
            
        </li>
        
        
        <li id="section-148">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-148">&#182;</a>
              </div>
              <p>Set parent template</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">this</span>.extend = file;

                <span class="keyword">return</span> {
                    chain: chain,
                    output: <span class="string">''</span>
                };
            }
        },
        {
            <span class="comment">/**
             * Block logic tokens.
             *
             *  Format: {% extends "template.twig" %}
             */</span>
            type: Twig.logic.type.use,
            regex: <span class="regexp">/^use\s+(.+)$/</span>,
            next: [ ],
            open: <span class="literal">true</span>,
            compile: <span class="function"><span class="keyword">function</span> <span class="params">(token)</span> {</span>
                <span class="keyword">var</span> expression = token.match[<span class="number">1</span>].trim();
                <span class="keyword">delete</span> token.match;

                token.stack = Twig.expression.compile.apply(<span class="keyword">this</span>, [{
                    type:  Twig.expression.type.expression,
                    value: expression
                }]).stack;

                <span class="keyword">return</span> token;
            },
            parse: <span class="function"><span class="keyword">function</span> <span class="params">(token, context, chain)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-149">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-149">&#182;</a>
              </div>
              <p>Resolve filename</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">var</span> file = Twig.expression.parse.apply(<span class="keyword">this</span>, [token.stack, context]);</pre></div></div>
            
        </li>
        
        
        <li id="section-150">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-150">&#182;</a>
              </div>
              <p>Import blocks</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">this</span>.importBlocks(file);

                <span class="keyword">return</span> {
                    chain: chain,
                    output: <span class="string">''</span>
                };
            }
        },
        {
            <span class="comment">/**
             * Block logic tokens.
             *
             *  Format: {% includes "template.twig" [with {some: 'values'} only] %}
             */</span>
            type: Twig.logic.type.include,
            regex: <span class="regexp">/^include\s+(ignore missing\s+)?(.+?)\s*(?:with\s+(.+?))?\s*(only)?$/</span>,
            next: [ ],
            open: <span class="literal">true</span>,
            compile: <span class="function"><span class="keyword">function</span> <span class="params">(token)</span> {</span>
                <span class="keyword">var</span> match = token.match,
                    includeMissing = match[<span class="number">1</span>] !== <span class="literal">undefined</span>,
                    expression = match[<span class="number">2</span>].trim(),
                    withContext = match[<span class="number">3</span>],
                    only = ((match[<span class="number">4</span>] !== <span class="literal">undefined</span>) &amp;&amp; match[<span class="number">4</span>].length);

                <span class="keyword">delete</span> token.match;

                token.only = only;
                token.includeMissing = includeMissing;

                token.stack = Twig.expression.compile.apply(<span class="keyword">this</span>, [{
                    type:  Twig.expression.type.expression,
                    value: expression
                }]).stack;

                <span class="keyword">if</span> (withContext !== <span class="literal">undefined</span>) {
                    token.withStack = Twig.expression.compile.apply(<span class="keyword">this</span>, [{
                        type:  Twig.expression.type.expression,
                        value: withContext.trim()
                    }]).stack;
                }

                <span class="keyword">return</span> token;
            },
            parse: <span class="function"><span class="keyword">function</span> <span class="params">(token, context, chain)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-151">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-151">&#182;</a>
              </div>
              <p>Resolve filename</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">var</span> innerContext = {},
                    withContext,
                    i,
                    template;

                <span class="keyword">if</span> (!token.only) {
                    <span class="keyword">for</span> (i <span class="keyword">in</span> context) {
                        <span class="keyword">if</span> (context.hasOwnProperty(i))
                            innerContext[i] = context[i];
                    }
                }

                <span class="keyword">if</span> (token.withStack !== <span class="literal">undefined</span>) {
                    withContext = Twig.expression.parse.apply(<span class="keyword">this</span>, [token.withStack, context]);

                    <span class="keyword">for</span> (i <span class="keyword">in</span> withContext) {
                        <span class="keyword">if</span> (withContext.hasOwnProperty(i))
                            innerContext[i] = withContext[i];
                    }
                }

                <span class="keyword">var</span> file = Twig.expression.parse.apply(<span class="keyword">this</span>, [token.stack, innerContext]);</pre></div></div>
            
        </li>
        
        
        <li id="section-152">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-152">&#182;</a>
              </div>
              <p>Import file</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                template = <span class="keyword">this</span>.importFile(file);

                <span class="keyword">return</span> {
                    chain: chain,
                    output: template.render(innerContext)
                };
            }
        },
        {
            type: Twig.logic.type.spaceless,
            regex: <span class="regexp">/^spaceless$/</span>,
            next: [
                Twig.logic.type.endspaceless
            ],
            open: <span class="literal">true</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-153">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-153">&#182;</a>
              </div>
              <p>Parse the html and return it without any spaces between tags</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            parse: <span class="function"><span class="keyword">function</span> <span class="params">(token, context, chain)</span> {</span>
                <span class="keyword">var</span> <span class="comment">// Parse the output without any filter</span>
                    unfiltered = Twig.parse.apply(<span class="keyword">this</span>, [token.output, context]),</pre></div></div>
            
        </li>
        
        
        <li id="section-154">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-154">&#182;</a>
              </div>
              <p>A regular expression to find closing and opening tags with spaces between them</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    rBetweenTagSpaces = <span class="regexp">/&gt;\s+&lt;/g</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-155">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-155">&#182;</a>
              </div>
              <p>Replace all space between closing and opening html tags</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    output = unfiltered.replace(rBetweenTagSpaces,<span class="string">'&gt;&lt;'</span>).trim();

                <span class="keyword">return</span> {
                    chain: chain,
                    output: output
                };
            }
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-156">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-156">&#182;</a>
              </div>
              <p>Add the {% endspaceless %} token</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        {
            type: Twig.logic.type.endspaceless,
            regex: <span class="regexp">/^endspaceless$/</span>,
            next: [ ],
            open: <span class="literal">false</span>
        },
        {
            <span class="comment">/**
             * Macro logic tokens.
             *
             * Format: {% maro input(name, value, type, size) %}
             *
             */</span> 
            type: Twig.logic.type.macro,
            regex: <span class="regexp">/^macro\s+([a-zA-Z0-9_]+)\s?\((([a-zA-Z0-9_]+(,\s?)?)*)\)$/</span>,
            next: [
                Twig.logic.type.endmacro
            ],
            open: <span class="literal">true</span>,
            compile: <span class="function"><span class="keyword">function</span> <span class="params">(token)</span> {</span>
                <span class="keyword">var</span> macroName = token.match[<span class="number">1</span>],
                    parameters = token.match[<span class="number">2</span>].split(<span class="regexp">/[ ,]+/</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-157">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-157">&#182;</a>
              </div>
              <p>TODO: Clean up duplicate check</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>; i&lt;parameters.length; i++) {
                    <span class="keyword">for</span> (<span class="keyword">var</span> j=<span class="number">0</span>; j&lt;parameters.length; j++){
                        <span class="keyword">if</span> (parameters[i] === parameters[j] &amp;&amp; i !== j) {
                            <span class="keyword">throw</span> <span class="keyword">new</span> Twig.Error(<span class="string">"Duplicate arguments for parameter: "</span>+ parameters[i]);
                        }
                    }
                }

                token.macroName = macroName;
                token.parameters = parameters;

                <span class="keyword">delete</span> token.match;
                <span class="keyword">return</span> token;
            },
            parse: <span class="function"><span class="keyword">function</span> <span class="params">(token, context, chain)</span> {</span>
                <span class="keyword">var</span> template = <span class="keyword">this</span>;
                <span class="keyword">this</span>.macros[token.macroName] = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-158">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-158">&#182;</a>
              </div>
              <p>Pass global context and other macros </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">var</span> macroContext = {
                        _self: template.macros
                    }</pre></div></div>
            
        </li>
        
        
        <li id="section-159">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-159">&#182;</a>
              </div>
              <p>Add parameters from context to macroContext</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>; i&lt;token.parameters.length; i++) {
                        <span class="keyword">var</span> prop = token.parameters[i];
                        macroContext[prop] = arguments[i] || <span class="literal">undefined</span>;
                    }</pre></div></div>
            
        </li>
        
        
        <li id="section-160">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-160">&#182;</a>
              </div>
              <p>Render</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">return</span> Twig.parse.apply(template, [token.output, macroContext])
                };

                <span class="keyword">return</span> {
                    chain: chain,
                    output: <span class="string">''</span>
                };

            }
            
        },
        {
            <span class="comment">/**
             * End macro logic tokens.
             *
             * Format: {% endmacro %}
             */</span> 
             type: Twig.logic.type.endmacro,
             regex: <span class="regexp">/^endmacro$/</span>,
             next: [ ],
             open: <span class="literal">false</span>
        },
        {
            <span class="comment">/*
            * import logic tokens.
            *
            * Format: {% import "template.twig" as form %}
            */</span>
            type: Twig.logic.type.import_,
            regex: <span class="regexp">/^import\s+(.+)\s+as\s+([a-zA-Z0-9_]+)$/</span>,
            next: [ ],
            open: <span class="literal">true</span>,
            compile: <span class="function"><span class="keyword">function</span> <span class="params">(token)</span> {</span>
                <span class="keyword">var</span> expression = token.match[<span class="number">1</span>].trim(),
                    contextName = token.match[<span class="number">2</span>].trim();
                <span class="keyword">delete</span> token.match;

                token.expression = expression;
                token.contextName = contextName;

                token.stack = Twig.expression.compile.apply(<span class="keyword">this</span>, [{
                    type: Twig.expression.type.expression,
                    value: expression
                }]).stack;

                <span class="keyword">return</span> token;
            },
            parse: <span class="function"><span class="keyword">function</span> <span class="params">(token, context, chain)</span> {</span>
                <span class="keyword">if</span> (token.expression !== <span class="string">"_self"</span>) {
                    <span class="keyword">var</span> file = Twig.expression.parse.apply(<span class="keyword">this</span>, [token.stack, context]);
                    <span class="keyword">var</span> template = <span class="keyword">this</span>.importMacros(file || token.expression);
                    context[token.contextName] = template.render({}, {output: <span class="string">'macros'</span>});
                }
                <span class="keyword">else</span> {
                    context[token.contextName] = <span class="keyword">this</span>.macros;
                }

                <span class="keyword">return</span> {
                    chain: chain,
                    output: <span class="string">''</span>
                }

            }
        },
        {
            <span class="comment">/*
            * from logic tokens.
            *
            * Format: {% from "template.twig" import func as form %}
            */</span>
            type: Twig.logic.type.from,
            regex: <span class="regexp">/^from\s+(.+)\s+import\s+([a-zA-Z0-9_, ]+)$/</span>,
            next: [ ],
            open: <span class="literal">true</span>,
            compile: <span class="function"><span class="keyword">function</span> <span class="params">(token)</span> {</span>
                <span class="keyword">var</span> expression = token.match[<span class="number">1</span>].trim(),
                    macroExpressions = token.match[<span class="number">2</span>].trim().split(<span class="regexp">/[ ,]+/</span>),
                    macroNames = {};
                    

                <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>; i&lt;macroExpressions.length; i++) {
                    <span class="keyword">var</span> res = macroExpressions[i];</pre></div></div>
            
        </li>
        
        
        <li id="section-161">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-161">&#182;</a>
              </div>
              <p>match function as variable</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">var</span> macroMatch = res.match(<span class="regexp">/^([a-zA-Z0-9_]+)\s+(.+)\s+as\s+([a-zA-Z0-9_]+)$/</span>);
                    <span class="keyword">if</span> (macroMatch) {
                        macroNames[macroMatch[<span class="number">1</span>].trim()] = macroMatch[<span class="number">2</span>].trim();
                    }
                    <span class="keyword">else</span> <span class="keyword">if</span> (res.match(<span class="regexp">/^([a-zA-Z0-9_]+)$/</span>)) {
                        macroNames[res] = res;
                    }
                    <span class="keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-162">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-162">&#182;</a>
              </div>
              <p>ignore import</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    }

                }

                <span class="keyword">delete</span> token.match;

                token.expression = expression;
                token.macroNames = macroNames;

                token.stack = Twig.expression.compile.apply(<span class="keyword">this</span>, [{
                    type: Twig.expression.type.expression,
                    value: expression
                }]).stack;

                <span class="keyword">return</span> token;
            },
            parse: <span class="function"><span class="keyword">function</span> <span class="params">(token, context, chain)</span> {</span>
                <span class="keyword">var</span> macros;

                <span class="keyword">if</span> (token.expression !== <span class="string">"_self"</span>) {
                    <span class="keyword">var</span> file = Twig.expression.parse.apply(<span class="keyword">this</span>, [token.stack, context]);
                    <span class="keyword">var</span> template = <span class="keyword">this</span>.importMacros(file || token.expression);
                    macros = template.render({}, {output: <span class="string">'macros'</span>});
                }
                <span class="keyword">else</span> {
                    macros = <span class="keyword">this</span>.macros;
                }

                <span class="keyword">for</span> (<span class="keyword">var</span> macroName <span class="keyword">in</span> token.macroNames) {
                    <span class="keyword">if</span> (macros.hasOwnProperty(macroName)) {
                        context[token.macroNames[macroName]] = macros[macroName];
                    }
                }

                <span class="keyword">return</span> {
                    chain: chain,
                    output: <span class="string">''</span>
                }

            }
        }

    ];


    <span class="comment">/**
     * Registry for logic handlers.
     */</span>
    Twig.logic.handler = {};

    <span class="comment">/**
     * Define a new token type, available at Twig.logic.type.{type}
     */</span>
    Twig.logic.extendType = <span class="function"><span class="keyword">function</span> <span class="params">(type, value)</span> {</span>
        value = value || (<span class="string">"Twig.logic.type"</span> + type);
        Twig.logic.type[type] = value;
    };

    <span class="comment">/**
     * Extend the logic parsing functionality with a new token definition.
     *
     * // Define a new tag
     * Twig.logic.extend({
     *     type: Twig.logic.type.{type},
     *     // The pattern to match for this token
     *     regex: ...,
     *     // What token types can follow this token, leave blank if any.
     *     next: [ ... ]
     *     // Create and return compiled version of the token
     *     compile: function(token) { ... }
     *     // Parse the compiled token with the context provided by the render call
     *     //   and whether this token chain is complete.
     *     parse: function(token, context, chain) { ... }
     * });
     *
     * @param {Object} definition The new logic expression.
     */</span>
    Twig.logic.extend = <span class="function"><span class="keyword">function</span> <span class="params">(definition)</span> {</span>

        <span class="keyword">if</span> (!definition.type) {
            <span class="keyword">throw</span> <span class="keyword">new</span> Twig.Error(<span class="string">"Unable to extend logic definition. No type provided for "</span> + definition);
        }
        <span class="keyword">if</span> (Twig.logic.type[definition.type]) {
            <span class="keyword">throw</span> <span class="keyword">new</span> Twig.Error(<span class="string">"Unable to extend logic definitions. Type "</span> +
                                 definition.type + <span class="string">" is already defined."</span>);
        } <span class="keyword">else</span> {
            Twig.logic.extendType(definition.type);
        }
        Twig.logic.handler[definition.type] = definition;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-163">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-163">&#182;</a>
              </div>
              <p>Extend with built-in expressions</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">while</span> (Twig.logic.definitions.length &gt; <span class="number">0</span>) {
        Twig.logic.extend(Twig.logic.definitions.shift());
    }

    <span class="comment">/**
     * Compile a logic token into an object ready for parsing.
     *
     * @param {Object} raw_token An uncompiled logic token.
     *
     * @return {Object} A compiled logic token, ready for parsing.
     */</span>
    Twig.logic.compile = <span class="function"><span class="keyword">function</span> <span class="params">(raw_token)</span> {</span>
        <span class="keyword">var</span> expression = raw_token.value.trim(),
            token = Twig.logic.tokenize.apply(<span class="keyword">this</span>, [expression]),
            token_template = Twig.logic.handler[token.type];</pre></div></div>
            
        </li>
        
        
        <li id="section-164">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-164">&#182;</a>
              </div>
              <p>Check if the token needs compiling</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (token_template.compile) {
            token = token_template.compile.apply(<span class="keyword">this</span>, [token]);
            Twig.log.trace(<span class="string">"Twig.logic.compile: "</span>, <span class="string">"Compiled logic token to "</span>, token);
        }

        <span class="keyword">return</span> token;
    };

    <span class="comment">/**
     * Tokenize logic expressions. This function matches token expressions against regular
     * expressions provided in token definitions provided with Twig.logic.extend.
     *
     * @param {string} expression the logic token expression to tokenize
     *                (i.e. what's between {% and %})
     *
     * @return {Object} The matched token with type set to the token type and match to the regex match.
     */</span>
    Twig.logic.tokenize = <span class="function"><span class="keyword">function</span> <span class="params">(expression)</span> {</span>
        <span class="keyword">var</span> token = {},
            token_template_type = <span class="literal">null</span>,
            token_type = <span class="literal">null</span>,
            token_regex = <span class="literal">null</span>,
            regex_array = <span class="literal">null</span>,
            regex = <span class="literal">null</span>,
            match = <span class="literal">null</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-165">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-165">&#182;</a>
              </div>
              <p>Ignore whitespace around expressions.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        expression = expression.trim();

        <span class="keyword">for</span> (token_template_type <span class="keyword">in</span> Twig.logic.handler) {
            <span class="keyword">if</span> (Twig.logic.handler.hasOwnProperty(token_template_type)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-166">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-166">&#182;</a>
              </div>
              <p>Get the type and regex for this template type</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                token_type = Twig.logic.handler[token_template_type].type;
                token_regex = Twig.logic.handler[token_template_type].regex;</pre></div></div>
            
        </li>
        
        
        <li id="section-167">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-167">&#182;</a>
              </div>
              <p>Handle multiple regular expressions per type.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                regex_array = [];
                <span class="keyword">if</span> (token_regex <span class="keyword">instanceof</span> Array) {
                    regex_array = token_regex;
                } <span class="keyword">else</span> {
                    regex_array.push(token_regex);
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-168">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-168">&#182;</a>
              </div>
              <p>Check regular expressions in the order they were specified in the definition.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">while</span> (regex_array.length &gt; <span class="number">0</span>) {
                    regex = regex_array.shift();
                    match = regex.exec(expression.trim());
                    <span class="keyword">if</span> (match !== <span class="literal">null</span>) {
                        token.type  = token_type;
                        token.match = match;
                        Twig.log.trace(<span class="string">"Twig.logic.tokenize: "</span>, <span class="string">"Matched a "</span>, token_type, <span class="string">" regular expression of "</span>, match);
                        <span class="keyword">return</span> token;
                    }
                }
            }
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-169">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-169">&#182;</a>
              </div>
              <p>No regex matches</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">throw</span> <span class="keyword">new</span> Twig.Error(<span class="string">"Unable to parse '"</span> + expression.trim() + <span class="string">"'"</span>);
    };

    <span class="comment">/**
     * Parse a logic token within a given context.
     *
     * What are logic chains?
     *      Logic chains represent a series of tokens that are connected,
     *          for example:
     *          {% if ... %} {% else %} {% endif %}
     *
     *      The chain parameter is used to signify if a chain is open of closed.
     *      open:
     *          More tokens in this chain should be parsed.
     *      closed:
     *          This token chain has completed parsing and any additional
     *          tokens (else, elseif, etc...) should be ignored.
     *
     * @param {Object} token The compiled token.
     * @param {Object} context The render context.
     * @param {boolean} chain Is this an open logic chain. If false, that means a
     *                        chain is closed and no further cases should be parsed.
     */</span>
    Twig.logic.parse = <span class="function"><span class="keyword">function</span> <span class="params">(token, context, chain)</span> {</span>
        <span class="keyword">var</span> output = <span class="string">''</span>,
            token_template;

        context = context || { };

        Twig.log.debug(<span class="string">"Twig.logic.parse: "</span>, <span class="string">"Parsing logic token "</span>, token);

        token_template = Twig.logic.handler[token.type];

        <span class="keyword">if</span> (token_template.parse) {
            output = token_template.parse.apply(<span class="keyword">this</span>, [token, context, chain]);
        }
        <span class="keyword">return</span> output;
    };

    <span class="keyword">return</span> Twig;

})(Twig || { });</pre></div></div>
            
        </li>
        
        
        <li id="section-170">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-170">&#182;</a>
              </div>
              <pre><code>Twig.js
Copyright (c) 2011-2013 John Roepke
Available under the BSD 2-Clause License
https://github.com/justjohn/twig.js</code></pre>
<h2 id="twig-expression-js">twig.expression.js</h2>
<p>This file handles tokenizing, compiling and parsing expressions.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> Twig = (<span class="function"><span class="keyword">function</span> <span class="params">(Twig)</span> {</span>
    <span class="string">"use strict"</span>;

    <span class="comment">/**
     * Namespace for expression handling.
     */</span>
    Twig.expression = { };

    <span class="comment">/**
     * Reserved word that can't be used as variable names.
     */</span>
    Twig.expression.reservedWords = [
        <span class="string">"true"</span>, <span class="string">"false"</span>, <span class="string">"null"</span>, <span class="string">"_context"</span>
    ];

    <span class="comment">/**
     * The type of tokens used in expressions.
     */</span>
    Twig.expression.type = {
        comma:      <span class="string">'Twig.expression.type.comma'</span>,
        operator: {
            unary:  <span class="string">'Twig.expression.type.operator.unary'</span>,
            binary: <span class="string">'Twig.expression.type.operator.binary'</span>
        },
        string:     <span class="string">'Twig.expression.type.string'</span>,
        bool:       <span class="string">'Twig.expression.type.bool'</span>,
        array: {
            start:  <span class="string">'Twig.expression.type.array.start'</span>,
            end:    <span class="string">'Twig.expression.type.array.end'</span>
        },
        object: {
            start:  <span class="string">'Twig.expression.type.object.start'</span>,
            end:    <span class="string">'Twig.expression.type.object.end'</span>
        },
        parameter: {
            start:  <span class="string">'Twig.expression.type.parameter.start'</span>,
            end:    <span class="string">'Twig.expression.type.parameter.end'</span>
        },
        key: {
            period:   <span class="string">'Twig.expression.type.key.period'</span>,
            brackets: <span class="string">'Twig.expression.type.key.brackets'</span>
        },
        filter:     <span class="string">'Twig.expression.type.filter'</span>,
        _function:  <span class="string">'Twig.expression.type._function'</span>,
        variable:   <span class="string">'Twig.expression.type.variable'</span>,
        number:     <span class="string">'Twig.expression.type.number'</span>,
        _null:     <span class="string">'Twig.expression.type.null'</span>,
        context:    <span class="string">'Twig.expression.type.context'</span>,
        test:       <span class="string">'Twig.expression.type.test'</span>
    };

    Twig.expression.set = {</pre></div></div>
            
        </li>
        
        
        <li id="section-171">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-171">&#182;</a>
              </div>
              <p>What can follow an expression (in general)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        operations: [
            Twig.expression.type.filter,
            Twig.expression.type.operator.unary,
            Twig.expression.type.operator.binary,
            Twig.expression.type.array.end,
            Twig.expression.type.object.end,
            Twig.expression.type.parameter.end,
            Twig.expression.type.comma,
            Twig.expression.type.test
        ],
        expressions: [
            Twig.expression.type._function,
            Twig.expression.type.bool,
            Twig.expression.type.string,
            Twig.expression.type.variable,
            Twig.expression.type.number,
            Twig.expression.type._null,
            Twig.expression.type.context,
            Twig.expression.type.parameter.start,
            Twig.expression.type.array.start,
            Twig.expression.type.object.start
        ]
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-172">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-172">&#182;</a>
              </div>
              <p>Most expressions allow a &#39;.&#39; or &#39;[&#39; after them, so we provide a convenience set</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    Twig.expression.set.operations_extended = Twig.expression.set.operations.concat([
                    Twig.expression.type.key.period,
                    Twig.expression.type.key.brackets]);</pre></div></div>
            
        </li>
        
        
        <li id="section-173">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-173">&#182;</a>
              </div>
              <p>Some commonly used compile and parse functions.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    Twig.expression.fn = {
        compile: {
            push: <span class="function"><span class="keyword">function</span><span class="params">(token, stack, output)</span> {</span>
                output.push(token);
            },
            push_both: <span class="function"><span class="keyword">function</span><span class="params">(token, stack, output)</span> {</span>
                output.push(token);
                stack.push(token);
            }
        },
        parse: {
            push: <span class="function"><span class="keyword">function</span><span class="params">(token, stack, context)</span> {</span>
                stack.push(token);
            },
            push_value: <span class="function"><span class="keyword">function</span><span class="params">(token, stack, context)</span> {</span>
                stack.push(token.value);
            }
        }
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-174">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-174">&#182;</a>
              </div>
              <p>The regular expressions and compile/parse logic used to match tokens in expressions.</p>
<p>Properties:</p>
<pre><code> type:  The type of expression this matches

 regex: One or more regular expressions that matche the format of the token.

 next:  Valid tokens that can occur next in the expression.</code></pre>
<p>Functions:</p>
<pre><code> compile: A function that compiles the raw regular expression match into a token.

 parse:   A function that parses the compiled token into output.</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>    Twig.expression.definitions = [
        {
            type: Twig.expression.type.test,
            regex: <span class="regexp">/^is\s+(not)?\s*([a-zA-Z_][a-zA-Z0-9_]*)/</span>,
            next: Twig.expression.set.operations.concat([Twig.expression.type.parameter.start]),
            compile: <span class="function"><span class="keyword">function</span><span class="params">(token, stack, output)</span> {</span>
                token.filter   = token.match[<span class="number">2</span>];
                token.modifier = token.match[<span class="number">1</span>];
                <span class="keyword">delete</span> token.match;
                <span class="keyword">delete</span> token.value;
                output.push(token);
            },
            parse: <span class="function"><span class="keyword">function</span><span class="params">(token, stack, context)</span> {</span>
                <span class="keyword">var</span> value = stack.pop(),
                    params = token.params &amp;&amp; Twig.expression.parse.apply(<span class="keyword">this</span>, [token.params, context]),
                    result = Twig.test(token.filter, value, params);

                <span class="keyword">if</span> (token.modifier == <span class="string">'not'</span>) {
                    stack.push(!result);
                } <span class="keyword">else</span> {
                    stack.push(result);
                }
            }
        },
        {
            type: Twig.expression.type.comma,</pre></div></div>
            
        </li>
        
        
        <li id="section-175">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-175">&#182;</a>
              </div>
              <p>Match a comma</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            regex: <span class="regexp">/^,/</span>,
            next: Twig.expression.set.expressions.concat([Twig.expression.type.array.end, Twig.expression.type.object.end]),
            compile: <span class="function"><span class="keyword">function</span><span class="params">(token, stack, output)</span> {</span>
                <span class="keyword">var</span> i = stack.length - <span class="number">1</span>,
                    stack_token;

                <span class="keyword">delete</span> token.match;
                <span class="keyword">delete</span> token.value;</pre></div></div>
            
        </li>
        
        
        <li id="section-176">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-176">&#182;</a>
              </div>
              <p>pop tokens off the stack until the start of the object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">for</span>(;i &gt;= <span class="number">0</span>; i--) {
                    stack_token = stack.pop();
                    <span class="keyword">if</span> (stack_token.type === Twig.expression.type.object.start
                            || stack_token.type === Twig.expression.type.parameter.start
                            || stack_token.type === Twig.expression.type.array.start) {
                        stack.push(stack_token);
                        <span class="keyword">break</span>;
                    }
                    output.push(stack_token);
                }
                output.push(token);
            }
        },
        {
            type: Twig.expression.type.operator.binary,</pre></div></div>
            
        </li>
        
        
        <li id="section-177">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-177">&#182;</a>
              </div>
              <p>Match any of +, <em>, /, -, %, ~, &lt;, &lt;=, &gt;, &gt;=, !=, ==, *</em>, ?, :, and, or, not</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            regex: <span class="regexp">/(^[\+\-~%\?\:]|^[!=]==?|^[!&lt;&gt;]=?|^\*\*?|^\/\/?|^and\s+|^or\s+|^in\s+|^not in\s+|^\.\.)/</span>,
            next: Twig.expression.set.expressions.concat([Twig.expression.type.operator.unary]),
            compile: <span class="function"><span class="keyword">function</span><span class="params">(token, stack, output)</span> {</span>
                <span class="keyword">delete</span> token.match;

                token.value = token.value.trim();
                <span class="keyword">var</span> value = token.value,
                    operator = Twig.expression.operator.lookup(value, token);

                Twig.log.trace(<span class="string">"Twig.expression.compile: "</span>, <span class="string">"Operator: "</span>, operator, <span class="string">" from "</span>, value);

                <span class="keyword">while</span> (stack.length &gt; <span class="number">0</span> &amp;&amp;
                       (stack[stack.length-<span class="number">1</span>].type == Twig.expression.type.operator.unary || stack[stack.length-<span class="number">1</span>].type == Twig.expression.type.operator.binary) &amp;&amp;
                            (
                                (operator.associativity === Twig.expression.operator.leftToRight &amp;&amp;
                                 operator.precidence    &gt;= stack[stack.length-<span class="number">1</span>].precidence) ||

                                (operator.associativity === Twig.expression.operator.rightToLeft &amp;&amp;
                                 operator.precidence    &gt;  stack[stack.length-<span class="number">1</span>].precidence)
                            )
                       ) {
                     <span class="keyword">var</span> temp = stack.pop();
                     output.push(temp);
                }

                <span class="keyword">if</span> (value === <span class="string">":"</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-178">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-178">&#182;</a>
              </div>
              <p>Check if this is a ternary or object key being set</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">if</span> (stack[stack.length - <span class="number">1</span>] &amp;&amp; stack[stack.length-<span class="number">1</span>].value === <span class="string">"?"</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-179">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-179">&#182;</a>
              </div>
              <p>Continue as normal for a ternary</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    } <span class="keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-180">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-180">&#182;</a>
              </div>
              <p>This is not a ternary so we push the token to the output where it can be handled
  when the assocated object is closed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        <span class="keyword">var</span> key_token = output.pop();

                        <span class="keyword">if</span> (key_token.type === Twig.expression.type.string ||
                                key_token.type === Twig.expression.type.variable ||
                                key_token.type === Twig.expression.type.number) {
                            token.key = key_token.value;

                        } <span class="keyword">else</span> {
                            <span class="keyword">throw</span> <span class="keyword">new</span> Twig.Error(<span class="string">"Unexpected value before ':' of "</span> + key_token.type + <span class="string">" = "</span> + key_token.value);
                        }

                        output.push(token);
                        <span class="keyword">return</span>;
                    }
                } <span class="keyword">else</span> {
                    stack.push(operator);
                }
            },
            parse: <span class="function"><span class="keyword">function</span><span class="params">(token, stack, context)</span> {</span>
                <span class="keyword">if</span> (token.key) {</pre></div></div>
            
        </li>
        
        
        <li id="section-181">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-181">&#182;</a>
              </div>
              <p>handle ternary &#39;:&#39; operator</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    stack.push(token);
                } <span class="keyword">else</span> {
                    Twig.expression.operator.parse(token.value, stack);
                }
            }
        },
        {
            type: Twig.expression.type.operator.unary,</pre></div></div>
            
        </li>
        
        
        <li id="section-182">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-182">&#182;</a>
              </div>
              <p>Match any of not</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            regex: <span class="regexp">/(^not\s+)/</span>,
            next: Twig.expression.set.expressions,
            compile: <span class="function"><span class="keyword">function</span><span class="params">(token, stack, output)</span> {</span>
                <span class="keyword">delete</span> token.match;

                token.value = token.value.trim();
                <span class="keyword">var</span> value = token.value,
                    operator = Twig.expression.operator.lookup(value, token);

                Twig.log.trace(<span class="string">"Twig.expression.compile: "</span>, <span class="string">"Operator: "</span>, operator, <span class="string">" from "</span>, value);

                <span class="keyword">while</span> (stack.length &gt; <span class="number">0</span> &amp;&amp;
                       (stack[stack.length-<span class="number">1</span>].type == Twig.expression.type.operator.unary || stack[stack.length-<span class="number">1</span>].type == Twig.expression.type.operator.binary) &amp;&amp;
                            (
                                (operator.associativity === Twig.expression.operator.leftToRight &amp;&amp;
                                 operator.precidence    &gt;= stack[stack.length-<span class="number">1</span>].precidence) ||

                                (operator.associativity === Twig.expression.operator.rightToLeft &amp;&amp;
                                 operator.precidence    &gt;  stack[stack.length-<span class="number">1</span>].precidence)
                            )
                       ) {
                     <span class="keyword">var</span> temp = stack.pop();
                     output.push(temp);
                }

                stack.push(operator);
            },
            parse: <span class="function"><span class="keyword">function</span><span class="params">(token, stack, context)</span> {</span>
                Twig.expression.operator.parse(token.value, stack);
            }
        },
        {
            <span class="comment">/**
             * Match a string. This is anything between a pair of single or double quotes.
             */</span>
            type: Twig.expression.type.string,</pre></div></div>
            
        </li>
        
        
        <li id="section-183">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-183">&#182;</a>
              </div>
              <p>See: <a href="http://blog.stevenlevithan.com/archives/match-quoted-string">http://blog.stevenlevithan.com/archives/match-quoted-string</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            regex: <span class="regexp">/^(["'])(?:(?=(\\?))\2.)*?\1/</span>,
            next: Twig.expression.set.operations,
            compile: <span class="function"><span class="keyword">function</span><span class="params">(token, stack, output)</span> {</span>
                <span class="keyword">var</span> value = token.value;
                <span class="keyword">delete</span> token.match</pre></div></div>
            
        </li>
        
        
        <li id="section-184">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-184">&#182;</a>
              </div>
              <p>Remove the quotes from the string</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">if</span> (value.substring(<span class="number">0</span>, <span class="number">1</span>) === <span class="string">'"'</span>) {
                    value = value.replace(<span class="string">'\\"'</span>, <span class="string">'"'</span>);
                } <span class="keyword">else</span> {
                    value = value.replace(<span class="string">"\\'"</span>, <span class="string">"'"</span>);
                }
                token.value = value.substring(<span class="number">1</span>, value.length-<span class="number">1</span>).replace( <span class="regexp">/\\n/g</span>, <span class="string">"\n"</span> ).replace( <span class="regexp">/\\r/g</span>, <span class="string">"\r"</span> );
                Twig.log.trace(<span class="string">"Twig.expression.compile: "</span>, <span class="string">"String value: "</span>, token.value);
                output.push(token);
            },
            parse: Twig.expression.fn.parse.push_value
        },
        {
            <span class="comment">/**
             * Match a parameter set start.
             */</span>
            type: Twig.expression.type.parameter.start,
            regex: <span class="regexp">/^\(/</span>,
            next: Twig.expression.set.expressions.concat([Twig.expression.type.parameter.end]),
            compile: Twig.expression.fn.compile.push_both,
            parse: Twig.expression.fn.parse.push
        },
        {
            <span class="comment">/**
             * Match a parameter set end.
             */</span>
            type: Twig.expression.type.parameter.end,
            regex: <span class="regexp">/^\)/</span>,
            next: Twig.expression.set.operations_extended,
            compile: <span class="function"><span class="keyword">function</span><span class="params">(token, stack, output)</span> {</span>
                <span class="keyword">var</span> stack_token,
                    end_token = token;

                stack_token = stack.pop();
                <span class="keyword">while</span>(stack.length &gt; <span class="number">0</span> &amp;&amp; stack_token.type != Twig.expression.type.parameter.start) {
                    output.push(stack_token);
                    stack_token = stack.pop();
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-185">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-185">&#182;</a>
              </div>
              <p>Move contents of parens into preceding filter</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">var</span> param_stack = [];
                <span class="keyword">while</span>(token.type !== Twig.expression.type.parameter.start) {</pre></div></div>
            
        </li>
        
        
        <li id="section-186">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-186">&#182;</a>
              </div>
              <p>Add token to arguments stack</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    param_stack.unshift(token);
                    token = output.pop();
                }
                param_stack.unshift(token);

                <span class="keyword">var</span> is_expression = <span class="literal">false</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-187">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-187">&#182;</a>
              </div>
              <p>Get the token preceding the parameters</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                token = output[output.length-<span class="number">1</span>];

                <span class="keyword">if</span> (token === <span class="literal">undefined</span> ||
                    (token.type !== Twig.expression.type._function &amp;&amp;
                    token.type !== Twig.expression.type.filter &amp;&amp;
                    token.type !== Twig.expression.type.test &amp;&amp;
                    token.type !== Twig.expression.type.key.brackets &amp;&amp;
                    token.type !== Twig.expression.type.key.period)) {

                    end_token.expression = <span class="literal">true</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-188">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-188">&#182;</a>
              </div>
              <p>remove start and end token from stack</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    param_stack.pop();
                    param_stack.shift();

                    end_token.params = param_stack;

                    output.push(end_token);

                } <span class="keyword">else</span> {
                    end_token.expression = <span class="literal">false</span>;
                    token.params = param_stack;
                }
            },
            parse: <span class="function"><span class="keyword">function</span><span class="params">(token, stack, context)</span> {</span>
                <span class="keyword">var</span> new_array = [],
                    array_ended = <span class="literal">false</span>,
                    value = <span class="literal">null</span>;

                <span class="keyword">if</span> (token.expression) {
                    value = Twig.expression.parse.apply(<span class="keyword">this</span>, [token.params, context])
                    stack.push(value);

                } <span class="keyword">else</span> {

                    <span class="keyword">while</span> (stack.length &gt; <span class="number">0</span>) {
                        value = stack.pop();</pre></div></div>
            
        </li>
        
        
        <li id="section-189">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-189">&#182;</a>
              </div>
              <p>Push values into the array until the start of the array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        <span class="keyword">if</span> (value &amp;&amp; value.type &amp;&amp; value.type == Twig.expression.type.parameter.start) {
                            array_ended = <span class="literal">true</span>;
                            <span class="keyword">break</span>;
                        }
                        new_array.unshift(value);
                    }

                    <span class="keyword">if</span> (!array_ended) {
                        <span class="keyword">throw</span> <span class="keyword">new</span> Twig.Error(<span class="string">"Expected end of parameter set."</span>);
                    }

                    stack.push(new_array);
                }
            }
        },
        {
            <span class="comment">/**
             * Match an array start.
             */</span>
            type: Twig.expression.type.array.start,
            regex: <span class="regexp">/^\[/</span>,
            next: Twig.expression.set.expressions.concat([Twig.expression.type.array.end]),
            compile: Twig.expression.fn.compile.push_both,
            parse: Twig.expression.fn.parse.push
        },
        {
            <span class="comment">/**
             * Match an array end.
             */</span>
            type: Twig.expression.type.array.end,
            regex: <span class="regexp">/^\]/</span>,
            next: Twig.expression.set.operations_extended,
            compile: <span class="function"><span class="keyword">function</span><span class="params">(token, stack, output)</span> {</span>
                <span class="keyword">var</span> i = stack.length - <span class="number">1</span>,
                    stack_token;</pre></div></div>
            
        </li>
        
        
        <li id="section-190">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-190">&#182;</a>
              </div>
              <p>pop tokens off the stack until the start of the object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">for</span>(;i &gt;= <span class="number">0</span>; i--) {
                    stack_token = stack.pop();
                    <span class="keyword">if</span> (stack_token.type === Twig.expression.type.array.start) {
                        <span class="keyword">break</span>;
                    }
                    output.push(stack_token);
                }
                output.push(token);
            },
            parse: <span class="function"><span class="keyword">function</span><span class="params">(token, stack, context)</span> {</span>
                <span class="keyword">var</span> new_array = [],
                    array_ended = <span class="literal">false</span>,
                    value = <span class="literal">null</span>;

                <span class="keyword">while</span> (stack.length &gt; <span class="number">0</span>) {
                    value = stack.pop();</pre></div></div>
            
        </li>
        
        
        <li id="section-191">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-191">&#182;</a>
              </div>
              <p>Push values into the array until the start of the array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">if</span> (value.type &amp;&amp; value.type == Twig.expression.type.array.start) {
                        array_ended = <span class="literal">true</span>;
                        <span class="keyword">break</span>;
                    }
                    new_array.unshift(value);
                }
                <span class="keyword">if</span> (!array_ended) {
                    <span class="keyword">throw</span> <span class="keyword">new</span> Twig.Error(<span class="string">"Expected end of array."</span>);
                }

                stack.push(new_array);
            }
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-192">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-192">&#182;</a>
              </div>
              <p>Token that represents the start of a hash map &#39;}&#39;</p>
<p>Hash maps take the form:
   { &quot;key&quot;: &#39;value&#39;, &quot;another_key&quot;: item }</p>
<p>Keys must be quoted (either single or double) and values can be any expression.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        {
            type: Twig.expression.type.object.start,
            regex: <span class="regexp">/^\{/</span>,
            next: Twig.expression.set.expressions.concat([Twig.expression.type.object.end]),
            compile: Twig.expression.fn.compile.push_both,
            parse: Twig.expression.fn.parse.push
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-193">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-193">&#182;</a>
              </div>
              <p>Token that represents the end of a Hash Map &#39;}&#39;</p>
<p>This is where the logic for building the internal
representation of a hash map is defined.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        {
            type: Twig.expression.type.object.end,
            regex: <span class="regexp">/^\}/</span>,
            next: Twig.expression.set.operations_extended,
            compile: <span class="function"><span class="keyword">function</span><span class="params">(token, stack, output)</span> {</span>
                <span class="keyword">var</span> i = stack.length-<span class="number">1</span>,
                    stack_token;</pre></div></div>
            
        </li>
        
        
        <li id="section-194">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-194">&#182;</a>
              </div>
              <p>pop tokens off the stack until the start of the object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">for</span>(;i &gt;= <span class="number">0</span>; i--) {
                    stack_token = stack.pop();
                    <span class="keyword">if</span> (stack_token &amp;&amp; stack_token.type === Twig.expression.type.object.start) {
                        <span class="keyword">break</span>;
                    }
                    output.push(stack_token);
                }
                output.push(token);
            },
            parse: <span class="function"><span class="keyword">function</span><span class="params">(end_token, stack, context)</span> {</span>
                <span class="keyword">var</span> new_object = {},
                    object_ended = <span class="literal">false</span>,
                    token = <span class="literal">null</span>,
                    token_key = <span class="literal">null</span>,
                    has_value = <span class="literal">false</span>,
                    value = <span class="literal">null</span>;

                <span class="keyword">while</span> (stack.length &gt; <span class="number">0</span>) {
                    token = stack.pop();</pre></div></div>
            
        </li>
        
        
        <li id="section-195">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-195">&#182;</a>
              </div>
              <p>Push values into the array until the start of the object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">if</span> (token &amp;&amp; token.type &amp;&amp; token.type === Twig.expression.type.object.start) {
                        object_ended = <span class="literal">true</span>;
                        <span class="keyword">break</span>;
                    }
                    <span class="keyword">if</span> (token &amp;&amp; token.type &amp;&amp; (token.type === Twig.expression.type.operator.binary || token.type === Twig.expression.type.operator.unary) &amp;&amp; token.key) {
                        <span class="keyword">if</span> (!has_value) {
                            <span class="keyword">throw</span> <span class="keyword">new</span> Twig.Error(<span class="string">"Missing value for key '"</span> + token.key + <span class="string">"' in object definition."</span>);
                        }
                        new_object[token.key] = value;</pre></div></div>
            
        </li>
        
        
        <li id="section-196">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-196">&#182;</a>
              </div>
              <p>Preserve the order that elements are added to the map
This is necessary since JavaScript objects don&#39;t
guarantee the order of keys</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        <span class="keyword">if</span> (new_object._keys === <span class="literal">undefined</span>) new_object._keys = [];
                        new_object._keys.unshift(token.key);</pre></div></div>
            
        </li>
        
        
        <li id="section-197">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-197">&#182;</a>
              </div>
              <p>reset value check</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        value = <span class="literal">null</span>;
                        has_value = <span class="literal">false</span>;

                    } <span class="keyword">else</span> {
                        has_value = <span class="literal">true</span>;
                        value = token;
                    }
                }
                <span class="keyword">if</span> (!object_ended) {
                    <span class="keyword">throw</span> <span class="keyword">new</span> Twig.Error(<span class="string">"Unexpected end of object."</span>);
                }

                stack.push(new_object);
            }
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-198">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-198">&#182;</a>
              </div>
              <p>Token representing a filter</p>
<p>Filters can follow any expression and take the form:
   expression|filter(optional, args)</p>
<p>Filter parsing is done in the Twig.filters namespace.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        {
            type: Twig.expression.type.filter,</pre></div></div>
            
        </li>
        
        
        <li id="section-199">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-199">&#182;</a>
              </div>
              <p>match a | then a letter or <em>, then any number of letters, numbers, </em> or -</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            regex: <span class="regexp">/^\|\s?([a-zA-Z_][a-zA-Z0-9_\-]*)/</span>,
            next: Twig.expression.set.operations_extended.concat([
                    Twig.expression.type.parameter.start]),
            compile: <span class="function"><span class="keyword">function</span><span class="params">(token, stack, output)</span> {</span>
                token.value = token.match[<span class="number">1</span>];
                output.push(token);
            },
            parse: <span class="function"><span class="keyword">function</span><span class="params">(token, stack, context)</span> {</span>
                <span class="keyword">var</span> input = stack.pop(),
                    params = token.params &amp;&amp; Twig.expression.parse.apply(<span class="keyword">this</span>, [token.params, context]);

                stack.push(Twig.filter.apply(<span class="keyword">this</span>, [token.value, input, params]));
            }
        },
        {
            type: Twig.expression.type._function,</pre></div></div>
            
        </li>
        
        
        <li id="section-200">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-200">&#182;</a>
              </div>
              <p>match any letter or <em>, then any number of letters, numbers, </em> or - followed by (</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            regex: <span class="regexp">/^([a-zA-Z_][a-zA-Z0-9_]*)\s*\(/</span>,
            next: Twig.expression.type.parameter.start,
            transform: <span class="function"><span class="keyword">function</span><span class="params">(match, tokens)</span> {</span>
                <span class="keyword">return</span> <span class="string">'('</span>;
            },
            compile: <span class="function"><span class="keyword">function</span><span class="params">(token, stack, output)</span> {</span>
                <span class="keyword">var</span> fn = token.match[<span class="number">1</span>];
                token.fn = fn;</pre></div></div>
            
        </li>
        
        
        <li id="section-201">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-201">&#182;</a>
              </div>
              <p>cleanup token</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">delete</span> token.match;
                <span class="keyword">delete</span> token.value;

                output.push(token);
            },
            parse: <span class="function"><span class="keyword">function</span><span class="params">(token, stack, context)</span> {</span>
                <span class="keyword">var</span> params = token.params &amp;&amp; Twig.expression.parse.apply(<span class="keyword">this</span>, [token.params, context]),
                    fn     = token.fn,
                    value;

                <span class="keyword">if</span> (Twig.functions[fn]) {</pre></div></div>
            
        </li>
        
        
        <li id="section-202">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-202">&#182;</a>
              </div>
              <p>Get the function from the built-in functions</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    value = Twig.functions[fn].apply(<span class="keyword">this</span>, params);

                } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> context[fn] == <span class="string">'function'</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-203">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-203">&#182;</a>
              </div>
              <p>Get the function from the user/context defined functions</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    value = context[fn].apply(context, params);

                } <span class="keyword">else</span> {
                    <span class="keyword">throw</span> <span class="keyword">new</span> Twig.Error(fn + <span class="string">' function does not exist and is not defined in the context'</span>);
                }

                stack.push(value);
            }
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-204">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-204">&#182;</a>
              </div>
              <p>Token representing a variable.</p>
<p>Variables can contain letters, numbers, underscores and
dashes, but must start with a letter or underscore.</p>
<p>Variables are retrieved from the render context and take
the value of &#39;undefined&#39; if the given variable doesn&#39;t
exist in the context.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        {
            type: Twig.expression.type.variable,</pre></div></div>
            
        </li>
        
        
        <li id="section-205">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-205">&#182;</a>
              </div>
              <p>match any letter or <em>, then any number of letters, numbers, </em> or -</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            regex: <span class="regexp">/^[a-zA-Z_][a-zA-Z0-9_]*/</span>,
            next: Twig.expression.set.operations_extended.concat([
                    Twig.expression.type.parameter.start]),
            compile: Twig.expression.fn.compile.push,
            validate: <span class="function"><span class="keyword">function</span><span class="params">(match, tokens)</span> {</span>
                <span class="keyword">return</span> (Twig.indexOf(Twig.expression.reservedWords, match[<span class="number">0</span>]) &lt; <span class="number">0</span>);
            },
            parse: <span class="function"><span class="keyword">function</span><span class="params">(token, stack, context)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-206">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-206">&#182;</a>
              </div>
              <p>Get the variable from the context</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">var</span> value = Twig.expression.resolve(context[token.value], context);
                stack.push(value);
            }
        },
        {
            type: Twig.expression.type.key.period,
            regex: <span class="regexp">/^\.([a-zA-Z0-9_]+)/</span>,
            next: Twig.expression.set.operations_extended.concat([
                    Twig.expression.type.parameter.start]),
            compile: <span class="function"><span class="keyword">function</span><span class="params">(token, stack, output)</span> {</span>
                token.key = token.match[<span class="number">1</span>];
                <span class="keyword">delete</span> token.match;
                <span class="keyword">delete</span> token.value;

                output.push(token);
            },
            parse: <span class="function"><span class="keyword">function</span><span class="params">(token, stack, context)</span> {</span>
                <span class="keyword">var</span> params = token.params &amp;&amp; Twig.expression.parse.apply(<span class="keyword">this</span>, [token.params, context]),
                    key = token.key,
                    object = stack.pop(),
                    value;

                <span class="keyword">if</span> (object === <span class="literal">null</span> || object === <span class="literal">undefined</span>) {
                    <span class="keyword">if</span> (<span class="keyword">this</span>.options.strict_variables) {
                        <span class="keyword">throw</span> <span class="keyword">new</span> Twig.Error(<span class="string">"Can't access a key "</span> + key + <span class="string">" on an null or undefined object."</span>);
                    } <span class="keyword">else</span> {
                        <span class="keyword">return</span> <span class="literal">null</span>;
                    }
                }

                <span class="keyword">var</span> capitalize = <span class="function"><span class="keyword">function</span><span class="params">(value)</span> {</span><span class="keyword">return</span> value.substr(<span class="number">0</span>, <span class="number">1</span>).toUpperCase() + value.substr(<span class="number">1</span>);};</pre></div></div>
            
        </li>
        
        
        <li id="section-207">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-207">&#182;</a>
              </div>
              <p>Get the variable from the context</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">if</span> (<span class="keyword">typeof</span> object === <span class="string">'object'</span> &amp;&amp; key <span class="keyword">in</span> object) {
                    value = object[key];
                } <span class="keyword">else</span> <span class="keyword">if</span> (object[<span class="string">"get"</span>+capitalize(key)] !== <span class="literal">undefined</span>) {
                    value = object[<span class="string">"get"</span>+capitalize(key)];
                } <span class="keyword">else</span> <span class="keyword">if</span> (object[<span class="string">"is"</span>+capitalize(key)] !== <span class="literal">undefined</span>) {
                    value = object[<span class="string">"is"</span>+capitalize(key)];
                } <span class="keyword">else</span> {
                    value = <span class="literal">null</span>;
                }
                stack.push(Twig.expression.resolve(value, object, params));
            }
        },
        {
            type: Twig.expression.type.key.brackets,
            regex: <span class="regexp">/^\[([^\]]*)\]/</span>,
            next: Twig.expression.set.operations_extended.concat([
                    Twig.expression.type.parameter.start]),
            compile: <span class="function"><span class="keyword">function</span><span class="params">(token, stack, output)</span> {</span>
                <span class="keyword">var</span> match = token.match[<span class="number">1</span>];
                <span class="keyword">delete</span> token.value;
                <span class="keyword">delete</span> token.match;</pre></div></div>
            
        </li>
        
        
        <li id="section-208">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-208">&#182;</a>
              </div>
              <p>The expression stack for the key</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                token.stack = Twig.expression.compile({
                    value: match
                }).stack;

                output.push(token);
            },
            parse: <span class="function"><span class="keyword">function</span><span class="params">(token, stack, context)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-209">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-209">&#182;</a>
              </div>
              <p>Evaluate key</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">var</span> params = token.params &amp;&amp; Twig.expression.parse.apply(<span class="keyword">this</span>, [token.params, context]),
                    key = Twig.expression.parse.apply(<span class="keyword">this</span>, [token.stack, context]),
                    object = stack.pop(),
                    value;

                <span class="keyword">if</span> (object === <span class="literal">null</span> || object === <span class="literal">undefined</span>) {
                    <span class="keyword">if</span> (<span class="keyword">this</span>.options.strict_variables) {
                        <span class="keyword">throw</span> <span class="keyword">new</span> Twig.Error(<span class="string">"Can't access a key "</span> + key + <span class="string">" on an null or undefined object."</span>);
                    } <span class="keyword">else</span> {
                        <span class="keyword">return</span> <span class="literal">null</span>;
                    }
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-210">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-210">&#182;</a>
              </div>
              <p>Get the variable from the context</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">if</span> (<span class="keyword">typeof</span> object === <span class="string">'object'</span> &amp;&amp; key <span class="keyword">in</span> object) {
                    value = object[key];
                } <span class="keyword">else</span> {
                    value = <span class="literal">null</span>;
                }
                stack.push(Twig.expression.resolve(value, object, params));
            }
        },
        {
            <span class="comment">/**
             * Match a null value.
             */</span>
            type: Twig.expression.type._null,</pre></div></div>
            
        </li>
        
        
        <li id="section-211">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-211">&#182;</a>
              </div>
              <p>match a number</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            regex: <span class="regexp">/^null/</span>,
            next: Twig.expression.set.operations,
            compile: <span class="function"><span class="keyword">function</span><span class="params">(token, stack, output)</span> {</span>
                <span class="keyword">delete</span> token.match;
                token.value = <span class="literal">null</span>;
                output.push(token);
            },
            parse: Twig.expression.fn.parse.push_value
        },
        {
            <span class="comment">/**
             * Match the context
             */</span>
            type: Twig.expression.type.context,
            regex: <span class="regexp">/^_context/</span>,
            next: Twig.expression.set.operations_extended.concat([
                    Twig.expression.type.parameter.start]),
            compile: Twig.expression.fn.compile.push,
            parse: <span class="function"><span class="keyword">function</span><span class="params">(token, stack, context)</span> {</span>
                stack.push(context);
            }
        },
        {
            <span class="comment">/**
             * Match a number (integer or decimal)
             */</span>
            type: Twig.expression.type.number,</pre></div></div>
            
        </li>
        
        
        <li id="section-212">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-212">&#182;</a>
              </div>
              <p>match a number</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            regex: <span class="regexp">/^\-?\d+(\.\d+)?/</span>,
            next: Twig.expression.set.operations,
            compile: <span class="function"><span class="keyword">function</span><span class="params">(token, stack, output)</span> {</span>
                token.value = Number(token.value);
                output.push(token);
            },
            parse: Twig.expression.fn.parse.push_value
        },
        {
            <span class="comment">/**
             * Match a boolean
             */</span>
            type: Twig.expression.type.bool,
            regex: <span class="regexp">/^(true|false)/</span>,
            next: Twig.expression.set.operations,
            compile: <span class="function"><span class="keyword">function</span><span class="params">(token, stack, output)</span> {</span>
                token.value = (token.match[<span class="number">0</span>] == <span class="string">"true"</span>);
                <span class="keyword">delete</span> token.match;
                output.push(token);
            },
            parse: Twig.expression.fn.parse.push_value
        }
    ];

    <span class="comment">/**
     * Resolve a context value.
     *
     * If the value is a function, it is executed with a context parameter.
     *
     * @param {string} key The context object key.
     * @param {Object} context The render context.
     */</span>
    Twig.expression.resolve = <span class="function"><span class="keyword">function</span><span class="params">(value, context, params)</span> {</span>
        <span class="keyword">if</span> (<span class="keyword">typeof</span> value == <span class="string">'function'</span>) {
            <span class="keyword">return</span> value.apply(context, params || []);
        } <span class="keyword">else</span> {
            <span class="keyword">return</span> value;
        }
    };

    <span class="comment">/**
     * Registry for logic handlers.
     */</span>
    Twig.expression.handler = {};

    <span class="comment">/**
     * Define a new expression type, available at Twig.logic.type.{type}
     *
     * @param {string} type The name of the new type.
     */</span>
    Twig.expression.extendType = <span class="function"><span class="keyword">function</span> <span class="params">(type)</span> {</span>
        Twig.expression.type[type] = <span class="string">"Twig.expression.type."</span> + type;
    };

    <span class="comment">/**
     * Extend the expression parsing functionality with a new definition.
     *
     * Token definitions follow this format:
     *  {
     *      type:     One of Twig.expression.type.[type], either pre-defined or added using
     *                    Twig.expression.extendType
     *
     *      next:     Array of types from Twig.expression.type that can follow this token,
     *
     *      regex:    A regex or array of regex's that should match the token.
     *
     *      compile: function(token, stack, output) called when this token is being compiled.
     *                   Should return an object with stack and output set.
     *
     *      parse:   function(token, stack, context) called when this token is being parsed.
     *                   Should return an object with stack and context set.
     *  }
     *
     * @param {Object} definition A token definition.
     */</span>
    Twig.expression.extend = <span class="function"><span class="keyword">function</span> <span class="params">(definition)</span> {</span>
        <span class="keyword">if</span> (!definition.type) {
            <span class="keyword">throw</span> <span class="keyword">new</span> Twig.Error(<span class="string">"Unable to extend logic definition. No type provided for "</span> + definition);
        }
        Twig.expression.handler[definition.type] = definition;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-213">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-213">&#182;</a>
              </div>
              <p>Extend with built-in expressions</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">while</span> (Twig.expression.definitions.length &gt; <span class="number">0</span>) {
        Twig.expression.extend(Twig.expression.definitions.shift());
    }

    <span class="comment">/**
     * Break an expression into tokens defined in Twig.expression.definitions.
     *
     * @param {string} expression The string to tokenize.
     *
     * @return {Array} An array of tokens.
     */</span>
    Twig.expression.tokenize = <span class="function"><span class="keyword">function</span> <span class="params">(expression)</span> {</span>
        <span class="keyword">var</span> tokens = [],</pre></div></div>
            
        </li>
        
        
        <li id="section-214">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-214">&#182;</a>
              </div>
              <p>Keep an offset of the location in the expression for error messages.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            exp_offset = <span class="number">0</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-215">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-215">&#182;</a>
              </div>
              <p>The valid next tokens of the previous token</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            next = <span class="literal">null</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-216">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-216">&#182;</a>
              </div>
              <p>Match information</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            type, regex, regex_array,</pre></div></div>
            
        </li>
        
        
        <li id="section-217">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-217">&#182;</a>
              </div>
              <p>The possible next token for the match</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            token_next,</pre></div></div>
            
        </li>
        
        
        <li id="section-218">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-218">&#182;</a>
              </div>
              <p>Has a match been found from the definitions</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            match_found, invalid_matches = [], match_function;

        match_function = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
            <span class="keyword">var</span> match = Array.prototype.slice.apply(arguments),
                string = match.pop(),
                offset = match.pop();

            Twig.log.trace(<span class="string">"Twig.expression.tokenize"</span>,
                           <span class="string">"Matched a "</span>, type, <span class="string">" regular expression of "</span>, match);

            <span class="keyword">if</span> (next &amp;&amp; Twig.indexOf(next, type) &lt; <span class="number">0</span>) {
                invalid_matches.push(
                    type + <span class="string">" cannot follow a "</span> + tokens[tokens.length - <span class="number">1</span>].type +
                           <span class="string">" at template:"</span> + exp_offset + <span class="string">" near '"</span> + match[<span class="number">0</span>].substring(<span class="number">0</span>, <span class="number">20</span>) +
                           <span class="string">"...'"</span>
                );</pre></div></div>
            
        </li>
        
        
        <li id="section-219">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-219">&#182;</a>
              </div>
              <p>Not a match, don&#39;t change the expression</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">return</span> match[<span class="number">0</span>];
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-220">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-220">&#182;</a>
              </div>
              <p>Validate the token if a validation function is provided</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (Twig.expression.handler[type].validate &amp;&amp;
                    !Twig.expression.handler[type].validate(match, tokens)) {
                <span class="keyword">return</span> match[<span class="number">0</span>];
            }

            invalid_matches = [];

            tokens.push({
                type:  type,
                value: match[<span class="number">0</span>],
                match: match
            });

            match_found = <span class="literal">true</span>;
            next = token_next;
            exp_offset += match[<span class="number">0</span>].length;</pre></div></div>
            
        </li>
        
        
        <li id="section-221">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-221">&#182;</a>
              </div>
              <p>Does the token need to return output back to the expression string
e.g. a function match of cycle( might return the &#39;(&#39; back to the expression
This allows look-ahead to differentiate between token types (e.g. functions and variable names)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (Twig.expression.handler[type].transform) {
                <span class="keyword">return</span> Twig.expression.handler[type].transform(match, tokens);
            }
            <span class="keyword">return</span> <span class="string">''</span>;
        };

        Twig.log.debug(<span class="string">"Twig.expression.tokenize"</span>, <span class="string">"Tokenizing expression "</span>, expression);

        <span class="keyword">while</span> (expression.length &gt; <span class="number">0</span>) {
            expression = expression.trim();
            <span class="keyword">for</span> (type <span class="keyword">in</span> Twig.expression.handler) {
                <span class="keyword">if</span> (Twig.expression.handler.hasOwnProperty(type)) {
                    token_next = Twig.expression.handler[type].next;
                    regex = Twig.expression.handler[type].regex;</pre></div></div>
            
        </li>
        
        
        <li id="section-222">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-222">&#182;</a>
              </div>
              <p>Twig.log.trace(&quot;Checking type &quot;, type, &quot; on &quot;, expression);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">if</span> (regex <span class="keyword">instanceof</span> Array) {
                        regex_array = regex;
                    } <span class="keyword">else</span> {
                        regex_array = [regex];
                    }

                    match_found = <span class="literal">false</span>;
                    <span class="keyword">while</span> (regex_array.length &gt; <span class="number">0</span>) {
                        regex = regex_array.pop();
                        expression = expression.replace(regex, match_function);
                    }</pre></div></div>
            
        </li>
        
        
        <li id="section-223">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-223">&#182;</a>
              </div>
              <p>An expression token has been matched. Break the for loop and start trying to
 match the next template (if expression isn&#39;t empty.)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">if</span> (match_found) {
                        <span class="keyword">break</span>;
                    }
                }
            }
            <span class="keyword">if</span> (!match_found) {
                <span class="keyword">if</span> (invalid_matches.length &gt; <span class="number">0</span>) {
                    <span class="keyword">throw</span> <span class="keyword">new</span> Twig.Error(invalid_matches.join(<span class="string">" OR "</span>));
                } <span class="keyword">else</span> {
                    <span class="keyword">throw</span> <span class="keyword">new</span> Twig.Error(<span class="string">"Unable to parse '"</span> + expression + <span class="string">"' at template position"</span> + exp_offset);
                }
            }
        }

        Twig.log.trace(<span class="string">"Twig.expression.tokenize"</span>, <span class="string">"Tokenized to "</span>, tokens);
        <span class="keyword">return</span> tokens;
    };

    <span class="comment">/**
     * Compile an expression token.
     *
     * @param {Object} raw_token The uncompiled token.
     *
     * @return {Object} The compiled token.
     */</span>
    Twig.expression.compile = <span class="function"><span class="keyword">function</span> <span class="params">(raw_token)</span> {</span>
        <span class="keyword">var</span> expression = raw_token.value,</pre></div></div>
            
        </li>
        
        
        <li id="section-224">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-224">&#182;</a>
              </div>
              <p>Tokenize expression</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            tokens = Twig.expression.tokenize(expression),
            token = <span class="literal">null</span>,
            output = [],
            stack = [],
            token_template = <span class="literal">null</span>;

        Twig.log.trace(<span class="string">"Twig.expression.compile: "</span>, <span class="string">"Compiling "</span>, expression);</pre></div></div>
            
        </li>
        
        
        <li id="section-225">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-225">&#182;</a>
              </div>
              <p>Push tokens into RPN stack using the Sunting-yard algorithm
See <a href="http://en.wikipedia.org/wiki/Shunting_yard_algorithm">http://en.wikipedia.org/wiki/Shunting_yard_algorithm</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">while</span> (tokens.length &gt; <span class="number">0</span>) {
            token = tokens.shift();
            token_template = Twig.expression.handler[token.type];

            Twig.log.trace(<span class="string">"Twig.expression.compile: "</span>, <span class="string">"Compiling "</span>, token);</pre></div></div>
            
        </li>
        
        
        <li id="section-226">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-226">&#182;</a>
              </div>
              <p>Compile the template</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            token_template.compile &amp;&amp; token_template.compile(token, stack, output);

            Twig.log.trace(<span class="string">"Twig.expression.compile: "</span>, <span class="string">"Stack is"</span>, stack);
            Twig.log.trace(<span class="string">"Twig.expression.compile: "</span>, <span class="string">"Output is"</span>, output);
        }

        <span class="keyword">while</span>(stack.length &gt; <span class="number">0</span>) {
            output.push(stack.pop());
        }

        Twig.log.trace(<span class="string">"Twig.expression.compile: "</span>, <span class="string">"Final output is"</span>, output);

        raw_token.stack = output;
        <span class="keyword">delete</span> raw_token.value;

        <span class="keyword">return</span> raw_token;
    };


    <span class="comment">/**
     * Parse an RPN expression stack within a context.
     *
     * @param {Array} tokens An array of compiled expression tokens.
     * @param {Object} context The render context to parse the tokens with.
     *
     * @return {Object} The result of parsing all the tokens. The result
     *                  can be anything, String, Array, Object, etc... based on
     *                  the given expression.
     */</span>
    Twig.expression.parse = <span class="function"><span class="keyword">function</span> <span class="params">(tokens, context)</span> {</span>
        <span class="keyword">var</span> that = <span class="keyword">this</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-227">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-227">&#182;</a>
              </div>
              <p>If the token isn&#39;t an array, make it one.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (!(tokens <span class="keyword">instanceof</span> Array)) {
            tokens = [tokens];
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-228">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-228">&#182;</a>
              </div>
              <p>The output stack</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> stack = [],
            token_template = <span class="literal">null</span>;

        Twig.forEach(tokens, <span class="function"><span class="keyword">function</span> <span class="params">(token)</span> {</span>
            token_template = Twig.expression.handler[token.type];

            token_template.parse &amp;&amp; token_template.parse.apply(that, [token, stack, context]);
        });</pre></div></div>
            
        </li>
        
        
        <li id="section-229">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-229">&#182;</a>
              </div>
              <p>Pop the final value off the stack</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">return</span> stack.pop();
    };

    <span class="keyword">return</span> Twig;

})( Twig || { } );</pre></div></div>
            
        </li>
        
        
        <li id="section-230">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-230">&#182;</a>
              </div>
              <pre><code>Twig.js
Copyright (c) 2011-2013 John Roepke
Available under the BSD 2-Clause License
https://github.com/justjohn/twig.js</code></pre>
<h2 id="twig-expression-operator-js">twig.expression.operator.js</h2>
<p>This file handles operator lookups and parsing.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> Twig = (<span class="function"><span class="keyword">function</span> <span class="params">(Twig)</span> {</span>
    <span class="string">"use strict"</span>;

    <span class="comment">/**
     * Operator associativity constants.
     */</span>
    Twig.expression.operator = {
        leftToRight: <span class="string">'leftToRight'</span>,
        rightToLeft: <span class="string">'rightToLeft'</span>
    };

    <span class="keyword">var</span> containment = <span class="function"><span class="keyword">function</span><span class="params">(a, b)</span> {</span>
        <span class="keyword">if</span> (b.indexOf !== <span class="literal">undefined</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-231">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-231">&#182;</a>
              </div>
              <p>String</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">return</span> a === b || a !== <span class="string">''</span> &amp;&amp; b.indexOf(a) &gt; -<span class="number">1</span>;

        } <span class="keyword">else</span> {
            <span class="keyword">var</span> el;
            <span class="keyword">for</span> (el <span class="keyword">in</span> b) {
                <span class="keyword">if</span> (b.hasOwnProperty(el) &amp;&amp; b[el] === a) {
                    <span class="keyword">return</span> <span class="literal">true</span>;
                }
            }
            <span class="keyword">return</span> <span class="literal">false</span>;
        }
    };

    <span class="comment">/**
     * Get the precidence and associativity of an operator. These follow the order that C/C++ use.
     * See http://en.wikipedia.org/wiki/Operators_in_C_and_C++ for the table of values.
     */</span>
    Twig.expression.operator.lookup = <span class="function"><span class="keyword">function</span> <span class="params">(operator, token)</span> {</span>
        <span class="keyword">switch</span> (operator) {
            <span class="keyword">case</span> <span class="string">".."</span>:
            <span class="keyword">case</span> <span class="string">'not in'</span>:
            <span class="keyword">case</span> <span class="string">'in'</span>:
                token.precidence = <span class="number">20</span>;
                token.associativity = Twig.expression.operator.leftToRight;
                <span class="keyword">break</span>;

            <span class="keyword">case</span> <span class="string">','</span>:
                token.precidence = <span class="number">18</span>;
                token.associativity = Twig.expression.operator.leftToRight;
                <span class="keyword">break</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-232">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-232">&#182;</a>
              </div>
              <p>Ternary</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">case</span> <span class="string">'?'</span>:
            <span class="keyword">case</span> <span class="string">':'</span>:
                token.precidence = <span class="number">16</span>;
                token.associativity = Twig.expression.operator.rightToLeft;
                <span class="keyword">break</span>;

            <span class="keyword">case</span> <span class="string">'or'</span>:
                token.precidence = <span class="number">14</span>;
                token.associativity = Twig.expression.operator.leftToRight;
                <span class="keyword">break</span>;

            <span class="keyword">case</span> <span class="string">'and'</span>:
                token.precidence = <span class="number">13</span>;
                token.associativity = Twig.expression.operator.leftToRight;
                <span class="keyword">break</span>;

            <span class="keyword">case</span> <span class="string">'=='</span>:
            <span class="keyword">case</span> <span class="string">'!='</span>:
                token.precidence = <span class="number">9</span>;
                token.associativity = Twig.expression.operator.leftToRight;
                <span class="keyword">break</span>;

            <span class="keyword">case</span> <span class="string">'&lt;'</span>:
            <span class="keyword">case</span> <span class="string">'&lt;='</span>:
            <span class="keyword">case</span> <span class="string">'&gt;'</span>:
            <span class="keyword">case</span> <span class="string">'&gt;='</span>:
                token.precidence = <span class="number">8</span>;
                token.associativity = Twig.expression.operator.leftToRight;
                <span class="keyword">break</span>;


            <span class="keyword">case</span> <span class="string">'~'</span>: <span class="comment">// String concatination</span>
            <span class="keyword">case</span> <span class="string">'+'</span>:
            <span class="keyword">case</span> <span class="string">'-'</span>:
                token.precidence = <span class="number">6</span>;
                token.associativity = Twig.expression.operator.leftToRight;
                <span class="keyword">break</span>;

            <span class="keyword">case</span> <span class="string">'//'</span>:
            <span class="keyword">case</span> <span class="string">'**'</span>:
            <span class="keyword">case</span> <span class="string">'*'</span>:
            <span class="keyword">case</span> <span class="string">'/'</span>:
            <span class="keyword">case</span> <span class="string">'%'</span>:
                token.precidence = <span class="number">5</span>;
                token.associativity = Twig.expression.operator.leftToRight;
                <span class="keyword">break</span>;

            <span class="keyword">case</span> <span class="string">'not'</span>:
                token.precidence = <span class="number">3</span>;
                token.associativity = Twig.expression.operator.rightToLeft;
                <span class="keyword">break</span>;

            <span class="keyword">default</span>:
                <span class="keyword">throw</span> <span class="keyword">new</span> Twig.Error(operator + <span class="string">" is an unknown operator."</span>);
        }
        token.operator = operator;
        <span class="keyword">return</span> token;
    };

    <span class="comment">/**
     * Handle operations on the RPN stack.
     *
     * Returns the updated stack.
     */</span>
    Twig.expression.operator.parse = <span class="function"><span class="keyword">function</span> <span class="params">(operator, stack)</span> {</span>
        Twig.log.trace(<span class="string">"Twig.expression.operator.parse: "</span>, <span class="string">"Handling "</span>, operator);
        <span class="keyword">var</span> a, b, c;
        <span class="keyword">switch</span> (operator) {
            <span class="keyword">case</span> <span class="string">':'</span>:</pre></div></div>
            
        </li>
        
        
        <li id="section-233">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-233">&#182;</a>
              </div>
              <p>Ignore</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">break</span>;

            <span class="keyword">case</span> <span class="string">'?'</span>:
                c = stack.pop(); <span class="comment">// false expr</span>
                b = stack.pop(); <span class="comment">// true expr</span>
                a = stack.pop(); <span class="comment">// conditional</span>
                <span class="keyword">if</span> (a) {
                    stack.push(b);
                } <span class="keyword">else</span> {
                    stack.push(c);
                }
                <span class="keyword">break</span>;

            <span class="keyword">case</span> <span class="string">'+'</span>:
                b = parseFloat(stack.pop());
                a = parseFloat(stack.pop());
                stack.push(a + b);
                <span class="keyword">break</span>;

            <span class="keyword">case</span> <span class="string">'-'</span>:
                b = parseFloat(stack.pop());
                a = parseFloat(stack.pop());
                stack.push(a - b);
                <span class="keyword">break</span>;

            <span class="keyword">case</span> <span class="string">'*'</span>:
                b = parseFloat(stack.pop());
                a = parseFloat(stack.pop());
                stack.push(a * b);
                <span class="keyword">break</span>;

            <span class="keyword">case</span> <span class="string">'/'</span>:
                b = parseFloat(stack.pop());
                a = parseFloat(stack.pop());
                stack.push(a / b);
                <span class="keyword">break</span>;

            <span class="keyword">case</span> <span class="string">'//'</span>:
                b = parseFloat(stack.pop());
                a = parseFloat(stack.pop());
                stack.push(parseInt(a / b));
                <span class="keyword">break</span>;

            <span class="keyword">case</span> <span class="string">'%'</span>:
                b = parseFloat(stack.pop());
                a = parseFloat(stack.pop());
                stack.push(a % b);
                <span class="keyword">break</span>;

            <span class="keyword">case</span> <span class="string">'~'</span>:
                b = stack.pop();
                a = stack.pop();
                stack.push( (a !== <span class="literal">undefined</span> ? a.toString() : <span class="string">""</span>)
                          + (b !== <span class="literal">undefined</span> ? b.toString() : <span class="string">""</span>) );
                <span class="keyword">break</span>;

            <span class="keyword">case</span> <span class="string">'not'</span>:
            <span class="keyword">case</span> <span class="string">'!'</span>:
                stack.push(!stack.pop());
                <span class="keyword">break</span>;

            <span class="keyword">case</span> <span class="string">'&lt;'</span>:
                b = stack.pop();
                a = stack.pop();
                stack.push(a &lt; b);
                <span class="keyword">break</span>;

            <span class="keyword">case</span> <span class="string">'&lt;='</span>:
                b = stack.pop();
                a = stack.pop();
                stack.push(a &lt;= b);
                <span class="keyword">break</span>;

            <span class="keyword">case</span> <span class="string">'&gt;'</span>:
                b = stack.pop();
                a = stack.pop();
                stack.push(a &gt; b);
                <span class="keyword">break</span>;

            <span class="keyword">case</span> <span class="string">'&gt;='</span>:
                b = stack.pop();
                a = stack.pop();
                stack.push(a &gt;= b);
                <span class="keyword">break</span>;

            <span class="keyword">case</span> <span class="string">'==='</span>:
                b = stack.pop();
                a = stack.pop();
                stack.push(a === b);
                <span class="keyword">break</span>;

            <span class="keyword">case</span> <span class="string">'=='</span>:
                b = stack.pop();
                a = stack.pop();
                stack.push(a == b);
                <span class="keyword">break</span>;

            <span class="keyword">case</span> <span class="string">'!=='</span>:
                b = stack.pop();
                a = stack.pop();
                stack.push(a !== b);
                <span class="keyword">break</span>;

            <span class="keyword">case</span> <span class="string">'!='</span>:
                b = stack.pop();
                a = stack.pop();
                stack.push(a != b);
                <span class="keyword">break</span>;

            <span class="keyword">case</span> <span class="string">'or'</span>:
                b = stack.pop();
                a = stack.pop();
                stack.push(a || b);
                <span class="keyword">break</span>;

            <span class="keyword">case</span> <span class="string">'and'</span>:
                b = stack.pop();
                a = stack.pop();
                stack.push(a &amp;&amp; b);
                <span class="keyword">break</span>;

            <span class="keyword">case</span> <span class="string">'**'</span>:
                b = stack.pop();
                a = stack.pop();
                stack.push(Math.pow(a, b));
                <span class="keyword">break</span>;


            <span class="keyword">case</span> <span class="string">'not in'</span>:
                b = stack.pop();
                a = stack.pop();
                stack.push( !containment(a, b) );
                <span class="keyword">break</span>;

            <span class="keyword">case</span> <span class="string">'in'</span>:
                b = stack.pop();
                a = stack.pop();
                stack.push( containment(a, b) );
                <span class="keyword">break</span>;

            <span class="keyword">case</span> <span class="string">'..'</span>:
                b = stack.pop();
                a = stack.pop();
                stack.push( Twig.functions.range(a, b) );
                <span class="keyword">break</span>;

            <span class="keyword">default</span>:
                <span class="keyword">throw</span> <span class="keyword">new</span> Twig.Error(operator + <span class="string">" is an unknown operator."</span>);
        }
    };

    <span class="keyword">return</span> Twig;

})( Twig || { } );</pre></div></div>
            
        </li>
        
        
        <li id="section-234">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-234">&#182;</a>
              </div>
              <pre><code>Twig.js
Copyright (c) 2011-2013 John Roepke
Available under the BSD 2-Clause License
https://github.com/justjohn/twig.js</code></pre>
<h2 id="twig-filters-js">twig.filters.js</h2>
<p>This file handles parsing filters.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> Twig = (<span class="function"><span class="keyword">function</span> <span class="params">(Twig)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-235">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-235">&#182;</a>
              </div>
              <p>Determine object type</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="function"><span class="keyword">function</span> <span class="title">is</span><span class="params">(type, obj)</span> {</span>
        <span class="keyword">var</span> clas = Object.prototype.toString.call(obj).slice(<span class="number">8</span>, -<span class="number">1</span>);
        <span class="keyword">return</span> obj !== <span class="literal">undefined</span> &amp;&amp; obj !== <span class="literal">null</span> &amp;&amp; clas === type;
    }

    Twig.filters = {</pre></div></div>
            
        </li>
        
        
        <li id="section-236">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-236">&#182;</a>
              </div>
              <p>String Filters</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        upper:  <span class="function"><span class="keyword">function</span><span class="params">(value)</span> {</span>
            <span class="keyword">if</span> ( <span class="keyword">typeof</span> value !== <span class="string">"string"</span> ) {
               <span class="keyword">return</span> value;
            }

            <span class="keyword">return</span> value.toUpperCase();
        },
        lower: <span class="function"><span class="keyword">function</span><span class="params">(value)</span> {</span>
            <span class="keyword">if</span> ( <span class="keyword">typeof</span> value !== <span class="string">"string"</span> ) {
               <span class="keyword">return</span> value;
            }

            <span class="keyword">return</span> value.toLowerCase();
        },
        capitalize: <span class="function"><span class="keyword">function</span><span class="params">(value)</span> {</span>
            <span class="keyword">if</span> ( <span class="keyword">typeof</span> value !== <span class="string">"string"</span> ) {
                 <span class="keyword">return</span> value;
            }

            <span class="keyword">return</span> value.substr(<span class="number">0</span>, <span class="number">1</span>).toUpperCase() + value.substr(<span class="number">1</span>);
        },
        title: <span class="function"><span class="keyword">function</span><span class="params">(value)</span> {</span>
            <span class="keyword">if</span> ( <span class="keyword">typeof</span> value !== <span class="string">"string"</span> ) {
               <span class="keyword">return</span> value;
            }

            <span class="keyword">return</span> value.replace( <span class="regexp">/(^|\s)([a-z])/g</span> , <span class="function"><span class="keyword">function</span><span class="params">(m, p1, p2)</span>{</span>
                <span class="keyword">return</span> p1 + p2.toUpperCase();
            });
        },
        length: <span class="function"><span class="keyword">function</span><span class="params">(value)</span> {</span>
            <span class="keyword">if</span> (value <span class="keyword">instanceof</span> Array || <span class="keyword">typeof</span> value === <span class="string">"string"</span>) {
                <span class="keyword">return</span> value.length;
            } <span class="keyword">else</span> <span class="keyword">if</span> (value <span class="keyword">instanceof</span> Object) {
                <span class="keyword">if</span> (value._keys === <span class="literal">undefined</span>) {
                    <span class="keyword">return</span> Object.keys(value).length;
                } <span class="keyword">else</span> {
                    <span class="keyword">return</span> value._keys.length;
                }
            } <span class="keyword">else</span> {
                <span class="keyword">return</span> <span class="number">0</span>;
            }
        },</pre></div></div>
            
        </li>
        
        
        <li id="section-237">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-237">&#182;</a>
              </div>
              <p>Array/Object Filters</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        reverse: <span class="function"><span class="keyword">function</span><span class="params">(value)</span> {</span>
            <span class="keyword">if</span> (is(<span class="string">"Array"</span>, value)) {
                <span class="keyword">return</span> value.reverse();
            } <span class="keyword">else</span> <span class="keyword">if</span> (is(<span class="string">"String"</span>, value)) {
                <span class="keyword">return</span> value.split(<span class="string">""</span>).reverse().join(<span class="string">""</span>);
            } <span class="keyword">else</span> <span class="keyword">if</span> (value <span class="keyword">instanceof</span> Object) {
                <span class="keyword">var</span> keys = value._keys || Object.keys(value).reverse();
                value._keys = keys;
                <span class="keyword">return</span> value;
            }
        },
        sort: <span class="function"><span class="keyword">function</span><span class="params">(value)</span> {</span>
            <span class="keyword">if</span> (is(<span class="string">"Array"</span>, value)) {
                <span class="keyword">return</span> value.sort();
            } <span class="keyword">else</span> <span class="keyword">if</span> (value <span class="keyword">instanceof</span> Object) {</pre></div></div>
            
        </li>
        
        
        <li id="section-238">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-238">&#182;</a>
              </div>
              <p>Sorting objects isn&#39;t obvious since the order of
returned keys isn&#39;t guaranteedin JavaScript.
Because of this we use a &quot;hidden&quot; key called _keys to
store the keys in the order we want to return them.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="keyword">delete</span> value._keys;
                <span class="keyword">var</span> keys = Object.keys(value),
                    sorted_keys = keys.sort(<span class="function"><span class="keyword">function</span><span class="params">(a, b)</span> {</span>
                        <span class="keyword">return</span> value[a] &gt; value[b];
                    });
                value._keys = sorted_keys;
                <span class="keyword">return</span> value;
            }
        },
        keys: <span class="function"><span class="keyword">function</span><span class="params">(value)</span> {</span>
            <span class="keyword">if</span> (value === <span class="literal">undefined</span> || value === <span class="literal">null</span>){
                <span class="keyword">return</span>;
           }

            <span class="keyword">var</span> keyset = value._keys || Object.keys(value),
                output = [];

            Twig.forEach(keyset, <span class="function"><span class="keyword">function</span><span class="params">(key)</span> {</span>
                <span class="keyword">if</span> (key === <span class="string">"_keys"</span>) <span class="keyword">return</span>; <span class="comment">// Ignore the _keys property</span>
                <span class="keyword">if</span> (value.hasOwnProperty(key)) {
                    output.push(key);
                }
            });
            <span class="keyword">return</span> output;
        },
        url_encode: <span class="function"><span class="keyword">function</span><span class="params">(value)</span> {</span>
            <span class="keyword">if</span> (value === <span class="literal">undefined</span> || value === <span class="literal">null</span>){
                <span class="keyword">return</span>;
            }

            <span class="keyword">return</span> encodeURIComponent(value);
        },
        join: <span class="function"><span class="keyword">function</span><span class="params">(value, params)</span> {</span>
            <span class="keyword">if</span> (value === <span class="literal">undefined</span> || value === <span class="literal">null</span>){
                <span class="keyword">return</span>;
            }

            <span class="keyword">var</span> join_str = <span class="string">""</span>,
                output = [],
                keyset = <span class="literal">null</span>;

            <span class="keyword">if</span> (params &amp;&amp; params[<span class="number">0</span>]) {
                join_str = params[<span class="number">0</span>];
            }
            <span class="keyword">if</span> (value <span class="keyword">instanceof</span> Array) {
                output = value;
            } <span class="keyword">else</span> {
                keyset = value._keys || Object.keys(value);
                Twig.forEach(keyset, <span class="function"><span class="keyword">function</span><span class="params">(key)</span> {</span>
                    <span class="keyword">if</span> (key === <span class="string">"_keys"</span>) <span class="keyword">return</span>; <span class="comment">// Ignore the _keys property</span>
                    <span class="keyword">if</span> (value.hasOwnProperty(key)) {
                        output.push(value[key]);
                    }
                });
            }
            <span class="keyword">return</span> output.join(join_str);
        },
        <span class="string">"default"</span>: <span class="function"><span class="keyword">function</span><span class="params">(value, params)</span> {</span>
            <span class="keyword">if</span> (params === <span class="literal">undefined</span> || params.length !== <span class="number">1</span>) {
                <span class="keyword">throw</span> <span class="keyword">new</span> Twig.Error(<span class="string">"default filter expects one argument"</span>);
            }
            <span class="keyword">if</span> (value === <span class="literal">undefined</span> || value === <span class="literal">null</span> || value === <span class="string">''</span> ) {
                <span class="keyword">return</span> params[<span class="number">0</span>];
            } <span class="keyword">else</span> {
                <span class="keyword">return</span> value;
            }
        },
        json_encode: <span class="function"><span class="keyword">function</span><span class="params">(value)</span> {</span>
            <span class="keyword">if</span> (value &amp;&amp; value.hasOwnProperty( <span class="string">"_keys"</span> ) ) {
                <span class="keyword">delete</span> value._keys;
            }
            <span class="keyword">if</span>(value === <span class="literal">undefined</span> || value === <span class="literal">null</span>) {
                <span class="keyword">return</span> <span class="string">"null"</span>;
            }
            <span class="keyword">return</span> JSON.stringify(value);
        },
        merge: <span class="function"><span class="keyword">function</span><span class="params">(value, params)</span> {</span>
            <span class="keyword">var</span> obj = [],
                arr_index = <span class="number">0</span>,
                keyset = [];</pre></div></div>
            
        </li>
        
        
        <li id="section-239">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-239">&#182;</a>
              </div>
              <p>Check to see if all the objects being merged are arrays</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (!(value <span class="keyword">instanceof</span> Array)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-240">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-240">&#182;</a>
              </div>
              <p>Create obj as an Object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                obj = { };
            } <span class="keyword">else</span> {
                Twig.forEach(params, <span class="function"><span class="keyword">function</span><span class="params">(param)</span> {</span>
                    <span class="keyword">if</span> (!(param <span class="keyword">instanceof</span> Array)) {
                        obj = { };
                    }
                });
            }
            <span class="keyword">if</span> (!(obj <span class="keyword">instanceof</span> Array)) {
                obj._keys = [];
            }

            <span class="keyword">if</span> (value <span class="keyword">instanceof</span> Array) {
                Twig.forEach(value, <span class="function"><span class="keyword">function</span><span class="params">(val)</span> {</span>
                    <span class="keyword">if</span> (obj._keys) obj._keys.push(arr_index);
                    obj[arr_index] = val;
                    arr_index++;
                });
            } <span class="keyword">else</span> {
                keyset = value._keys || Object.keys(value);
                Twig.forEach(keyset, <span class="function"><span class="keyword">function</span><span class="params">(key)</span> {</span>
                    obj[key] = value[key];
                    obj._keys.push(key);</pre></div></div>
            
        </li>
        
        
        <li id="section-241">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-241">&#182;</a>
              </div>
              <p>Handle edge case where a number index in an object is greater than
  the array counter. In such a case, the array counter is increased
  one past the index.</p>
<p>Example {{ [&quot;a&quot;, &quot;b&quot;]|merge({&quot;4&quot;:&quot;value&quot;}, [&quot;c&quot;, &quot;d&quot;])
Without this, d would have an index of &quot;4&quot; and overwrite the value
  of &quot;value&quot;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="keyword">var</span> int_key = parseInt(key, <span class="number">10</span>);
                    <span class="keyword">if</span> (!isNaN(int_key) &amp;&amp; int_key &gt;= arr_index) {
                        arr_index = int_key + <span class="number">1</span>;
                    }
                });
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-242">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-242">&#182;</a>
              </div>
              <p>mixin the merge arrays</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            Twig.forEach(params, <span class="function"><span class="keyword">function</span><span class="params">(param)</span> {</span>
                <span class="keyword">if</span> (param <span class="keyword">instanceof</span> Array) {
                    Twig.forEach(param, <span class="function"><span class="keyword">function</span><span class="params">(val)</span> {</span>
                        <span class="keyword">if</span> (obj._keys) obj._keys.push(arr_index);
                        obj[arr_index] = val;
                        arr_index++;
                    });
                } <span class="keyword">else</span> {
                    keyset = param._keys || Object.keys(param);
                    Twig.forEach(keyset, <span class="function"><span class="keyword">function</span><span class="params">(key)</span> {</span>
                        <span class="keyword">if</span> (!obj[key]) obj._keys.push(key);
                        obj[key] = param[key];

                        <span class="keyword">var</span> int_key = parseInt(key, <span class="number">10</span>);
                        <span class="keyword">if</span> (!isNaN(int_key) &amp;&amp; int_key &gt;= arr_index) {
                            arr_index = int_key + <span class="number">1</span>;
                        }
                    });
                }
            });
            <span class="keyword">if</span> (params.length === <span class="number">0</span>) {
                <span class="keyword">throw</span> <span class="keyword">new</span> Twig.Error(<span class="string">"Filter merge expects at least one parameter"</span>);
            }

            <span class="keyword">return</span> obj;
        },
        date: <span class="function"><span class="keyword">function</span><span class="params">(value, params)</span> {</span>
            <span class="keyword">if</span> (value === <span class="literal">undefined</span>||value === <span class="literal">null</span>){
                <span class="keyword">return</span>;
            }

            <span class="keyword">var</span> date = Twig.functions.date(value);
            <span class="keyword">return</span> Twig.lib.formatDate(date, params[<span class="number">0</span>]);
        },

        date_modify: <span class="function"><span class="keyword">function</span><span class="params">(value, params)</span> {</span>
            <span class="keyword">if</span> (value === <span class="literal">undefined</span> || value === <span class="literal">null</span>) {
                <span class="keyword">return</span>;
            }
            <span class="keyword">if</span> (params === <span class="literal">undefined</span> || params.length !== <span class="number">1</span>) {
                <span class="keyword">throw</span> <span class="keyword">new</span> Twig.Error(<span class="string">"date_modify filter expects 1 argument"</span>);
            }

            <span class="keyword">var</span> modifyText = params[<span class="number">0</span>], time;

            <span class="keyword">if</span> (Twig.lib.is(<span class="string">"Date"</span>, value)) {
                time = Twig.lib.strtotime(modifyText, value.getTime() / <span class="number">1000</span>);
            }
            <span class="keyword">if</span> (Twig.lib.is(<span class="string">"String"</span>, value)) {
                time = Twig.lib.strtotime(modifyText, Twig.lib.strtotime(value));
            }
            <span class="keyword">if</span> (Twig.lib.is(<span class="string">"Number"</span>, value)) {
                time = Twig.lib.strtotime(modifyText, value);
            }

            <span class="keyword">return</span> <span class="keyword">new</span> Date(time * <span class="number">1000</span>);
        },

        replace: <span class="function"><span class="keyword">function</span><span class="params">(value, params)</span> {</span>
            <span class="keyword">if</span> (value === <span class="literal">undefined</span>||value === <span class="literal">null</span>){
                <span class="keyword">return</span>;
            }

            <span class="keyword">var</span> pairs = params[<span class="number">0</span>],
                tag;
            <span class="keyword">for</span> (tag <span class="keyword">in</span> pairs) {
                <span class="keyword">if</span> (pairs.hasOwnProperty(tag) &amp;&amp; tag !== <span class="string">"_keys"</span>) {
                    value = Twig.lib.replaceAll(value, tag, pairs[tag]);
                }
            }
            <span class="keyword">return</span> value;
        },

        format: <span class="function"><span class="keyword">function</span><span class="params">(value, params)</span> {</span>
            <span class="keyword">if</span> (value === <span class="literal">undefined</span> || value === <span class="literal">null</span>){
                <span class="keyword">return</span>;
            }

            <span class="keyword">return</span> Twig.lib.vsprintf(value, params);
        },

        striptags: <span class="function"><span class="keyword">function</span><span class="params">(value)</span> {</span>
            <span class="keyword">if</span> (value === <span class="literal">undefined</span> || value === <span class="literal">null</span>){
                <span class="keyword">return</span>;
            }

            <span class="keyword">return</span> Twig.lib.strip_tags(value);
        },

        escape: <span class="function"><span class="keyword">function</span><span class="params">(value)</span> {</span>
            <span class="keyword">if</span> (value === <span class="literal">undefined</span>|| value === <span class="literal">null</span>){
                <span class="keyword">return</span>;
            }
            <span class="keyword">return</span> value.toString().replace(<span class="regexp">/&amp;/g</span>, <span class="string">"&amp;amp;"</span>)
                        .replace(<span class="regexp">/&lt;/g</span>, <span class="string">"&amp;lt;"</span>)
                        .replace(<span class="regexp">/&gt;/g</span>, <span class="string">"&amp;gt;"</span>)
                        .replace(<span class="regexp">/"/g</span>, <span class="string">"&amp;quot;"</span>)
                        .replace(<span class="regexp">/'/g</span>, <span class="string">"&amp;#039;"</span>);
        },

        <span class="comment">/* Alias of escape */</span>
        <span class="string">"e"</span>: <span class="function"><span class="keyword">function</span><span class="params">(value)</span> {</span>
            <span class="keyword">return</span> Twig.filters.escape(value);
        },

        nl2br: <span class="function"><span class="keyword">function</span><span class="params">(value)</span> {</span>
            <span class="keyword">if</span> (value === <span class="literal">undefined</span> || value === <span class="literal">null</span>){
                <span class="keyword">return</span>;
            }
            <span class="keyword">var</span> linebreak_tag = <span class="string">"BACKSLASH_n_replace"</span>,
                br = <span class="string">"&lt;br /&gt;"</span> + linebreak_tag;

            value = Twig.filters.escape(value)
                        .replace(<span class="regexp">/\r\n/g</span>, br)
                        .replace(<span class="regexp">/\r/g</span>, br)
                        .replace(<span class="regexp">/\n/g</span>, br);

            <span class="keyword">return</span> Twig.lib.replaceAll(value, linebreak_tag, <span class="string">"\n"</span>);
        },

        <span class="comment">/**
         * Adapted from: http://phpjs.org/functions/number_format:481
         */</span>
        number_format: <span class="function"><span class="keyword">function</span><span class="params">(value, params)</span> {</span>
            <span class="keyword">var</span> number = value,
                decimals = (params &amp;&amp; params[<span class="number">0</span>]) ? params[<span class="number">0</span>] : <span class="literal">undefined</span>,
                dec      = (params &amp;&amp; params[<span class="number">1</span>] !== <span class="literal">undefined</span>) ? params[<span class="number">1</span>] : <span class="string">"."</span>,
                sep      = (params &amp;&amp; params[<span class="number">2</span>] !== <span class="literal">undefined</span>) ? params[<span class="number">2</span>] : <span class="string">","</span>;

            number = (number + <span class="string">''</span>).replace(<span class="regexp">/[^0-9+\-Ee.]/g</span>, <span class="string">''</span>);
            <span class="keyword">var</span> n = !isFinite(+number) ? <span class="number">0</span> : +number,
                prec = !isFinite(+decimals) ? <span class="number">0</span> : Math.abs(decimals),
                s = <span class="string">''</span>,
                toFixedFix = <span class="function"><span class="keyword">function</span> <span class="params">(n, prec)</span> {</span>
                    <span class="keyword">var</span> k = Math.pow(<span class="number">10</span>, prec);
                    <span class="keyword">return</span> <span class="string">''</span> + Math.round(n * k) / k;
                };</pre></div></div>
            
        </li>
        
        
        <li id="section-243">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-243">&#182;</a>
              </div>
              <p>Fix for IE parseFloat(0.55).toFixed(0) = 0;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            s = (prec ? toFixedFix(n, prec) : <span class="string">''</span> + Math.round(n)).split(<span class="string">'.'</span>);
            <span class="keyword">if</span> (s[<span class="number">0</span>].length &gt; <span class="number">3</span>) {
                s[<span class="number">0</span>] = s[<span class="number">0</span>].replace(<span class="regexp">/\B(?=(?:\d{3})+(?!\d))/g</span>, sep);
            }
            <span class="keyword">if</span> ((s[<span class="number">1</span>] || <span class="string">''</span>).length &lt; prec) {
                s[<span class="number">1</span>] = s[<span class="number">1</span>] || <span class="string">''</span>;
                s[<span class="number">1</span>] += <span class="keyword">new</span> Array(prec - s[<span class="number">1</span>].length + <span class="number">1</span>).join(<span class="string">'0'</span>);
            }
            <span class="keyword">return</span> s.join(dec);
        },

        trim: <span class="function"><span class="keyword">function</span><span class="params">(value, params)</span> {</span>
            <span class="keyword">if</span> (value === <span class="literal">undefined</span>|| value === <span class="literal">null</span>){
                <span class="keyword">return</span>;
            }

            <span class="keyword">var</span> str = Twig.filters.escape( <span class="string">''</span> + value ),
                whitespace;
            <span class="keyword">if</span> ( params &amp;&amp; params[<span class="number">0</span>] ) {
                whitespace = <span class="string">''</span> + params[<span class="number">0</span>];
            } <span class="keyword">else</span> {
                whitespace = <span class="string">' \n\r\t\f\x0b\xa0\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u200b\u2028\u2029\u3000'</span>;
            }
            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; str.length; i++) {
                <span class="keyword">if</span> (whitespace.indexOf(str.charAt(i)) === -<span class="number">1</span>) {
                    str = str.substring(i);
                    <span class="keyword">break</span>;
                }
            }
            <span class="keyword">for</span> (i = str.length - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) {
                <span class="keyword">if</span> (whitespace.indexOf(str.charAt(i)) === -<span class="number">1</span>) {
                    str = str.substring(<span class="number">0</span>, i + <span class="number">1</span>);
                    <span class="keyword">break</span>;
                }
            }
            <span class="keyword">return</span> whitespace.indexOf(str.charAt(<span class="number">0</span>)) === -<span class="number">1</span> ? str : <span class="string">''</span>;
        },

        slice: <span class="function"><span class="keyword">function</span><span class="params">(value, params)</span> {</span>
            <span class="keyword">if</span> (value === <span class="literal">undefined</span> || value === <span class="literal">null</span>) {
                <span class="keyword">return</span>;
            }
            <span class="keyword">if</span> (params === <span class="literal">undefined</span> || params.length &lt; <span class="number">1</span>) {
                <span class="keyword">throw</span> <span class="keyword">new</span> Twig.Error(<span class="string">"slice filter expects at least 1 argument"</span>);
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-244">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-244">&#182;</a>
              </div>
              <p>default to start of string</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">var</span> start = params[<span class="number">0</span>] || <span class="number">0</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-245">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-245">&#182;</a>
              </div>
              <p>default to length of string</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">var</span> length = params.length &gt; <span class="number">1</span> ? params[<span class="number">1</span>] : value.length;</pre></div></div>
            
        </li>
        
        
        <li id="section-246">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-246">&#182;</a>
              </div>
              <p>handle negative start values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">var</span> startIndex = start &gt;= <span class="number">0</span> ? start : Math.max( value.length + start, <span class="number">0</span> );

            <span class="keyword">if</span> (Twig.lib.is(<span class="string">"Array"</span>, value)) {
                <span class="keyword">var</span> output = [];
                <span class="keyword">for</span> (<span class="keyword">var</span> i = startIndex; i &lt; startIndex + length &amp;&amp; i &lt; value.length; i++) {
                    output.push(value[i]);
                }
                <span class="keyword">return</span> output;
            } <span class="keyword">else</span> <span class="keyword">if</span> (Twig.lib.is(<span class="string">"String"</span>, value)) {
                <span class="keyword">return</span> value.substr(startIndex, length);
            } <span class="keyword">else</span> {
                <span class="keyword">throw</span> <span class="keyword">new</span> Twig.Error(<span class="string">"slice filter expects value to be an array or string"</span>);
            }
        },

        abs: <span class="function"><span class="keyword">function</span><span class="params">(value)</span> {</span>
            <span class="keyword">if</span> (value === <span class="literal">undefined</span> || value === <span class="literal">null</span>) {
                <span class="keyword">return</span>;
            }

            <span class="keyword">return</span> Math.abs(value);
        },

        first: <span class="function"><span class="keyword">function</span><span class="params">(value)</span> {</span>
            <span class="keyword">if</span> (value <span class="keyword">instanceof</span> Array) {
                <span class="keyword">return</span> value[<span class="number">0</span>];
            } <span class="keyword">else</span> <span class="keyword">if</span> (value <span class="keyword">instanceof</span> Object) {
                <span class="keyword">if</span> (<span class="string">'_keys'</span> <span class="keyword">in</span> value) {
                    <span class="keyword">return</span> value[value._keys[<span class="number">0</span>]];
                }
            } <span class="keyword">else</span> <span class="keyword">if</span> ( <span class="keyword">typeof</span> value === <span class="string">"string"</span> ) {
                <span class="keyword">return</span> value.substr(<span class="number">0</span>, <span class="number">1</span>);
            }

            <span class="keyword">return</span>;
        },

        split: <span class="function"><span class="keyword">function</span><span class="params">(value, params)</span> {</span>
            <span class="keyword">if</span> (value === <span class="literal">undefined</span> || value === <span class="literal">null</span>) {
                <span class="keyword">return</span>;
            }
            <span class="keyword">if</span> (params === <span class="literal">undefined</span> || params.length &lt; <span class="number">1</span> || params.length &gt; <span class="number">2</span>) {
                <span class="keyword">throw</span> <span class="keyword">new</span> Twig.Error(<span class="string">"split filter expects 1 or 2 argument"</span>);
            }
            <span class="keyword">if</span> (Twig.lib.is(<span class="string">"String"</span>, value)) {
                <span class="keyword">var</span> delimiter = params[<span class="number">0</span>],
                    limit = params[<span class="number">1</span>],
                    split = value.split(delimiter);

                <span class="keyword">if</span> (limit === <span class="literal">undefined</span>) {

                    <span class="keyword">return</span> split;

                } <span class="keyword">else</span> <span class="keyword">if</span> (limit &lt; <span class="number">0</span>) {

                    <span class="keyword">return</span> value.split(delimiter, split.length + limit);

                } <span class="keyword">else</span> {

                    <span class="keyword">var</span> limitedSplit = [];

                    <span class="keyword">if</span> (delimiter == <span class="string">''</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-247">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-247">&#182;</a>
              </div>
              <p>empty delimiter
&quot;aabbcc&quot;|split(&#39;&#39;, 2)
    -&gt; [&#39;aa&#39;, &#39;bb&#39;, &#39;cc&#39;]</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        <span class="keyword">while</span>(split.length &gt; <span class="number">0</span>) {
                            <span class="keyword">var</span> temp = <span class="string">""</span>;
                            <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>; i&lt;limit &amp;&amp; split.length &gt; <span class="number">0</span>; i++) {
                                temp += split.shift();
                            }
                            limitedSplit.push(temp);
                        }

                    } <span class="keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-248">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-248">&#182;</a>
              </div>
              <p>non-empty delimiter
&quot;one,two,three,four,five&quot;|split(&#39;,&#39;, 3)
    -&gt; [&#39;one&#39;, &#39;two&#39;, &#39;three,four,five&#39;]</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>; i&lt;limit-<span class="number">1</span> &amp;&amp; split.length &gt; <span class="number">0</span>; i++) {
                            limitedSplit.push(split.shift());
                        }

                        <span class="keyword">if</span> (split.length &gt; <span class="number">0</span>) {
                            limitedSplit.push(split.join(delimiter));
                        }
                    }

                    <span class="keyword">return</span> limitedSplit;
                }

            } <span class="keyword">else</span> {
                <span class="keyword">throw</span> <span class="keyword">new</span> Twig.Error(<span class="string">"split filter expects value to be a string"</span>);
            }
        },
        last: <span class="function"><span class="keyword">function</span><span class="params">(value)</span> {</span>
            <span class="keyword">if</span> (Twig.lib.is(<span class="string">'Object'</span>, value)) {
                <span class="keyword">var</span> keys;

                <span class="keyword">if</span> (value._keys === <span class="literal">undefined</span>) {
                    keys = Object.keys(value);
                } <span class="keyword">else</span> {
                    keys = value._keys;
                }

                <span class="keyword">return</span> value[keys[keys.length - <span class="number">1</span>]];
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-249">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-249">&#182;</a>
              </div>
              <p>string|array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">return</span> value[value.length - <span class="number">1</span>];
        }
    };

    Twig.filter = <span class="function"><span class="keyword">function</span><span class="params">(filter, value, params)</span> {</span>
        <span class="keyword">if</span> (!Twig.filters[filter]) {
            <span class="keyword">throw</span> <span class="string">"Unable to find filter "</span> + filter;
        }
        <span class="keyword">return</span> Twig.filters[filter].apply(<span class="keyword">this</span>, [value, params]);
    };

    Twig.filter.extend = <span class="function"><span class="keyword">function</span><span class="params">(filter, definition)</span> {</span>
        Twig.filters[filter] = definition;
    };

    <span class="keyword">return</span> Twig;

})(Twig || { });</pre></div></div>
            
        </li>
        
        
        <li id="section-250">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-250">&#182;</a>
              </div>
              <pre><code>Twig.js
Copyright (c) 2011-2013 John Roepke
              2012 Hadrien Lanneau
Available under the BSD 2-Clause License
https://github.com/justjohn/twig.js</code></pre>
<h2 id="twig-functions-js">twig.functions.js</h2>
<p>This file handles parsing filters.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> Twig = (<span class="function"><span class="keyword">function</span> <span class="params">(Twig)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-251">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-251">&#182;</a>
              </div>
              <p>Determine object type</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="function"><span class="keyword">function</span> <span class="title">is</span><span class="params">(type, obj)</span> {</span>
        <span class="keyword">var</span> clas = Object.prototype.toString.call(obj).slice(<span class="number">8</span>, -<span class="number">1</span>);
        <span class="keyword">return</span> obj !== <span class="literal">undefined</span> &amp;&amp; obj !== <span class="literal">null</span> &amp;&amp; clas === type;
    }

    Twig.functions = {</pre></div></div>
            
        </li>
        
        
        <li id="section-252">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-252">&#182;</a>
              </div>
              <p> attribute, block, constant, date, dump, parent, random,.</p>
<p>Range function from <a href="http://phpjs.org/functions/range:499">http://phpjs.org/functions/range:499</a>
Used under an MIT License</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        range: <span class="function"><span class="keyword">function</span> <span class="params">(low, high, step)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-253">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-253">&#182;</a>
              </div>
              <p><a href="http://kevin.vanzonneveld.net">http://kevin.vanzonneveld.net</a></p>
<ul>
<li>original by: Waldo Malqui Silva</li>
<li>example 1: range ( 0, 12 );</li>
<li>returns 1: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]</li>
<li>example 2: range( 0, 100, 10 );</li>
<li>returns 2: [0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100]</li>
<li>example 3: range( &#39;a&#39;, &#39;i&#39; );</li>
<li>returns 3: [&#39;a&#39;, &#39;b&#39;, &#39;c&#39;, &#39;d&#39;, &#39;e&#39;, &#39;f&#39;, &#39;g&#39;, &#39;h&#39;, &#39;i&#39;]</li>
<li>example 4: range( &#39;c&#39;, &#39;a&#39; );</li>
<li>returns 4: [&#39;c&#39;, &#39;b&#39;, &#39;a&#39;]</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">var</span> matrix = [];
            <span class="keyword">var</span> inival, endval, plus;
            <span class="keyword">var</span> walker = step || <span class="number">1</span>;
            <span class="keyword">var</span> chars = <span class="literal">false</span>;

            <span class="keyword">if</span> (!isNaN(low) &amp;&amp; !isNaN(high)) {
                inival = parseInt(low, <span class="number">10</span>);
                endval = parseInt(high, <span class="number">10</span>);
            } <span class="keyword">else</span> <span class="keyword">if</span> (isNaN(low) &amp;&amp; isNaN(high)) {
                chars = <span class="literal">true</span>;
                inival = low.charCodeAt(<span class="number">0</span>);
                endval = high.charCodeAt(<span class="number">0</span>);
            } <span class="keyword">else</span> {
                inival = (isNaN(low) ? <span class="number">0</span> : low);
                endval = (isNaN(high) ? <span class="number">0</span> : high);
            }

            plus = ((inival &gt; endval) ? <span class="literal">false</span> : <span class="literal">true</span>);
            <span class="keyword">if</span> (plus) {
                <span class="keyword">while</span> (inival &lt;= endval) {
                    matrix.push(((chars) ? String.fromCharCode(inival) : inival));
                    inival += walker;
                }
            } <span class="keyword">else</span> {
                <span class="keyword">while</span> (inival &gt;= endval) {
                    matrix.push(((chars) ? String.fromCharCode(inival) : inival));
                    inival -= walker;
                }
            }

            <span class="keyword">return</span> matrix;
        },
        cycle: <span class="function"><span class="keyword">function</span><span class="params">(arr, i)</span> {</span>
            <span class="keyword">var</span> pos = i % arr.length;
            <span class="keyword">return</span> arr[pos];
        },
        dump: <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
            <span class="keyword">var</span> EOL = <span class="string">'\n'</span>,
            	indentChar = <span class="string">'  '</span>,
            	indentTimes = <span class="number">0</span>,
            	out = <span class="string">''</span>,
				args = Array.prototype.slice.call(arguments),
				indent = <span class="function"><span class="keyword">function</span><span class="params">(times)</span> {</span>
                	<span class="keyword">var</span> ind	 = <span class="string">''</span>;
                    <span class="keyword">while</span> (times &gt; <span class="number">0</span>) {
                        times--;
                        ind += indentChar;
                    }
                    <span class="keyword">return</span> ind;
                },
				displayVar = <span class="function"><span class="keyword">function</span><span class="params">(variable)</span> {</span>
                    out += indent(indentTimes);
                    <span class="keyword">if</span> (<span class="keyword">typeof</span>(variable) === <span class="string">'object'</span>) {
                        dumpVar(variable);
                    } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span>(variable) === <span class="string">'function'</span>) {
                        out += <span class="string">'function()'</span> + EOL;
                    } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span>(variable) === <span class="string">'string'</span>) {
                        out += <span class="string">'string('</span> + variable.length + <span class="string">') "'</span> + variable + <span class="string">'"'</span> + EOL;
                    } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span>(variable) === <span class="string">'number'</span>) {
                        out += <span class="string">'number('</span> + variable + <span class="string">')'</span> + EOL;
                    } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span>(variable) === <span class="string">'boolean'</span>) {
                        out += <span class="string">'bool('</span> + variable + <span class="string">')'</span> + EOL;
                    }
                },
             	dumpVar = <span class="function"><span class="keyword">function</span><span class="params">(variable)</span> {</span>
					<span class="keyword">var</span>	i;
	                <span class="keyword">if</span> (variable === <span class="literal">null</span>) {
	                    out += <span class="string">'NULL'</span> + EOL;
	                } <span class="keyword">else</span> <span class="keyword">if</span> (variable === <span class="literal">undefined</span>) {
	                    out += <span class="string">'undefined'</span> + EOL;
	                } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> variable === <span class="string">'object'</span>) {
	                    out += indent(indentTimes) + <span class="keyword">typeof</span>(variable);
	                    indentTimes++;
	                    out += <span class="string">'('</span> + (<span class="function"><span class="keyword">function</span><span class="params">(obj)</span> {</span>
	                        <span class="keyword">var</span> size = <span class="number">0</span>, key;
	                        <span class="keyword">for</span> (key <span class="keyword">in</span> obj) {
	                            <span class="keyword">if</span> (obj.hasOwnProperty(key)) {
	                                size++;
	                            }
	                        }
	                        <span class="keyword">return</span> size;
	                    })(variable) + <span class="string">') {'</span> + EOL;
	                    <span class="keyword">for</span> (i <span class="keyword">in</span> variable) {
	                        out += indent(indentTimes) + <span class="string">'['</span> + i + <span class="string">']=&gt; '</span> + EOL;
	                        displayVar(variable[i]);
	                    }
	                    indentTimes--;
	                    out += indent(indentTimes) + <span class="string">'}'</span> + EOL;
	                } <span class="keyword">else</span> {
	                    displayVar(variable);
	                }
	            };</pre></div></div>
            
        </li>
        
        
        <li id="section-254">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-254">&#182;</a>
              </div>
              <p>handle no argument case by dumping the entire render context</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="keyword">if</span> (args.length == <span class="number">0</span>) args.push(<span class="keyword">this</span>.context);

			Twig.forEach(args, <span class="function"><span class="keyword">function</span><span class="params">(variable)</span> {</span>
				dumpVar(variable);
			});

            <span class="keyword">return</span> out;
        },
        date: <span class="function"><span class="keyword">function</span><span class="params">(date, time)</span> {</span>
            <span class="keyword">var</span> dateObj;
            <span class="keyword">if</span> (date === <span class="literal">undefined</span>) {
                dateObj = <span class="keyword">new</span> Date();
            } <span class="keyword">else</span> <span class="keyword">if</span> (Twig.lib.is(<span class="string">"Date"</span>, date)) {
                dateObj = date;
            } <span class="keyword">else</span> <span class="keyword">if</span> (Twig.lib.is(<span class="string">"String"</span>, date)) {
                dateObj = <span class="keyword">new</span> Date(Twig.lib.strtotime(date) * <span class="number">1000</span>);
            } <span class="keyword">else</span> <span class="keyword">if</span> (Twig.lib.is(<span class="string">"Number"</span>, date)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-255">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-255">&#182;</a>
              </div>
              <p>timestamp</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                dateObj = <span class="keyword">new</span> Date(date * <span class="number">1000</span>);
            } <span class="keyword">else</span> {
                <span class="keyword">throw</span> <span class="keyword">new</span> Twig.Error(<span class="string">"Unable to parse date "</span> + date);
            }
            <span class="keyword">return</span> dateObj;
        },
        block: <span class="function"><span class="keyword">function</span><span class="params">(block)</span> {</span>
            <span class="keyword">return</span> <span class="keyword">this</span>.blocks[block];
        },
        parent: <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-256">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-256">&#182;</a>
              </div>
              <p>Add a placeholder</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">return</span> Twig.placeholders.parent;
        },
        attribute: <span class="function"><span class="keyword">function</span><span class="params">(object, method, params)</span> {</span>
            <span class="keyword">if</span> (object <span class="keyword">instanceof</span> Object) {
                <span class="keyword">if</span> (object.hasOwnProperty(method)) {
                    <span class="keyword">if</span> (<span class="keyword">typeof</span> object[method] === <span class="string">"function"</span>) {
                        <span class="keyword">return</span> object[method].apply(<span class="literal">undefined</span>, params);
                    }
                    <span class="keyword">else</span> {
                        <span class="keyword">return</span> object[method];
                    }
                }
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-257">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-257">&#182;</a>
              </div>
              <p>Array will return element 0-index</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">return</span> object[method] || <span class="literal">undefined</span>;
        }
    };

    Twig._function = <span class="function"><span class="keyword">function</span><span class="params">(_function, value, params)</span> {</span>
        <span class="keyword">if</span> (!Twig.functions[_function]) {
            <span class="keyword">throw</span> <span class="string">"Unable to find function "</span> + _function;
        }
        <span class="keyword">return</span> Twig.functions[_function](value, params);
    };

    Twig._function.extend = <span class="function"><span class="keyword">function</span><span class="params">(_function, definition)</span> {</span>
        Twig.functions[_function] = definition;
    };

    <span class="keyword">return</span> Twig;

})(Twig || { });</pre></div></div>
            
        </li>
        
        
        <li id="section-258">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-258">&#182;</a>
              </div>
              <pre><code>Twig.js
Copyright (c) 2011-2013 John Roepke
Available under the BSD 2-Clause License
https://github.com/justjohn/twig.js</code></pre>
<h2 id="twig-tests-js">twig.tests.js</h2>
<p>This file handles expression tests. (is empty, is not defined, etc...)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> Twig = (<span class="function"><span class="keyword">function</span> <span class="params">(Twig)</span> {</span>
    <span class="string">"use strict"</span>;
    Twig.tests = {
        empty: <span class="function"><span class="keyword">function</span><span class="params">(value)</span> {</span>
            <span class="keyword">if</span> (value === <span class="literal">null</span> || value === <span class="literal">undefined</span>) <span class="keyword">return</span> <span class="literal">true</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-259">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-259">&#182;</a>
              </div>
              <p>Handler numbers</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (<span class="keyword">typeof</span> value === <span class="string">"number"</span>) <span class="keyword">return</span> <span class="literal">false</span>; <span class="comment">// numbers are never "empty"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-260">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-260">&#182;</a>
              </div>
              <p>Handle strings and arrays</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">if</span> (value.length &amp;&amp; value.length &gt; <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">false</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-261">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-261">&#182;</a>
              </div>
              <p>Handle objects</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> value) {
                <span class="keyword">if</span> (value.hasOwnProperty(key)) <span class="keyword">return</span> <span class="literal">false</span>;
            }
            <span class="keyword">return</span> <span class="literal">true</span>;
        },
        odd: <span class="function"><span class="keyword">function</span><span class="params">(value)</span> {</span>
            <span class="keyword">return</span> value % <span class="number">2</span> === <span class="number">1</span>;
        },
        even: <span class="function"><span class="keyword">function</span><span class="params">(value)</span> {</span>
            <span class="keyword">return</span> value % <span class="number">2</span> === <span class="number">0</span>;
        },
        divisibleby: <span class="function"><span class="keyword">function</span><span class="params">(value, params)</span> {</span>
            <span class="keyword">return</span> value % params[<span class="number">0</span>] === <span class="number">0</span>;
        },
        defined: <span class="function"><span class="keyword">function</span><span class="params">(value)</span> {</span>
            <span class="keyword">return</span> value !== <span class="literal">undefined</span>;
        },
        none: <span class="function"><span class="keyword">function</span><span class="params">(value)</span> {</span>
            <span class="keyword">return</span> value === <span class="literal">null</span>;
        },
        <span class="string">'null'</span>: <span class="function"><span class="keyword">function</span><span class="params">(value)</span> {</span>
            <span class="keyword">return</span> <span class="keyword">this</span>.none(value); <span class="comment">// Alias of none</span>
        },
        sameas: <span class="function"><span class="keyword">function</span><span class="params">(value, params)</span> {</span>
            <span class="keyword">return</span> value === params[<span class="number">0</span>];
        }
        <span class="comment">/*
        constant ?
         */</span>
    };

    Twig.test = <span class="function"><span class="keyword">function</span><span class="params">(test, value, params)</span> {</span>
        <span class="keyword">if</span> (!Twig.tests[test]) {
            <span class="keyword">throw</span> <span class="string">"Test "</span> + test + <span class="string">" is not defined."</span>;
        }
        <span class="keyword">return</span> Twig.tests[test](value, params);
    };

    Twig.test.extend = <span class="function"><span class="keyword">function</span><span class="params">(test, definition)</span> {</span>
        Twig.tests[test] = definition;
    };

    <span class="keyword">return</span> Twig;
})( Twig || { } );</pre></div></div>
            
        </li>
        
        
        <li id="section-262">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-262">&#182;</a>
              </div>
              <pre><code>Twig.js
Copyright (c) 2011-2013 John Roepke
Available under the BSD 2-Clause License
https://github.com/justjohn/twig.js</code></pre>
<h2 id="twig-exports-js">twig.exports.js</h2>
<p>This file provides extension points and other hooks into the twig functionality.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> Twig = (<span class="function"><span class="keyword">function</span> <span class="params">(Twig)</span> {</span>
    <span class="string">"use strict"</span>;
    Twig.exports = {
        VERSION: Twig.VERSION
    };

    <span class="comment">/**
     * Create and compile a twig.js template.
     *
     * @param {Object} param Paramteres for creating a Twig template.
     *
     * @return {Twig.Template} A Twig template ready for rendering.
     */</span>
    Twig.exports.twig = <span class="function"><span class="keyword">function</span> <span class="title">twig</span><span class="params">(params)</span> {</span>
        <span class="string">'use strict'</span>;
        <span class="keyword">var</span> id = params.id,
            options = {
                strict_variables: params.strict_variables || <span class="literal">false</span>,
                allowInlineIncludes: params.allowInlineIncludes || <span class="literal">false</span>,
                rethrow: params.rethrow || <span class="literal">false</span>
            };

        <span class="keyword">if</span> (id) {
            Twig.validateId(id);
        }

        <span class="keyword">if</span> (params.debug !== <span class="literal">undefined</span>) {
            Twig.debug = params.debug;
        }
        <span class="keyword">if</span> (params.trace !== <span class="literal">undefined</span>) {
            Twig.trace = params.trace;
        }

        <span class="keyword">if</span> (params.data !== <span class="literal">undefined</span>) {
            <span class="keyword">return</span> <span class="keyword">new</span> Twig.Template({
                data: params.data,
                module: params.module,
                id:   id,
                options: options
            });

        } <span class="keyword">else</span> <span class="keyword">if</span> (params.ref !== <span class="literal">undefined</span>) {
            <span class="keyword">if</span> (params.id !== <span class="literal">undefined</span>) {
                <span class="keyword">throw</span> <span class="keyword">new</span> Twig.Error(<span class="string">"Both ref and id cannot be set on a twig.js template."</span>);
            }
            <span class="keyword">return</span> Twig.Templates.load(params.ref);

        } <span class="keyword">else</span> <span class="keyword">if</span> (params.href !== <span class="literal">undefined</span>) {
            <span class="keyword">return</span> Twig.Templates.loadRemote(params.href, {
                id: id,
                method: <span class="string">'ajax'</span>,
                base: params.base,
                module: params.module,
                precompiled: params.precompiled,
                async: params.async,
                options: options

            }, params.load, params.error);

        } <span class="keyword">else</span> <span class="keyword">if</span> (params.path !== <span class="literal">undefined</span>) {
            <span class="keyword">return</span> Twig.Templates.loadRemote(params.path, {
                id: id,
                method: <span class="string">'fs'</span>,
                base: params.base,
                module: params.module,
                precompiled: params.precompiled,
                async: params.async,
                options: options

            }, params.load, params.error);
        }
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-263">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-263">&#182;</a>
              </div>
              <p>Extend Twig with a new filter.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    Twig.exports.extendFilter = <span class="function"><span class="keyword">function</span><span class="params">(filter, definition)</span> {</span>
        Twig.filter.extend(filter, definition);
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-264">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-264">&#182;</a>
              </div>
              <p>Extend Twig with a new function.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    Twig.exports.extendFunction = <span class="function"><span class="keyword">function</span><span class="params">(fn, definition)</span> {</span>
        Twig._function.extend(fn, definition);
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-265">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-265">&#182;</a>
              </div>
              <p>Extend Twig with a new test.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    Twig.exports.extendTest = <span class="function"><span class="keyword">function</span><span class="params">(test, definition)</span> {</span>
        Twig.test.extend(test, definition);
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-266">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-266">&#182;</a>
              </div>
              <p>Extend Twig with a new definition.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    Twig.exports.extendTag = <span class="function"><span class="keyword">function</span><span class="params">(definition)</span> {</span>
        Twig.logic.extend(definition);
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-267">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-267">&#182;</a>
              </div>
              <p>Provide an environment for extending Twig core.
Calls fn with the internal Twig object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    Twig.exports.extend = <span class="function"><span class="keyword">function</span><span class="params">(fn)</span> {</span>
        fn(Twig);
    };


    <span class="comment">/**
     * Provide an extension for use with express 2.
     *
     * @param {string} markup The template markup.
     * @param {array} options The express options.
     *
     * @return {string} The rendered template.
     */</span>
    Twig.exports.compile = <span class="function"><span class="keyword">function</span><span class="params">(markup, options)</span> {</span>
        <span class="keyword">var</span> id = options.filename,
            path = options.filename,
            template;</pre></div></div>
            
        </li>
        
        
        <li id="section-268">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-268">&#182;</a>
              </div>
              <p>Try to load the template from the cache</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        template = <span class="keyword">new</span> Twig.Template({
            data: markup,
            path: path,
            id: id,
            options: options.settings[<span class="string">'twig options'</span>]
        }); <span class="comment">// Twig.Templates.load(id) ||</span>

        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span><span class="params">(context)</span> {</span>
            <span class="keyword">return</span> template.render(context);
        };
    };

    <span class="comment">/**
     * Provide an extension for use with express 3.
     *
     * @param {string} path The location of the template file on disk.
     * @param {Object|Function} The options or callback.
     * @param {Function} fn callback.
     */</span>

    Twig.exports.renderFile = <span class="function"><span class="keyword">function</span><span class="params">(path, options, fn)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-269">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-269">&#182;</a>
              </div>
              <p>handle callback in options</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (<span class="string">'function'</span> == <span class="keyword">typeof</span> options) {
            fn = options;
            options = {};
        }

        options = options || {};

        <span class="keyword">var</span> params = {
                path: path,
                base: options.settings[<span class="string">'views'</span>],
                load: <span class="function"><span class="keyword">function</span><span class="params">(template)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-270">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-270">&#182;</a>
              </div>
              <p>render and return template</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    fn(<span class="literal">null</span>, template.render(options));
                }
            };</pre></div></div>
            
        </li>
        
        
        <li id="section-271">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-271">&#182;</a>
              </div>
              <p>mixin any options provided to the express app.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> view_options = options.settings[<span class="string">'twig options'</span>];

        <span class="keyword">if</span> (view_options) {
            <span class="keyword">for</span> (<span class="keyword">var</span> option <span class="keyword">in</span> view_options) <span class="keyword">if</span> (view_options.hasOwnProperty(option)) {
                params[option] = view_options[option];
            }
        }

        Twig.exports.twig(params);
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-272">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-272">&#182;</a>
              </div>
              <p>Express 3 handler</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    Twig.exports.__express = Twig.exports.renderFile;

    <span class="comment">/**
     * Shoud Twig.js cache templates.
     * Disable during development to see changes to templates without
     * reloading, and disable in production to improve performance.
     *
     * @param {boolean} cache
     */</span>
    Twig.exports.cache = <span class="function"><span class="keyword">function</span><span class="params">(cache)</span> {</span>
        Twig.cache = cache;
    }

    <span class="keyword">return</span> Twig;
}) (Twig || { });</pre></div></div>
            
        </li>
        
        
        <li id="section-273">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-273">&#182;</a>
              </div>
              <pre><code>Twig.js
Copyright (c) 2011-2013 John Roepke
Available under the BSD 2-Clause License
https://github.com/justjohn/twig.js</code></pre>
<h2 id="twig-compiler-js">twig.compiler.js</h2>
<p>This file handles compiling templates into JS</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> Twig = (<span class="function"><span class="keyword">function</span> <span class="params">(Twig)</span> {</span>
    <span class="comment">/**
     * Namespace for compilation.
     */</span>
    Twig.compiler = {
        module: {}
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-274">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-274">&#182;</a>
              </div>
              <p>Compile a Twig Template to output.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    Twig.compiler.compile = <span class="function"><span class="keyword">function</span><span class="params">(template, options)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-275">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-275">&#182;</a>
              </div>
              <p>Get tokens</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> tokens = JSON.stringify(template.tokens)
            , id = template.id
            , output;

        <span class="keyword">if</span> (options.module) {
            <span class="keyword">if</span> (Twig.compiler.module[options.module] === <span class="literal">undefined</span>) {
                <span class="keyword">throw</span> <span class="keyword">new</span> Twig.Error(<span class="string">"Unable to find module type "</span> + options.module);
            }
            output = Twig.compiler.module[options.module](id, tokens, options.twig);
        } <span class="keyword">else</span> {
            output = Twig.compiler.wrap(id, tokens);
        }
        <span class="keyword">return</span> output;
    };

    Twig.compiler.module = {
        amd: <span class="function"><span class="keyword">function</span><span class="params">(id, tokens, pathToTwig)</span> {</span>
            <span class="keyword">return</span> <span class="string">'define(["'</span> + pathToTwig + <span class="string">'"], function (Twig) {\n\tvar twig, templates;\ntwig = Twig.twig;\ntemplates = '</span> + Twig.compiler.wrap(id, tokens) + <span class="string">'\n\treturn templates;\n});'</span>;
        }
        , node: <span class="function"><span class="keyword">function</span><span class="params">(id, tokens)</span> {</span>
            <span class="keyword">return</span> <span class="string">'var twig = require("twig").twig;\n'</span>
                + <span class="string">'exports.template = '</span> + Twig.compiler.wrap(id, tokens)
        }
        , cjs2: <span class="function"><span class="keyword">function</span><span class="params">(id, tokens, pathToTwig)</span> {</span>
            <span class="keyword">return</span> <span class="string">'module.declare([{ twig: "'</span> + pathToTwig + <span class="string">'" }], function (require, exports, module) {\n'</span>
                        + <span class="string">'\tvar twig = require("twig").twig;\n'</span>
                        + <span class="string">'\texports.template = '</span> + Twig.compiler.wrap(id, tokens)
                    + <span class="string">'\n});'</span>
        }
    };

    Twig.compiler.wrap = <span class="function"><span class="keyword">function</span><span class="params">(id, tokens)</span> {</span>
        <span class="keyword">return</span> <span class="string">'twig({id:"'</span>+id.replace(<span class="string">'"'</span>, <span class="string">'\\"'</span>)+<span class="string">'", data:'</span>+tokens+<span class="string">', precompiled: true});\n'</span>;
    };

    <span class="keyword">return</span> Twig;
})(Twig || {});</pre></div></div>
            
        </li>
        
        
        <li id="section-276">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-276">&#182;</a>
              </div>
              <pre><code>Twig.js
Copyright (c) 2011-2013 John Roepke
Available under the BSD 2-Clause License
https://github.com/justjohn/twig.js</code></pre>
<h2 id="twig-module-js">twig.module.js</h2>
<p>Provide a CommonJS/AMD/Node module export.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">if</span> (<span class="keyword">typeof</span> module !== <span class="string">'undefined'</span> &amp;&amp; module.declare) {</pre></div></div>
            
        </li>
        
        
        <li id="section-277">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-277">&#182;</a>
              </div>
              <p>Provide a CommonJS Modules/2.0 draft 8 module</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    module.declare([], <span class="function"><span class="keyword">function</span><span class="params">(require, exports, module)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-278">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-278">&#182;</a>
              </div>
              <p>Add exports from the Twig exports</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">for</span> (key <span class="keyword">in</span> Twig.exports) {
            <span class="keyword">if</span> (Twig.exports.hasOwnProperty(key)) {
                exports[key] = Twig.exports[key];
            }
        }
    });
} <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> define == <span class="string">'function'</span> &amp;&amp; define.amd) {
    define(<span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">return</span> Twig.exports;
    });
} <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> module !== <span class="string">'undefined'</span> &amp;&amp; module.exports) {</pre></div></div>
            
        </li>
        
        
        <li id="section-279">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-279">&#182;</a>
              </div>
              <p>Provide a CommonJS Modules/1.1 module</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    module.exports = Twig.exports;
} <span class="keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-280">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-280">&#182;</a>
              </div>
              <p>Export for browser use</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    window.twig = Twig.exports.twig;
    window.Twig = Twig.exports;
}</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
